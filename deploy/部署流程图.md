# PS-BE 生产环境部署流程图

## 📊 整体部署流程

```mermaid
graph TB
    Start([开始部署]) --> GenKeys[1. 生成配置密钥<br/>generate-keys.sh]
    GenKeys --> EditConfig[2. 修改配置文件<br/>application-prod.yml]
    EditConfig --> ValidateConfig[3. 验证配置<br/>validate-config.sh]
    ValidateConfig --> CheckResult{配置验证<br/>是否通过?}
    
    CheckResult -->|否| FixConfig[修复配置错误]
    FixConfig --> EditConfig
    
    CheckResult -->|是| CheckList[4. 检查部署清单<br/>生产配置检查清单.md]
    CheckList --> AllChecked{所有检查项<br/>是否通过?}
    
    AllChecked -->|否| FixIssues[修复问题]
    FixIssues --> CheckList
    
    AllChecked -->|是| CreateDir[5. 创建部署目录<br/>/opt/ps/]
    CreateDir --> Upload[6. 上传文件<br/>JAR + 配置]
    Upload --> SetPerm[7. 设置文件权限<br/>chmod 600]
    SetPerm --> VerifyServices[8. 验证依赖服务<br/>DB/Redis/Keycloak]
    
    VerifyServices --> ServicesOK{依赖服务<br/>是否正常?}
    ServicesOK -->|否| FixServices[修复依赖服务]
    FixServices --> VerifyServices
    
    ServicesOK -->|是| StartApp[9. 启动应用<br/>java -jar]
    StartApp --> HealthCheck[10. 健康检查<br/>/actuator/health]
    
    HealthCheck --> AppHealthy{应用<br/>是否健康?}
    AppHealthy -->|否| CheckLogs[查看日志<br/>排查错误]
    CheckLogs --> FixApp[修复应用问题]
    FixApp --> StartApp
    
    AppHealthy -->|是| FuncTest[11. 功能测试<br/>SSO/文件/邮件]
    FuncTest --> TestPass{功能测试<br/>是否通过?}
    
    TestPass -->|否| FixFunc[修复功能问题]
    FixFunc --> StartApp
    
    TestPass -->|是| MonitorSetup[12. 配置监控<br/>日志/告警]
    MonitorSetup --> End([部署完成])
    
    style Start fill:#e1f5e1
    style End fill:#e1f5e1
    style CheckResult fill:#fff4e1
    style AllChecked fill:#fff4e1
    style ServicesOK fill:#fff4e1
    style AppHealthy fill:#fff4e1
    style TestPass fill:#fff4e1
    style FixConfig fill:#ffe1e1
    style FixIssues fill:#ffe1e1
    style FixServices fill:#ffe1e1
    style FixApp fill:#ffe1e1
    style FixFunc fill:#ffe1e1
```

## 🔄 配置修改流程

```mermaid
graph LR
    GenKeys[生成密钥] --> Copy[复制密钥]
    Copy --> Edit[编辑配置文件]
    Edit --> Replace[替换TODO项]
    Replace --> Validate[验证配置]
    Validate --> Pass{通过?}
    Pass -->|否| Edit
    Pass -->|是| Deploy[部署]
    
    style GenKeys fill:#e1f5e1
    style Deploy fill:#e1f5e1
    style Pass fill:#fff4e1
```

## 🔐 安全检查流程

```mermaid
graph TB
    Start([开始安全检查]) --> CheckPerm[检查文件权限<br/>chmod 600]
    CheckPerm --> CheckOwner[检查文件所有者<br/>root:root]
    CheckOwner --> CheckPwd[检查密码强度<br/>>= 8位]
    CheckPwd --> CheckAuth[检查认证配置<br/>排除路径]
    CheckAuth --> CheckDruid[检查Druid监控<br/>已禁用]
    CheckDruid --> CheckWall[检查SQL防火墙<br/>已启用]
    CheckWall --> CheckSSL[检查SSL配置<br/>HTTPS]
    CheckSSL --> CheckJWT[检查JWT验证<br/>完整性]
    CheckJWT --> AllPass{所有检查<br/>通过?}
    
    AllPass -->|否| Fix[修复安全问题]
    Fix --> Start
    AllPass -->|是| End([安全检查通过])
    
    style Start fill:#e1f5e1
    style End fill:#e1f5e1
    style AllPass fill:#fff4e1
    style Fix fill:#ffe1e1
```

## 📈 应用启动流程

```mermaid
graph TB
    Start([启动命令]) --> LoadConfig[加载配置文件<br/>application-prod.yml]
    LoadConfig --> InitSpring[初始化Spring容器]
    InitSpring --> ConnectDB[连接数据库<br/>初始化连接池]
    ConnectDB --> DBOk{数据库<br/>连接成功?}
    
    DBOk -->|否| DBError[数据库连接失败<br/>检查配置/网络]
    DBError --> Fail([启动失败])
    
    DBOk -->|是| ConnectRedis[连接Redis<br/>初始化连接池]
    ConnectRedis --> RedisOk{Redis<br/>连接成功?}
    
    RedisOk -->|否| RedisError[Redis连接失败<br/>检查配置/网络]
    RedisError --> Fail
    
    RedisOk -->|是| InitKeycloak[初始化Keycloak<br/>SSO配置]
    InitKeycloak --> KeycloakOk{Keycloak<br/>连接成功?}
    
    KeycloakOk -->|否| KeycloakError[Keycloak连接失败<br/>检查配置/网络]
    KeycloakError --> Fail
    
    KeycloakOk -->|是| StartTomcat[启动Tomcat<br/>监听8080端口]
    StartTomcat --> ServerReady[服务器就绪]
    ServerReady --> Success([启动成功])
    
    style Start fill:#e1f5e1
    style Success fill:#e1f5e1
    style Fail fill:#ffe1e1
    style DBOk fill:#fff4e1
    style RedisOk fill:#fff4e1
    style KeycloakOk fill:#fff4e1
```

## 🔍 故障排查流程

```mermaid
graph TB
    Start([发现问题]) --> CheckLogs[查看应用日志<br/>ps-bmp-backend.log]
    CheckLogs --> ErrorType{错误类型}
    
    ErrorType -->|配置错误| CheckConfig[检查配置文件<br/>validate-config.sh]
    CheckConfig --> FixConfig[修复配置]
    FixConfig --> Restart[重启应用]
    
    ErrorType -->|连接错误| CheckNetwork[检查网络连接<br/>telnet/ping]
    CheckNetwork --> CheckService[检查依赖服务<br/>DB/Redis/Keycloak]
    CheckService --> FixNetwork[修复网络/服务]
    FixNetwork --> Restart
    
    ErrorType -->|权限错误| CheckPerm[检查文件权限<br/>ls -l]
    CheckPerm --> FixPerm[修复权限<br/>chmod/chown]
    FixPerm --> Restart
    
    ErrorType -->|性能问题| CheckMetrics[检查性能指标<br/>Prometheus]
    CheckMetrics --> Optimize[优化配置<br/>连接池/JVM]
    Optimize --> Restart
    
    Restart --> Verify[验证修复]
    Verify --> Fixed{问题<br/>解决?}
    
    Fixed -->|否| Escalate[升级问题<br/>联系技术支持]
    Fixed -->|是| End([问题解决])
    
    style Start fill:#ffe1e1
    style End fill:#e1f5e1
    style ErrorType fill:#fff4e1
    style Fixed fill:#fff4e1
```

## 📝 配置更新流程

```mermaid
graph TB
    Start([需要更新配置]) --> Backup[备份当前配置<br/>application-prod.yml.bak]
    Backup --> Edit[修改配置文件]
    Edit --> Validate[验证配置<br/>validate-config.sh]
    Validate --> Valid{配置<br/>有效?}
    
    Valid -->|否| Restore[恢复备份配置]
    Restore --> Edit
    
    Valid -->|是| Stop[停止应用<br/>stop.sh]
    Stop --> Start[启动应用<br/>start.sh]
    Start --> Health[健康检查]
    Health --> Healthy{应用<br/>健康?}
    
    Healthy -->|否| RestoreApp[恢复备份配置<br/>重启应用]
    RestoreApp --> Investigate[调查问题]
    
    Healthy -->|是| Test[功能测试]
    Test --> TestOK{测试<br/>通过?}
    
    TestOK -->|否| RestoreApp
    TestOK -->|是| Commit[提交配置<br/>Git备份]
    Commit --> End([更新完成])
    
    style Start fill:#fff4e1
    style End fill:#e1f5e1
    style Valid fill:#fff4e1
    style Healthy fill:#fff4e1
    style TestOK fill:#fff4e1
    style Restore fill:#ffe1e1
    style RestoreApp fill:#ffe1e1
```

## 🎯 使用建议

1. **首次部署**：按照"整体部署流程"逐步执行
2. **配置修改**：参考"配置修改流程"和"配置更新流程"
3. **安全加固**：使用"安全检查流程"进行全面检查
4. **启动问题**：查看"应用启动流程"了解启动过程
5. **故障处理**：使用"故障排查流程"快速定位问题

## 📊 关键检查点

| 阶段 | 关键检查点 | 工具/命令 |
|------|-----------|----------|
| 配置准备 | 所有TODO已替换 | `grep TODO application-prod.yml` |
| 配置验证 | YAML语法正确 | `validate-config.sh` |
| 文件权限 | 配置文件600权限 | `ls -l application-prod.yml` |
| 依赖服务 | 数据库可连接 | `telnet 192.168.1.100 3306` |
| 依赖服务 | Redis可连接 | `redis-cli -h 192.168.1.101 ping` |
| 应用启动 | 进程正常运行 | `ps aux | grep ps-be.jar` |
| 应用启动 | 端口已监听 | `netstat -tlnp | grep 8080` |
| 健康检查 | Health端点返回UP | `curl /actuator/health` |
| 功能验证 | SSO登录正常 | 浏览器测试 |
| 监控配置 | Prometheus指标导出 | `curl /actuator/prometheus` |

---

**提示**: 本流程图可配合 [README-生产配置部署指南.md](./README-生产配置部署指南.md) 使用，获得最佳部署效果。
