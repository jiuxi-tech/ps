# PS-BE 生产环境配置检查清单

## 📋 使用说明

在部署生产环境之前，请逐项检查此清单，确保所有配置正确无误。

建议打印此清单，在部署过程中逐项勾选。

---

## ✅ 部署前检查

### 1. 配置文件修改

- [ ] 已将 `config/application-prod.yml` 中所有 `TODO` 标记的配置项修改为实际值
- [ ] 已修改数据库连接地址、用户名、密码
- [ ] 已修改 Redis 连接地址、密码
- [ ] 已修改 Keycloak 服务器地址、客户端密钥
- [ ] 已修改前端应用地址（SSO 重定向 URL）
- [ ] 已修改 JWT 密钥为随机生成的强密钥
- [ ] 已修改 AES 密钥为随机生成的强密钥
- [ ] 已修改文件服务器地址
- [ ] 已修改邮件服务器配置（SMTP、用户名、密码）
- [ ] 已修改监控服务器地址

### 2. 配置文件验证

- [ ] YAML 语法验证通过（使用 Python yaml 模块）
- [ ] 配置文件中不再包含 TODO 标记
- [ ] 配置文件中所有敏感信息已替换为实际值
- [ ] 配置文件编码为 UTF-8

### 3. 依赖服务检查

- [ ] 数据库服务可访问（telnet 测试通过）
- [ ] 数据库用户权限正确（可以连接并操作）
- [ ] Redis 服务可访问（redis-cli 测试通过）
- [ ] Keycloak 服务可访问（curl 测试通过）
- [ ] 文件服务器可访问（telnet 测试通过）
- [ ] 邮件服务器可访问（telnet 测试通过）
- [ ] 监控服务器可访问（curl 测试通过）

### 4. 服务器环境准备

- [ ] 已创建部署目录 `/opt/ps/`
- [ ] 已创建配置目录 `/opt/ps/config/`
- [ ] 已创建上传目录 `/opt/ps/upload/jdfs/`
- [ ] 已创建日志目录 `/opt/ps/logs/`
- [ ] 目录权限正确设置
- [ ] 磁盘空间充足（建议至少 50GB）

### 5. 文件上传

- [ ] JAR 包已上传到 `/opt/ps/ps-be.jar`
- [ ] 配置文件已上传到 `/opt/ps/config/application-prod.yml`
- [ ] JAR 包文件完整性验证通过（MD5/SHA256）

### 6. 文件权限设置

- [ ] JAR 包可执行权限已设置（chmod +x）
- [ ] 配置文件权限设置为 600（chmod 600）
- [ ] 配置文件所有者为 root（chown root:root）
- [ ] 权限验证通过（ls -l 检查）

---

## 🔐 安全检查

### 1. 密码强度

- [ ] 数据库密码符合强密码要求（8位以上，包含大小写、数字、特殊字符）
- [ ] Redis 密码符合强密码要求
- [ ] Keycloak 管理员密码符合强密码要求
- [ ] JWT 密钥为随机生成的强密钥（建议 32 位以上）
- [ ] AES 密钥为随机生成的强密钥（建议 32 位以上）
- [ ] 邮件密码为应用专用密码

### 2. 认证授权配置

- [ ] 认证排除路径仅包含必要路径（/static/**, /sys/captcha/**, 等）
- [ ] 未开放不安全的路径（如 /**)
- [ ] Druid 监控界面已禁用（stat-view-servlet.enabled: false）
- [ ] SQL 防火墙已启用（filter.wall.enabled: true）
- [ ] DELETE 操作已禁用（delete-allow: false）

### 3. 网络安全

- [ ] 数据库连接按需启用 SSL（敏感数据场景）
- [ ] Redis 连接按需启用 SSL（敏感数据场景）
- [ ] Keycloak 使用 HTTPS（server-url 为 https://）
- [ ] 前端应用使用 HTTPS（redirect URL 为 https://）
- [ ] 邮件服务启用加密传输（starttls 或 SSL）

### 4. JWT 安全配置

- [ ] JWT 过期验证已启用（verify-expiration: true）
- [ ] JWT 签发者验证已启用（verify-issuer: true）
- [ ] JWT 受众验证已启用（verify-audience: true）
- [ ] JWT 缓存时间合理（cache-ttl: 1800）
- [ ] JWT 密钥足够复杂且唯一

### 5. 文件权限控制

- [ ] 配置文件权限为 600（-rw-------）
- [ ] 配置文件所有者为 root
- [ ] 其他用户无法读取配置文件
- [ ] 配置文件未添加到版本控制系统

### 6. 访问控制

- [ ] 服务器仅允许授权人员访问
- [ ] SSH 使用密钥认证，密码登录已禁用
- [ ] 防火墙已配置，限制 SSH 访问 IP
- [ ] 应用端口仅对内网或 Nginx 开放

---

## ⚙️ 性能配置检查

### 1. JVM 参数

- [ ] 堆内存大小合理（-Xms2048m -Xmx4096m）
- [ ] 垃圾收集器已配置（-XX:+UseG1GC）
- [ ] GC 暂停时间目标已设置（-XX:MaxGCPauseMillis=100）
- [ ] OOM 时堆转储已启用（-XX:+HeapDumpOnOutOfMemoryError）

### 2. 数据库连接池

- [ ] 初始连接数合理（initial-size: 20）
- [ ] 最小空闲连接数合理（min-idle: 20）
- [ ] 最大活动连接数合理（max-active: 500）
- [ ] 最大等待时间已设置（max-wait: 60000）
- [ ] 连接验证已启用（test-while-idle: true）

### 3. Redis 连接池

- [ ] 最大活动连接数合理（max-active: 100）
- [ ] 最大等待时间已设置（max-wait: 10000）
- [ ] 连接超时时间合理（timeout: 10000）
- [ ] 连接池参数与实际负载匹配

### 4. 服务器配置

- [ ] 最大线程数合理（max-threads: 2000）
- [ ] 最大连接数合理（max-connections: 10000）
- [ ] 连接超时时间已设置（connection-timeout: 20000）
- [ ] HTTP 响应压缩已启用（compression.enabled: true）

---

## 📊 监控配置检查

### 1. 日志配置

- [ ] 日志级别设置为 WARN（root: WARN）
- [ ] 业务日志级别设置为 INFO（com.jiuxi: INFO）
- [ ] 日志文件路径正确（/opt/ps/logs/ps-bmp-backend.log）
- [ ] 日志滚动策略已配置（max-size, max-history）
- [ ] 日志总大小上限已设置（total-size-cap: 10GB）

### 2. Actuator 端点

- [ ] 仅暴露必要的端点（health, prometheus）
- [ ] 健康检查详情已隐藏（show-details: never）
- [ ] Prometheus 指标导出已启用（prometheus.enabled: true）

### 3. 监控服务配置

- [ ] 监控服务器地址已配置
- [ ] 监控客户端 ID 已配置
- [ ] 监控连接超时时间合理
- [ ] 监控邮件配置正确

---

## 🚀 部署执行检查

### 1. 启动前检查

- [ ] 所有依赖服务已启动并正常运行
- [ ] 数据库表结构已创建或迁移完成
- [ ] Redis 数据已清理或迁移完成
- [ ] Keycloak 客户端已配置完成
- [ ] 文件服务器存储目录已创建

### 2. 启动命令检查

- [ ] profile 参数正确（--spring.profiles.active=prod）
- [ ] 配置文件路径正确（--spring.config.additional-location=file:/opt/ps/config/）
- [ ] JVM 参数完整且正确
- [ ] 日志输出路径正确

### 3. 启动验证

- [ ] 应用启动成功（无异常日志）
- [ ] 进程 ID 已保存（ps-be.pid 文件存在）
- [ ] 端口已监听（netstat 检查 8080 端口）
- [ ] 健康检查端点返回 UP 状态
- [ ] 数据库连接池已初始化
- [ ] Redis 连接成功

### 4. 功能验证

- [ ] 验证码生成正常
- [ ] SSO 登录正常
- [ ] 用户信息获取正常
- [ ] 文件上传下载正常
- [ ] 邮件发送正常
- [ ] 缓存读写正常

---

## 📝 部署后检查

### 1. 日志检查

- [ ] 应用日志无 ERROR 级别错误
- [ ] 数据库连接日志正常
- [ ] Redis 连接日志正常
- [ ] SSO 认证日志正常
- [ ] 无异常堆栈信息

### 2. 性能检查

- [ ] 应用启动时间合理（2 分钟内）
- [ ] 内存使用率正常（<80%）
- [ ] CPU 使用率正常（<50%）
- [ ] 数据库连接数正常
- [ ] Redis 连接数正常

### 3. 安全检查

- [ ] 配置文件权限正确（600）
- [ ] Druid 监控界面无法访问
- [ ] SQL 防火墙正常工作
- [ ] 不安全的路径无法访问（除排除路径外）
- [ ] JWT 验证正常工作

### 4. 监控检查

- [ ] 健康检查端点正常响应
- [ ] Prometheus 指标正常导出
- [ ] 监控系统已接收数据
- [ ] 告警规则已配置
- [ ] 日志收集系统已接收日志

---

## 🔄 持续运维检查

### 1. 定期检查（每周）

- [ ] 检查应用日志，排查异常
- [ ] 检查性能指标，发现瓶颈
- [ ] 检查磁盘空间，确保充足
- [ ] 检查数据库连接数，防止泄漏
- [ ] 检查 Redis 内存使用，防止 OOM

### 2. 定期检查（每月）

- [ ] 检查日志归档，清理过期日志
- [ ] 检查数据库表空间，执行优化
- [ ] 检查依赖服务健康状态
- [ ] 检查备份文件完整性
- [ ] 检查安全漏洞，及时更新

### 3. 定期检查（每季度）

- [ ] 更换数据库密码
- [ ] 更换 Redis 密码
- [ ] 更换 Keycloak 客户端密钥
- [ ] 更换 JWT 密钥
- [ ] 更换 AES 密钥
- [ ] 更换邮件密码
- [ ] 审计配置文件访问日志

---

## 📞 应急联系方式

| 角色 | 姓名 | 电话 | 邮箱 |
|------|------|------|------|
| 技术负责人 | ___ | ___ | ___ |
| 运维负责人 | ___ | ___ | ___ |
| DBA | ___ | ___ | ___ |
| 网络管理员 | ___ | ___ | ___ |

---

## 📚 相关文档

- [生产配置部署指南](./README-生产配置部署指南.md)
- [配置文件分析设计文档](../.qoder/quests/config-file-analysis.md)
- [生产部署方案](./生产部署方案.md)

---

## ✍️ 签字确认

| 检查项 | 检查人 | 检查时间 | 签字 |
|--------|--------|----------|------|
| 配置文件修改 | ___ | ___ | ___ |
| 安全检查 | ___ | ___ | ___ |
| 性能配置检查 | ___ | ___ | ___ |
| 监控配置检查 | ___ | ___ | ___ |
| 部署执行 | ___ | ___ | ___ |
| 部署后验证 | ___ | ___ | ___ |

---

**检查清单版本**: v1.0  
**创建时间**: 2024-12-02  
**维护者**: System Admin
