# AdminHeader 全局退出功能测试指南

## 1. 功能概述

本次更新在 `AdminHeader.vue` 组件中添加了 SSO 全局退出功能，用户可以选择：
- **退出登录**：本地退出，清除当前应用的登录状态
- **全局退出（SSO）**：全局退出，清除 Keycloak 服务器端的所有会话

## 2. 修改内容总结

### 2.1 代码修改

**文件路径：** `ps-fe\@fb\admin-base\views\main\components\AdminHeader.vue`

#### 2.1.1 新增方法（JavaScript）

在 `methods` 中新增 `globalLogout()` 方法（第 497-603 行）：
- 弹出全局退出确认对话框
- 调用 `/sso/user/logout` 接口
- 根据返回的 `logoutType` 显示不同的提示信息
- 清除本地数据和 Vuex 状态
- 跳转到登录页面
- 包含完整的错误处理和降级策略

#### 2.1.2 模板修改（Template）

在 `card-footer` 区域新增全局退出选项（第 147-151 行）：
```html
<div @click="globalLogout" class="card-item global-logout-item">
    <fb-icon :name="'logout'"></fb-icon>
    全局退出（SSO）
</div>
```

#### 2.1.3 样式修改（Style）

为全局退出选项添加样式（第 1247-1250 行）：
```less
.global-logout-item {
    border-top: 1px solid #F0F0F0;
}
```

### 2.2 依赖接口

- **接口路径：** `/sso/user/logout`
- **请求方法：** POST
- **服务调用：** `this.$svc.sys.sso.user.logout()`
- **后端实现：** 已存在于 `TpSsoController.java`

## 3. 测试环境准备

### 3.1 前置条件

1. **后端服务运行**：确保 `ps-be` 后端服务正常运行
2. **Keycloak 服务**：确保 Keycloak 服务器可访问（可选，用于完整功能测试）
3. **前端应用启动**：启动 `ps-fe` 前端应用
4. **用户登录**：使用测试账号登录系统

### 3.2 测试账号准备

建议准备以下类型的测试账号：
- **SSO 账号**：已绑定 Keycloak 的用户
- **本地账号**：未绑定 Keycloak 的用户

## 4. 功能测试用例

### 测试用例 1：UI 显示验证

**测试目标：** 验证全局退出选项是否正确显示

**测试步骤：**
1. 登录系统
2. 点击右上角用户头像
3. 观察下拉菜单

**预期结果：**
- ✓ 显示"修改密码"选项
- ✓ 显示"退出登录"选项
- ✓ 显示"全局退出（SSO）"选项
- ✓ "全局退出（SSO）"选项有分割线与"退出登录"区分
- ✓ 两个退出选项图标和文字对齐正常
- ✓ hover 时有高亮效果

---

### 测试用例 2：正常全局退出（SSO 账号）

**测试目标：** 验证已绑定 SSO 账号的用户执行全局退出

**前置条件：**
- 用户已通过 SSO 登录
- Keycloak 服务器正常运行

**测试步骤：**
1. 点击用户头像
2. 点击"全局退出（SSO）"选项
3. 观察确认对话框
4. 点击"确定"按钮

**预期结果：**
- ✓ 弹出确认对话框，标题为"全局退出确认"
- ✓ 对话框内容为："确定要退出所有关联系统吗？退出后需要重新登录才能访问。"
- ✓ 显示成功提示："全局退出成功，已清除所有系统会话"
- ✓ 跳转到登录页面
- ✓ 本地 token、userInfo 等数据已清除
- ✓ Keycloak 服务器端会话已注销

**验证方法：**
1. 打开浏览器开发者工具
2. 检查 Network 标签，确认调用了 `/sso/user/logout` 接口
3. 检查接口返回 `code: 1`，`data.logoutType: 'sso'`
4. 检查 localStorage 和 sessionStorage，确认已清空
5. 尝试访问受保护页面，确认跳转到登录页

---

### 测试用例 3：本地账号全局退出

**测试目标：** 验证未绑定 SSO 账号的用户执行全局退出

**前置条件：**
- 用户使用本地账号登录
- 未绑定 Keycloak 账号

**测试步骤：**
1. 点击用户头像
2. 点击"全局退出（SSO）"选项
3. 点击确认对话框的"确定"按钮

**预期结果：**
- ✓ 弹出确认对话框
- ✓ 显示提示："本地退出成功"
- ✓ 跳转到登录页面
- ✓ 本地数据已清除

**验证方法：**
1. 检查接口返回 `data.logoutType: 'local'`
2. 确认本地数据清除成功
3. 确认跳转到登录页

---

### 测试用例 4：Keycloak 服务不可用场景

**测试目标：** 验证 Keycloak 服务不可用时的降级处理

**前置条件：**
- 用户已登录
- Keycloak 服务器停止或网络不通

**测试步骤：**
1. 停止 Keycloak 服务器（或模拟网络不通）
2. 点击用户头像
3. 点击"全局退出（SSO）"选项
4. 点击确认对话框的"确定"按钮

**预期结果：**
- ✓ 弹出确认对话框
- ✓ 显示提示："部分退出成功，本地会话已清除" 或 "SSO 退出服务暂时不可用，已执行本地退出"
- ✓ 跳转到登录页面
- ✓ 本地数据已清除
- ✓ 不影响用户退出流程

**验证方法：**
1. 检查接口返回 `data.logoutType: 'partial'` 或接口调用失败
2. 检查控制台输出错误日志
3. 确认本地数据清除成功

---

### 测试用例 5：用户取消退出操作

**测试目标：** 验证用户取消退出时的行为

**测试步骤：**
1. 点击用户头像
2. 点击"全局退出（SSO）"选项
3. 在确认对话框中点击"取消"按钮

**预期结果：**
- ✓ 关闭确认对话框
- ✓ 不执行任何退出操作
- ✓ 保持登录状态
- ✓ 用户可以继续操作系统

---

### 测试用例 6：本地退出功能兼容性

**测试目标：** 验证原有的"退出登录"功能不受影响

**测试步骤：**
1. 点击用户头像
2. 点击"退出登录"选项（不是"全局退出（SSO）"）
3. 点击确认对话框的"确定"按钮

**预期结果：**
- ✓ 弹出确认对话框，标题为"退出确认"（或默认标题）
- ✓ 对话框内容为："确定要退出吗？"
- ✓ 执行原有的本地退出逻辑
- ✓ 跳转到登录页面
- ✓ 本地数据已清除

---

### 测试用例 7：网络异常处理

**测试目标：** 验证接口调用网络异常时的处理

**测试步骤：**
1. 使用浏览器开发者工具，在 Network 标签中阻止 `/sso/user/logout` 接口
2. 点击用户头像
3. 点击"全局退出（SSO）"选项
4. 点击确认对话框的"确定"按钮

**预期结果：**
- ✓ 显示警告提示："SSO 退出服务暂时不可用，已执行本地退出"
- ✓ 控制台输出错误日志
- ✓ 仍然清除本地数据
- ✓ 跳转到登录页面

---

### 测试用例 8：响应式布局测试

**测试目标：** 验证在不同屏幕尺寸下的显示效果

**测试步骤：**
1. 调整浏览器窗口大小，测试不同尺寸
2. 点击用户头像，观察下拉菜单

**测试尺寸：**
- 1920x1080（桌面端）
- 1366x768（小屏幕桌面端）
- 768x1024（平板横屏）
- 375x667（移动端）

**预期结果：**
- ✓ 下拉菜单在各种尺寸下显示正常
- ✓ 两个退出选项文字不换行、不溢出
- ✓ 图标和文字对齐正常

---

### 测试用例 9：快速连续点击测试

**测试目标：** 验证防止重复提交

**测试步骤：**
1. 点击用户头像
2. 连续快速点击"全局退出（SSO）"选项多次

**预期结果：**
- ✓ 只弹出一次确认对话框
- ✓ 不会重复触发退出操作

---

### 测试用例 10：日志埋点验证

**测试目标：** 验证退出操作是否记录日志

**测试步骤：**
1. 打开浏览器开发者工具
2. 点击用户头像
3. 点击"全局退出（SSO）"选项
4. 点击确认对话框的"确定"按钮
5. 观察 Network 标签中的日志请求

**预期结果：**
- ✓ 调用了日志埋点接口
- ✓ 日志中 `operateType` 为 `logout`
- ✓ 日志中 `moduleCode` 为 `login`

## 5. 数据清理验证

### 5.1 本地存储清理

在执行退出操作后，检查以下数据是否已清除：

**DataX 存储检查：**
```javascript
// 在浏览器控制台执行
app.$datax.get('login')      // 应返回 null 或 undefined
app.$datax.get('token')       // 应返回 null 或 undefined
app.$datax.get('TOKEN_REAL')  // 应返回 null 或 undefined
app.$datax.get('userInfo')    // 应返回 null 或 undefined
```

**localStorage 检查：**
- 打开浏览器开发者工具 > Application > Local Storage
- 确认 `token`、`userInfo` 等键已被删除

**sessionStorage 检查：**
- 打开浏览器开发者工具 > Application > Session Storage
- 确认相关会话数据已清除

### 5.2 Vuex 状态清理

检查 Vuex 状态是否已清空：
```javascript
// 在浏览器控制台执行
app.$store.state.admin       // 检查 token 是否清空
app.$store.state.menu        // 检查菜单数据是否清空
app.$store.state.tabbar      // 检查标签页数据是否清空
```

### 5.3 权限验证

尝试访问受保护的页面，验证是否正确跳转到登录页：
1. 在地址栏输入系统内部页面地址
2. 按回车键访问
3. 应自动跳转到登录页面

## 6. 接口调用验证

### 6.1 请求参数验证

打开浏览器开发者工具 > Network 标签，筛选 `/sso/user/logout` 请求：

**请求信息：**
- 请求方法：POST
- 请求路径：`/sso/user/logout`
- 请求头：包含 Authorization 或 token 信息
- 请求体：无（或空）

### 6.2 响应数据验证

**成功响应示例（SSO 退出）：**
```json
{
  "code": 1,
  "message": "操作成功",
  "data": {
    "logoutType": "sso",
    "message": "SSO退出成功，用户会话已从Keycloak注销"
  }
}
```

**成功响应示例（本地退出）：**
```json
{
  "code": 1,
  "message": "操作成功",
  "data": {
    "logoutType": "local",
    "message": "本地退出成功"
  }
}
```

**成功响应示例（部分退出）：**
```json
{
  "code": 1,
  "message": "操作成功",
  "data": {
    "logoutType": "partial",
    "message": "Keycloak注销失败，但本地会话已清除"
  }
}
```

## 7. 兼容性测试

### 7.1 浏览器兼容性

在以下浏览器中测试功能是否正常：

- ✓ Chrome（最新版本）
- ✓ Edge（最新版本）
- ✓ Firefox（最新版本）
- ✓ Safari（最新版本，Mac）

### 7.2 操作系统兼容性

- ✓ Windows 10/11
- ✓ macOS
- ✓ Linux

## 8. 性能测试

### 8.1 响应时间

测量全局退出操作的响应时间：

**测试方法：**
1. 打开浏览器开发者工具 > Network 标签
2. 点击"全局退出（SSO）"并确认
3. 记录 `/sso/user/logout` 接口的响应时间

**预期指标：**
- 接口响应时间 ≤ 3 秒
- 页面跳转时间 ≤ 1 秒
- 总体退出流程 ≤ 5 秒

### 8.2 内存泄漏检测

**测试方法：**
1. 打开浏览器开发者工具 > Memory 标签
2. 记录初始内存使用情况
3. 执行多次退出和登录操作
4. 记录每次操作后的内存使用情况

**预期结果：**
- 无明显内存泄漏
- 内存使用保持稳定

## 9. 安全性测试

### 9.1 会话清除完整性

验证退出后用户无法继续使用系统：

**测试步骤：**
1. 记录退出前的 token
2. 执行全局退出
3. 使用记录的 token 尝试调用 API

**预期结果：**
- API 返回 401 或 403 错误
- 提示未授权或会话过期

### 9.2 跨站脚本（XSS）防护

验证输入和输出的安全性：
- 确认用户名等数据正确转义
- 无 XSS 漏洞

## 10. 常见问题排查

### 问题 1：点击"全局退出（SSO）"无反应

**可能原因：**
- SSO 服务接口未配置
- `$svc.sys.sso` 服务未正确加载

**排查方法：**
1. 打开浏览器控制台，查看是否有 JavaScript 错误
2. 检查 `this.$svc.sys.sso.user.logout` 方法是否存在
3. 检查后端 `/sso/user/logout` 接口是否可访问

---

### 问题 2：退出后仍然可以访问受保护页面

**可能原因：**
- 本地数据未正确清除
- Vuex 状态未清空
- 路由守卫未正确配置

**排查方法：**
1. 检查 localStorage 和 sessionStorage
2. 检查 Vuex 状态
3. 检查路由守卫逻辑

---

### 问题 3：接口返回错误

**可能原因：**
- 后端服务未启动
- Keycloak 服务不可用
- 用户 token 已过期

**排查方法：**
1. 检查后端服务状态
2. 检查 Keycloak 服务状态
3. 查看接口返回的错误信息

---

### 问题 4：UI 显示异常

**可能原因：**
- 样式未正确加载
- 图标库未引入
- 浏览器缓存问题

**排查方法：**
1. 清除浏览器缓存
2. 检查样式是否正确应用
3. 检查图标组件是否正确渲染

## 11. 回归测试检查清单

在完成功能测试后，进行以下回归测试：

- [ ] 登录功能正常
- [ ] 修改密码功能正常
- [ ] 原有的"退出登录"功能正常
- [ ] 菜单导航正常
- [ ] 用户信息显示正常
- [ ] 权限控制正常
- [ ] 其他头部功能（如通知、帮助等）正常

## 12. 测试报告模板

### 测试摘要

| 项目 | 内容 |
|-----|------|
| 测试日期 | YYYY-MM-DD |
| 测试人员 | XXX |
| 测试环境 | 开发环境 / 测试环境 |
| 测试版本 | vX.X.X |

### 测试结果统计

| 测试用例总数 | 通过 | 失败 | 阻塞 | 跳过 |
|------------|------|------|------|------|
| 10 | X | X | X | X |

### 缺陷汇总

| 缺陷ID | 缺陷描述 | 严重程度 | 状态 |
|-------|---------|---------|------|
| BUG-001 | XXX | 高/中/低 | 待修复/已修复 |

### 测试结论

- [ ] 通过，可以发布
- [ ] 不通过，需要修复问题后重新测试

### 备注

（记录测试过程中的特殊情况、建议等）

## 13. 验收标准

功能可以验收的标准：

✓ 所有测试用例通过  
✓ 无阻塞性 bug  
✓ 无严重性 bug  
✓ 中等及以下 bug 数量 ≤ 2  
✓ 代码无语法错误  
✓ 代码符合规范  
✓ 性能指标达标  
✓ 安全性测试通过  
✓ 兼容性测试通过  

---

**文档版本：** v1.0  
**创建日期：** 2024-12-03  
**最后更新：** 2024-12-03
