# 应用管理"有效的注销后重定向 URI"字段 - 测试指南

## 测试环境准备

### 1. 启动服务
```bash
# 前端服务
cd d:\projects\ps\ps-fe
npm run dev
# 访问: http://localhost:10801

# 后端服务（如未运行）
cd d:\projects\ps\ps-be
# 确保在 8082 端口运行

# Keycloak 服务
# 访问: http://localhost:18080
# 账号: admin / admin123
```

### 2. 登录系统
- URL: http://localhost:10801
- 使用有效的系统账号登录

## 测试用例

### 测试用例 1: 新增应用时配置注销重定向 URI

**步骤**:
1. 导航到：系统管理 → SSO 管理 → 应用管理
2. 点击"注册应用"按钮
3. 填写基本信息：
   - 应用ID: `test-client-001`
   - 应用名称: `测试应用001`
   - 协议: `OpenID Connect`
   - 应用类型: `公共应用`
4. 滚动到"有效的注销后重定向 URI"字段
5. 输入以下内容（每行一个）：
   ```
   http://localhost:10801/logout-success
   http://localhost:10801/goodbye
   http://localhost:10801/
   ```
6. 点击"保存"

**预期结果**:
- ✅ 保存成功，提示"新增成功"
- ✅ 对话框自动关闭
- ✅ 列表中显示新创建的应用

**验证步骤**:
1. 在列表中找到刚创建的应用
2. 点击应用ID链接（查看模式）
3. 滚动到"有效的注销后重定向 URI"字段
4. 确认显示 3 个 URI，每行一个
5. 确认字段处于禁用状态（查看模式）

---

### 测试用例 2: 编辑已有应用的注销重定向 URI

**步骤**:
1. 在应用列表中找到刚创建的 `test-client-001`
2. 点击"修改"按钮
3. 滚动到"有效的注销后重定向 URI"字段
4. 确认当前值为之前输入的 3 个 URI
5. 修改内容为：
   ```
   http://localhost:10801/logout
   http://localhost:10801/signout
   ```
6. 点击"保存"

**预期结果**:
- ✅ 保存成功，提示"修改成功"
- ✅ 再次打开编辑页面，显示修改后的 2 个 URI
- ✅ 原来的 3 个 URI 被替换为新的 2 个

---

### 测试用例 3: 空值处理

**步骤**:
1. 编辑 `test-client-001`
2. 清空"有效的注销后重定向 URI"字段（删除所有内容）
3. 点击"保存"
4. 重新打开编辑页面

**预期结果**:
- ✅ 保存成功
- ✅ 重新打开时，字段为空
- ✅ 不影响其他字段的保存

---

### 测试用例 4: 空行处理

**步骤**:
1. 编辑 `test-client-001`
2. 在"有效的注销后重定向 URI"字段中输入（包含空行）：
   ```
   http://localhost:10801/logout
   
   http://localhost:10801/signout
   
   
   http://localhost:10801/goodbye
   ```
3. 点击"保存"
4. 重新打开编辑页面

**预期结果**:
- ✅ 保存成功
- ✅ 重新打开时，只显示 3 个有效 URI（空行被自动过滤）
- ✅ 显示格式整洁，无多余空行

---

### 测试用例 5: 通配符 URI

**步骤**:
1. 编辑 `test-client-001`
2. 输入通配符 URI：
   ```
   http://localhost:10801/*
   http://localhost:8080/app/*
   ```
3. 点击"保存"

**预期结果**:
- ✅ 保存成功
- ✅ 重新打开时，正确显示通配符 URI
- ✅ Keycloak 接受通配符格式

---

### 测试用例 6: 复制粘贴多个 URI

**步骤**:
1. 准备以下文本：
   ```
   http://localhost:10801/logout
   http://localhost:10801/signout
   http://localhost:10801/goodbye
   http://localhost:8080/app/logout
   http://example.com/logout
   ```
2. 编辑 `test-client-001`
3. 将上述文本复制粘贴到"有效的注销后重定向 URI"字段
4. 点击"保存"
5. 重新打开

**预期结果**:
- ✅ 保存成功
- ✅ 正确识别 5 个 URI
- ✅ 每个 URI 单独一行显示
- ✅ 换行符（\n 或 \r\n）正确处理

---

### 测试用例 7: 查看模式验证

**步骤**:
1. 在应用列表中点击应用ID链接（进入查看模式）
2. 滚动到"有效的注销后重定向 URI"字段

**预期结果**:
- ✅ 字段显示当前配置的 URI
- ✅ 文本域处于禁用状态（不可编辑）
- ✅ 灰色背景或禁用样式

---

### 测试用例 8: Keycloak 后端验证

**步骤**:
1. 在系统中保存一个应用，配置注销重定向 URI
2. 登录 Keycloak Admin Console
   - URL: http://localhost:18080
   - 账号: admin / admin123
3. 选择 Realm: `ps-realm`
4. 进入 Clients → 找到对应的客户端
5. 查看客户端配置

**预期结果**:
- ✅ 在 Keycloak 中能找到对应的客户端
- ✅ "Valid Post Logout Redirect URIs" 字段显示正确的 URI 列表
- ✅ URI 数量和内容与前端配置一致

---

### 测试用例 9: 机密应用 vs 公共应用

**步骤**:
1. 创建机密应用，配置注销重定向 URI
2. 创建公共应用，配置注销重定向 URI

**预期结果**:
- ✅ 两种类型的应用都能正常配置注销重定向 URI
- ✅ 字段在两种类型中都正常显示和保存

---

### 测试用例 10: 与 SSO 全局退出功能集成测试

**步骤**:
1. 配置一个应用的注销重定向 URI 为：
   ```
   http://localhost:10801/
   ```
2. 使用该应用的 SSO 账号登录系统
3. 点击右上角用户头像
4. 选择"全局退出(SSO)"
5. 确认退出

**预期结果**:
- ✅ 成功执行 SSO 全局退出
- ✅ 退出后重定向到配置的 URI
- ✅ 所有关联系统的会话都被清除

---

## 测试检查清单

### 基本功能
- [ ] 新增应用时可以输入注销重定向 URI
- [ ] 编辑应用时可以修改注销重定向 URI
- [ ] 查看应用时注销重定向 URI 显示正确且为只读
- [ ] 保存后数据持久化正确

### 数据验证
- [ ] 空值允许保存
- [ ] 空行自动过滤
- [ ] 多行文本正确分割
- [ ] 通配符 URI 正确保存
- [ ] 复制粘贴的文本正确处理

### UI 交互
- [ ] 字段标签显示为"有效的注销后重定向 URI"
- [ ] 占位提示文本清晰易懂
- [ ] 文本域高度合适（3行）
- [ ] 查看模式下字段禁用
- [ ] 编辑模式下字段可编辑

### 兼容性
- [ ] 与现有应用数据兼容
- [ ] Keycloak 后端正确接收和存储
- [ ] 不同换行符格式（\n, \r\n）都能正确处理
- [ ] 机密应用和公共应用都支持

### 集成测试
- [ ] 与 SSO 全局退出功能配合工作
- [ ] 配置的 URI 在注销后能正确重定向
- [ ] 未配置的 URI 在重定向时被拒绝

---

## 常见问题排查

### 问题 1: 保存后重新打开，注销重定向 URI 为空

**可能原因**:
- 后端未正确传递数据给 Keycloak
- Keycloak 使用了不同的字段名

**排查步骤**:
1. 检查浏览器开发者工具 → Network → 查看保存请求的 payload
2. 检查后端日志
3. 在 Keycloak Admin Console 中手动查看客户端配置
4. 确认 `loadClientData` 方法中的兼容性处理逻辑

---

### 问题 2: 输入的 URI 包含空行

**解决方案**:
- 前端已自动过滤空行（`filter(uri => uri.trim())`）
- 如仍出现，检查 watch 监听器是否正常工作

---

### 问题 3: 查看模式下字段可以编辑

**解决方案**:
- 检查 `readonly` 属性是否正确传递
- 确认 `:disabled="readonly"` 绑定正确

---

### 问题 4: Keycloak 提示 URI 格式错误

**可能原因**:
- URI 格式不符合 Keycloak 要求
- 缺少协议前缀（http:// 或 https://）

**解决方案**:
- 确保 URI 格式正确
- 建议添加前端 URI 格式验证

---

## 测试数据示例

### 有效的 URI 格式
```
http://localhost:10801/
http://localhost:10801/logout-success
http://localhost:10801/goodbye
http://localhost:8080/app/logout
https://example.com/logout
http://localhost:10801/*
http://*/logout
```

### 无效的 URI 格式（如需验证）
```
localhost:10801/logout        ❌ 缺少协议
/logout                       ❌ 缺少主机名
ftp://localhost/logout        ❌ 不支持的协议
```

---

## 测试完成标准

✅ 所有 10 个测试用例通过  
✅ 所有检查清单项目完成  
✅ 无已知 Bug  
✅ UI 符合设计规范  
✅ 与现有功能无冲突  
✅ Keycloak 后端数据一致  

---

**测试负责人**: _____________  
**测试日期**: _____________  
**测试结果**: ⬜ 通过 / ⬜ 不通过  
**备注**: _____________________________________________
