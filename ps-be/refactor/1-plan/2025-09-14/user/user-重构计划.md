# user单业务模块重构计划

> **生成时间**：2025-09-14  
> **模块路径**：`D:\keycloak_sb_sso_new0910_claude\ps\ps-be\src\main\java\com\jiuxi\module\user`  
> **重构版本**：v1.0

## 1. 项目概述

基于对 `D:\keycloak_sb_sso_new0910_claude\ps\ps-be\src\main\java\com\jiuxi\module\user` 的深度分析，本计划旨在**不破坏现有功能**的前提下，通过系统性重构实现：

- **统一架构设计**：全面采用DDD（领域驱动设计）分层架构
- **优化代码组织**：完善目录结构和代码组织方式  
- **提升可维护性**：建立清晰的业务边界和依赖关系
- **增强功能特性**：统一新旧API接口，优化用户管理和账户管理流程
- **优化模块代码**: 识别模块坏气味代码并进行修改
- **清理删除文件（夹）**: 识别无用的代码、文件或者目录

## 2. 现状分析

### 2.1 当前模块结构

```
user/
├── UserModuleConfiguration.java          # 模块配置类
├── app/                                  # 应用服务层
│   ├── assembler/
│   │   └── UserAssembler.java           # 对象装配器
│   ├── dto/                             # 数据传输对象
│   │   ├── UserCreateDTO.java
│   │   ├── UserQueryDTO.java
│   │   ├── UserResponseDTO.java
│   │   └── UserUpdateDTO.java
│   └── service/                         # 应用服务层
│       ├── PersonAccountApplicationService.java
│       ├── UserAccountService.java
│       ├── UserApplicationService.java   # 现代DDD风格服务
│       ├── UserPersonService.java
│       └── impl/                        # [问题]嵌套在service内
│           ├── PersonAccountApplicationServiceImpl.java
│           ├── UserAccountServiceImpl.java
│           └── UserPersonServiceImpl.java
├── domain/                              # 领域层(基本完善)
│   ├── entity/                          # 实体
│   ├── event/                           # 领域事件
│   ├── repo/                            # 仓储接口
│   ├── service/                         # 领域服务
│   ├── valueobject/                     # [问题]应改为vo
│   └── vo/                              # 空目录
├── infra/                               # 基础设施层
│   └── persistence/                     # 持久化
├── interfaces/                          # [问题]旧接口目录，应迁移到intf
│   └── web/
│       ├── UserAccountController.java   # [问题]应迁移到intf/web/controller/
│       ├── UserController.java          # [问题]应迁移到intf/web/controller/
│       ├── controller/                  # 子目录包含部分Controller
│       └── dto/                         # Web层DTO
└── intf/                                # 新接口目录(基本为空)
    └── web/
        ├── controller/                  # 空目录
        └── dto/                         # 空目录
```

### 2.2 核心业务识别

**主要业务职责**：用户生命周期管理和账户管理

**关键业务用例**：
- 用户创建与注册管理
- 用户信息维护与更新
- 用户状态管理（激活/停用/删除）
- 账户管理（密码重置/账户锁定/权限控制）
- 用户查询与搜索
- 批量用户操作
- Keycloak账户同步
- 企业/政府人员分类管理

### 2.3 主要问题识别

**架构一致性问题**：
- 存在新旧两套API体系：现代RESTful风格（UserController）与传统风格（UserPersonController）
- 服务层目录结构不规范，impl目录嵌套在service目录内
- 接口层存在重复目录结构（interfaces和intf）

**代码组织问题**：
- interfaces/web/目录下直接存放Controller文件，违反目录规范
- valueobject目录命名不规范，应使用vo缩写
- 存在大量空目录需要清理
- Web层DTO分散在不同目录中

**代码质量问题**：
- UserAccountServiceImpl包含大量遗留代码和注释掉的代码块
- 存在硬编码的测试代码片段
- 代码重复度较高，特别是账户管理相关逻辑

### 2.4 技术债务评估

**代码质量问题**：
- 代码重复率较高，特别是密码处理、加密解密逻辑
- 方法复杂度过高，单个方法超过100行
- 异常处理不统一，错误信息不够友好

**架构问题**：
- 新旧API并存，增加维护成本
- 服务层责任不清晰，应用服务和基础服务混合
- 依赖注入过于复杂，存在可选依赖处理

## 3. 重构目标与架构设计

### 3.1 目标DDD架构

```
user/
├── UserModuleConfiguration.java
├── app/                        # 应用服务层
│   ├── assembler/              # 对象装配器
│   ├── dto/                    # 数据传输对象
│   ├── service/                # 应用服务接口
│   └── impl/                   # 应用服务实现
├── domain/                     # 领域层
│   ├── entity/                 # 实体
│   ├── event/                  # 领域事件
│   ├── repo/                   # 仓储接口
│   ├── service/                # 领域服务接口
│   └── vo/                     # 值对象
├── infra/                      # 基础设施层
│   └── persistence/            # 持久化
│       ├── assembler/          # PO装配器
│       ├── entity/             # 持久化对象
│       ├── mapper/             # MyBatis映射器
│       └── repo/               # 仓储实现
└── intf/                       # 接口层(重命名为intf)
    └── web/                    # Web接口
        ├── controller/         # 控制器
        └── dto/                # 接口DTO
```

### 3.2 目录结构规范说明

根据项目重构规范，目录结构需遵循以下命名规则：

1. **接口层目录规范**：
   - 使用 `intf/` 目录，不使用 `interfaces/` 缩写
   - 保持接口层结构清晰，包含controller和dto子目录
   - 所有Controller类必须迁移到 `intf/web/controller/` 目录下
   - 所有DTO类必须迁移到 `intf/web/dto/` 目录下
   - 禁止在 `intf/web/` 目录下直接存放Controller和DTO文件
   - 迁移完成后，检查并删除 `intf/web/` 目录下的直接Controller和DTO文件

2. **值对象目录规范**：
   - 使用 `vo/` 目录，不使用 `valueobject/` 缩写
   - 保持值对象的完整命名，提高代码可读性

3. **服务层目录规范**：
   - `service/` 目录存放服务 api 接口
   - `impl/` 目录存放服务 api 接口的具体实现
   - `service` 和 `impl` 目录必须为同级目录，都位于app目录下
   - **强制要求**：impl目录不得嵌套在service目录内

4. **目录命名一致性原则**：
   - 所有目录名使用完整单词，不使用缩写
   - 保持命名语义清晰，便于理解和维护
   - 避免使用含义模糊的缩写形式

### 3.3 代码迁移检查清单

为确保代码迁移工作正确执行，必须完成以下检查项：

1. **Controller迁移检查**：
   - [ ] 检查 `interfaces/web/` 目录下的UserController.java和UserAccountController.java文件
   - [ ] 将所有Controller文件迁移到 `intf/web/controller/` 目录
   - [ ] 更新所有相关的import语句
   - [ ] 验证Controller功能正常

2. **DTO迁移检查**：
   - [ ] 检查 `interfaces/web/dto/` 目录下的DTO文件
   - [ ] 将所有DTO文件迁移到 `intf/web/dto/` 目录
   - [ ] 更新所有相关的import语句
   - [ ] 验证DTO功能正常

3. **目录清理检查**：
   - [ ] 删除旧的 `interfaces/` 目录
   - [ ] 删除 `domain/valueobject/` 目录，内容迁移到 `domain/vo/`
   - [ ] 删除服务层中嵌套的impl目录，调整为同级结构
   - [ ] 删除迁移后留下的空目录
   - [ ] 验证目录结构符合目标架构

### 3.4 领域模型设计

**聚合根识别**：
- User（用户聚合根）：包含用户基本信息、用户档案、账户信息
- 聚合边界：单个用户的完整生命周期管理

**领域事件定义**：
- UserCreatedEvent：用户创建事件
- UserUpdatedEvent：用户信息更新事件  
- UserDeletedEvent：用户删除事件
- UserAccountCreatedEvent：用户账户创建事件
- UserProfileUpdatedEvent：用户档案更新事件

## 4. 重构实施计划

### 阶段一：准备与分析（第1周）

**4.1.1 业务接口档案建立**
- **强制要求**：必须生成以下所有文档，缺一不可
- 扫描现有Web接口，记录所有API的URL、参数、返回值
- 生成文档内容主体是中文
- 生成接口业务说明文档：`D:\keycloak_sb_sso_new0910_claude\ps\ps-be\refactor\2-info\2025-09-14\user\user-接口说明.md`，包括接口入参、返回类型，接口作用。文件名字要严格匹配，且该目录只生成这一个文件。
- 生成接口测试文档：`D:\keycloak_sb_sso_new0910_claude\ps\ps-be\refactor\3-test\2025-09-14\user\user-测试接口.md`。文件名字要严格匹配，且该目录只生成这一个文件。文档内容主体是中文，包括接口测试用例、测试步骤。
- 生成接口测试脚本：文件前缀为 `D:\keycloak_sb_sso_new0910_claude\ps\ps-be\refactor\4-script\2025-09-14\user\user-测试脚本`。文件名字要严格匹配，且该目录只生成这一个文件。文件内容主体是中文，根据接口测试文档，生成接口测试脚本。
- **执行状态**：☐ 未开始 ☐ 进行中 ☑ 已完成
- **文档生成检查**：☐ 未完成 ☐ 部分完成 ☑ 全部完成

**4.1.2 依赖关系分析**
- 分析模块内部依赖关系
- 识别外部模块依赖和第三方依赖
- 绘制依赖关系图，识别循环依赖风险
- 生成依赖关系分析报告：`D:\keycloak_sb_sso_new0910_claude\ps\ps-be\refactor\5-analysis\2025-09-14\user\user-依赖关系分析.md`。文件名字要严格匹配，且该目录只生成这一个依赖关系分析报告。文档内容主体是中文。
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☑ 已完成

**4.1.3 数据模型分析**
- 梳理现有实体关系
- 分析PO对象和业务对象的映射关系
- 识别数据访问模式和查询复杂度
- 生成数据模型分析报告：`D:\keycloak_sb_sso_new0910_claude\ps\ps-be\refactor\5-analysis\2025-09-14\user\user-数据模型分析.md`。文件名字要严格匹配，且该目录只生成这一个数据模型分析报告。文档内容主体是中文。
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☑ 已完成

### 阶段二：目录结构重构（第2周）

**4.2.1 目录结构调整**
- 按照3.1节定义的目标DDD架构，重新组织模块目录结构
- 移动现有文件到新的目录结构中，确保包路径与目录路径一致
- 清理空目录和无用文件
- 更新所有相关的import语句和配置文件
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.2.2 包命名规范统一**
- 统一包命名规范，确保符合DDD分层架构要求
- 重命名不符合规范的包和类
- 更新所有引用这些包和类的地方
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.2.3 配置文件调整**
- 更新Spring配置文件中的包扫描路径
- 调整组件扫描注解确保能正确扫描到所有组件
- 验证重构后的目录结构能正常启动和运行
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 阶段三：领域层重构（第3-4周）

**4.3.1 实体和值对象重构**
- 将valueobject目录内容迁移到vo目录
- 优化User聚合根的设计，确保业务一致性
- 完善值对象的封装和验证逻辑
- 清理valueobject空目录
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.3.2 仓储接口设计**
- 优化UserRepository接口设计，符合DDD仓储模式
- 统一查询方法的命名规范
- 完善复杂查询的接口定义
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.3.3 领域服务提取**
- 完善UserDomainService的业务规则封装
- 提取账户管理相关的领域服务
- 优化领域事件的发布机制
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 阶段四：应用服务层重构（第4-5周）

**4.4.1 应用服务实现**
- 调整impl目录位置，与service目录同级
- 重构UserAccountServiceImpl，简化复杂逻辑
- 统一新旧服务接口，逐步迁移到新的应用服务
- 优化事务管理和异常处理
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.4.2 DTO设计优化**
- 统一应用层DTO的设计规范
- 完善DTO的验证注解和转换逻辑
- 优化UserAssembler的对象转换逻辑
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 阶段五：基础设施层重构（第5-6周）

**4.5.1 仓储实现重构**
- 优化UserRepositoryImpl的实现，确保与接口定义一致
- 完善数据访问层的异常处理
- 优化复杂查询的性能
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

**4.5.2 缓存策略优化**
- 分析用户查询的缓存需求
- 设计合理的缓存策略
- 实现缓存的自动更新机制
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 阶段六：接口层重构（第6-7周）

**4.6.1 控制器重构**
- **⚠️ 重要约束**：不得修改任何现有API的URL、入参格式、返回格式
- 将interfaces/web/目录下的Controller迁移到intf/web/controller/目录
- 将interfaces/web/controller/目录下的Controller也迁移到intf/web/controller/目录
- 统一新旧API的实现方式，逐步迁移到统一的应用服务
- 保持异常处理和响应格式完全一致
- 更新所有相关的import语句
- 删除旧的interfaces目录
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

## 5. 最终验证与清理（第8周）

### 5.1 编译验证
- **强制要求**：确保重构后的代码在ps-be整个项目中编译通过
- 执行完整的Maven编译命令：`mvn clean compile spring-boot:run -DskipTests`
- 记录编译结果和任何错误信息
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 5.2 文件清理
- **强制要求**：删除所有空目录和无用文件
- 检查并删除空的包目录
- 删除旧的interfaces目录
- 删除domain/valueobject目录
- 清理临时文件和无用的配置文件
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

### 5.3 状态同步
- **强制要求**：将所有阶段的执行状态同步到本文档中
- 更新验收标准的完成情况
- 记录重构过程中的问题和解决方案
- **强制要求**：执行完毕后必须在文档中同步状态
- **执行状态**：☐ 未开始 ☐ 进行中 ☐ 已完成

## 6. 验收标准

### 6.1 功能验收标准
- [ ] **接口兼容性**：所有原有API接口URL、参数、返回值格式保持100%一致
- [ ] **业务逻辑**：所有业务用例执行结果与重构前完全一致
- [ ] **数据完整性**：数据读写操作结果无任何差异

### 6.2 质量验收标准  
- [ ] **代码编译**：所有代码编译通过，无编译错误和警告
- [ ] **测试覆盖**：单元测试覆盖率≥80%
- [ ] **代码质量**：代码重复率<5%，复杂度评级≥B级

### 6.3 架构验收标准
- [ ] **DDD架构**：严格遵循DDD分层架构和命名规范
- [ ] **依赖管理**：消除循环依赖，依赖方向符合架构原则
- [ ] **接口设计**：API设计遵循RESTful规范