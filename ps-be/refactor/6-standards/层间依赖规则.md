# 层间依赖规则（ArchUnit 对齐版）

适用范围：`ps-be` 后端代码库全局；用于指导与约束依赖方向，并作为 ArchUnit 规则基础。

## 依赖总则

- 领域核心稳定、向外辐射：`domain` 无业务外部依赖（仅 JDK 与 `shared`）。
- 依赖自上而下：`intf` → `app` → `domain`；技术实现向上提供能力：`infra` → `app/domain`（通过接口）。
- 禁止跨模块强耦合：`com.jiuxi.module.{a}...` 与 `com.jiuxi.module.{b}...` 禁止双向依赖；跨模块通过 `app`/事件/防腐层交互。

## 允许/禁止关系

- 允许：
  - `com.jiuxi.intf..` 依赖 `com.jiuxi.app..`、`com.jiuxi.shared..`
  - `com.jiuxi.app..` 依赖 `com.jiuxi.module..domain..`、`com.jiuxi.shared..`
  - `com.jiuxi.module..app..` 依赖 `com.jiuxi.module..domain..`、`com.jiuxi.shared..`
  - `com.jiuxi.module..infra..` 依赖 `com.jiuxi.module..domain..`、第三方库、`com.jiuxi.shared..`
  - `com.jiuxi.infra..` 依赖 第三方库、`com.jiuxi.shared..`
  - `com.jiuxi.domain..`（若汇聚公共领域）仅依赖 `shared` 与 JDK

- 禁止：
  - `com.jiuxi.module..domain..` 依赖 `com.jiuxi.module..infra..`、`com.jiuxi.infra..`、`com.jiuxi.intf..`、任何框架实现包
  - `com.jiuxi.app..` 依赖 `com.jiuxi.infra..`、`com.jiuxi.intf..`
  - `com.jiuxi.intf..` 直接依赖 `com.jiuxi.infra..`、`com.jiuxi.module..infra..`
  - 模块间循环依赖与层内循环依赖

## 命名与位置一致性

- 模块内统一使用：`com.jiuxi.module.{context}.domain|app|infra|intf`
- 历史 `interfaces` 包名视为过渡名：新代码一律使用 `intf`，并逐步迁移历史代码

## ArchUnit 规则草案（用于后续测试化）

以 JUnit5 + ArchUnit 为例，后续在独立 profile 中启用：

- 层级依赖：
  - `intf` 不得依赖 `infra`、`module..infra`
  - `app` 不得依赖 `infra`、`intf`
  - `domain` 不得依赖 `infra`、`intf`、任何第三方框架包
- 模块边界：
  - `module.{a}..` 与 `module.{b}..` 不得互相依赖
- 命名一致性：
  - `..module..intf..` 唯一合法适配层包名，禁止 `interfaces`（将提供宽限白名单直至迁移完成）

## 迁移策略

- 先立规（文档 + 规则草案）→ 再落地（测试化校验）→ 渐进整改（白名单例外 + 逐步清零）
- ArchUnit 测试将放置于独立测试源码目录，并通过 Maven profile 显式启用，默认不影响主构建

