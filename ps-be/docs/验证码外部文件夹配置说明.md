# 验证码外部文件夹配置说明

## 概述

为了解决JAR包部署时验证码图片资源无法访问的问题，系统现在支持使用外部文件夹存放验证码图片资源。

## 配置方式

### 1. 配置文件设置

在应用配置文件（如 `application-dev.yml`）中添加以下配置：

```yaml
captcha:
  image:
    # 外部验证码图片根目录（对应META-INF同级）
    external-dir: "D:/captcha-resources"  # Windows路径示例
    # external-dir: "/opt/ps/captcha-resources"  # Linux路径示例
    # external-dir: ""  # 留空则只使用内部资源
```

### 2. 外部目录结构

外部目录的文件结构应与内部JAR资源中的 `META-INF/` 目录**完全一致**：

```
D:/captcha-resources/         # 外部根目录（对应META-INF同级）
└── cut-image/               # 对应META-INF/cut-image/
    ├── slider/              # 滑块验证码（当前使用）
    │   ├── 0bg.jpg          # 背景图片
    │   ├── 0.png            # 滑块图片
    │   ├── 0_115_65.txt     # 坐标文件（实际坐标）
    │   ├── 1bg.jpg
    │   ├── 1.png
    │   ├── 1_139_88.txt
    │   ├── ...
    │   ├── 50bg.jpg
    │   ├── 50.png
    │   └── 50_188_177.txt
    ├── bgimage/             # 背景图片验证码（保留结构）
    ├── rotate/              # 旋转验证码（保留结构）
    └── template/            # 模板文件（保留结构）
```

**重要说明**：
- 外部目录完全复制内部的 `META-INF/cut-image/` 的完整结构
- 不同类型的验证码分别存放在不同的子目录中，便于管理
- 当前系统使用 `slider/` 目录中的滑块验证码
- 共有51套验证码图片（编号0-50）
- 每套包含：1个背景图片 + 1个滑块图片 + 1个坐标文件

### 3. 文件命名规则

- **背景图片**: `{数字}bg.jpg`（如：0bg.jpg, 1bg.jpg, ..., 50bg.jpg）
- **滑块图片**: `{数字}.png`（如：0.png, 1.png, ..., 50.png）
- **坐标文件**: `{数字}_{x坐标}_{y坐标}.txt`（如：0_200_150.txt）

## 工作原理

### 双重策略

系统采用"外部优先，内部回退"的双重策略：

1. **优先使用外部目录**: 如果配置了 `captcha.image.external-dir` 且目录存在，系统会首先尝试从外部目录加载验证码资源
2. **回退到内部资源**: 如果外部目录不存在、未配置或资源不完整，系统会自动回退到内部JAR资源

### 资源加载顺序

对于每个验证码图片资源，系统按以下顺序加载：

1. 检查外部目录配置是否存在
2. 尝试从外部目录加载背景图片、滑块图片和坐标文件
3. 如果外部资源不存在或加载失败，从内部JAR资源加载
4. 记录详细的加载日志便于调试

## 部署建议

### 开发环境

```yaml
captcha:
  image:
    external-dir: "D:/captcha-resources"  # 本地开发路径
```

### 测试环境

```yaml
captcha:
  image:
    external-dir: "/opt/ps/test/captcha-resources"
```

### 生产环境

```yaml
captcha:
  image:
    external-dir: "/opt/ps/prod/captcha-resources"
```

## 优势

### 1. 解决JAR包部署问题
- 彻底解决 "class path resource cannot be resolved to absolute file path" 错误
- 支持在容器化环境中正常运行

### 2. 提高灵活性
- 可以随时更新验证码图片而无需重新打包应用
- 支持不同环境使用不同的验证码资源

### 3. 向后兼容
- 如果不配置外部目录，系统会自动使用内部资源
- 现有的部署不会受到影响

### 4. 运维友好
- 详细的日志记录便于问题排查
- 支持热更新验证码资源

## 注意事项

### 1. 目录权限
确保应用有读取外部目录的权限：

```bash
# Linux环境设置权限
chmod -R 755 /opt/ps/captcha-resources
chown -R app:app /opt/ps/captcha-resources
```

### 2. 文件完整性
外部目录中的文件必须成对存在：
- 每个数字编号都需要对应的背景图片和滑块图片
- 坐标文件是可选的，如果不存在会使用随机坐标

### 3. 图片格式
- 背景图片：JPG格式，推荐尺寸 590x360
- 滑块图片：PNG格式（支持透明度），推荐尺寸 60x60

### 4. 监控建议
建议监控外部目录的状态：
- 检查目录是否存在
- 验证文件完整性
- 监控磁盘空间

## 故障排查

### 1. 检查配置
```bash
# 查看当前配置
curl http://localhost:8082/ps-be/actuator/configprops | grep captcha
```

### 2. 检查日志
关键日志信息：
- `使用外部验证码图片目录: {目录路径}`
- `从外部目录找到 {数量} 个可用图片`
- `外部目录中未找到可用的验证码图片，将使用内部资源`

### 3. 验证目录结构
```bash
# Linux环境检查
ls -la /opt/ps/captcha-resources/cut-image/slider/
# 检查文件数量
find /opt/ps/captcha-resources -name '*bg.jpg' | wc -l
find /opt/ps/captcha-resources -name '*.png' | wc -l
# 检查目录结构
tree /opt/ps/captcha-resources 2>/dev/null || find /opt/ps/captcha-resources -type d
```

## 示例脚本

### 复制内部资源到外部目录（开发使用）

```bash
#!/bin/bash
# copy-captcha-resources.sh

EXTERNAL_DIR="/opt/ps/captcha-resources"
JAR_FILE="ps-be.jar"

# 创建外部目录
mkdir -p $EXTERNAL_DIR

# 解压JAR中的验证码资源（临时目录）
mkdir -p temp_extract
cd temp_extract
jar -xf ../$JAR_FILE META-INF/cut-image/

# 复制完整的cut-image目录结构到外部目录
cp -r META-INF/cut-image $EXTERNAL_DIR/

# 清理临时目录
cd ..
rm -rf temp_extract

echo "验证码资源已复制到外部目录: $EXTERNAL_DIR"
echo "文件数量:"
echo "- 背景图片: $(find $EXTERNAL_DIR -name '*bg.jpg' | wc -l)"
echo "- 滑块图片: $(find $EXTERNAL_DIR -name '*.png' | wc -l)"
echo "- 坐标文件: $(find $EXTERNAL_DIR -name '*_*_*.txt' | wc -l)"
echo "目录结构:"
tree $EXTERNAL_DIR 2>/dev/null || find $EXTERNAL_DIR -type d | sed 's|[^/]*/|  |g'
```

**Windows PowerShell 版本：**

```powershell
# copy-captcha-resources.ps1

$ExternalDir = "D:\captcha-resources"
$JarFile = "ps-be.jar"

# 创建外部目录
New-Item -ItemType Directory -Force -Path $ExternalDir

# 解压JAR中的验证码资源
$TempDir = "temp_extract"
New-Item -ItemType Directory -Force -Path $TempDir
Set-Location $TempDir
jar -xf "..\$JarFile" META-INF/cut-image/

# 复制完整的cut-image目录结构到外部目录
Copy-Item "META-INF\cut-image" -Destination $ExternalDir -Recurse

# 清理临时目录
Set-Location ..
Remove-Item -Recurse -Force $TempDir

Write-Host "验证码资源已复制到外部目录: $ExternalDir"
Write-Host "文件数量:"
Write-Host "- 背景图片: $((Get-ChildItem "$ExternalDir\*bg.jpg" -Recurse).Count)"
Write-Host "- 滑块图片: $((Get-ChildItem "$ExternalDir\*.png" -Recurse).Count)"
Write-Host "- 坐标文件: $((Get-ChildItem "$ExternalDir\*_*_*.txt" -Recurse).Count)"
Write-Host "目录结构:"
Get-ChildItem $ExternalDir -Recurse | Out-String
```

## 更新日志

- **2025-09-26**: 实现外部文件夹支持功能
- **2025-09-26**: 添加双重策略和详细日志
- **2025-09-26**: 完善配置说明和部署指南