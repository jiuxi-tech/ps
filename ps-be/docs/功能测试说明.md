# API接口管理功能 - 功能测试说明

## 1. 测试环境准备

### 1.1 后端环境
- 启动Spring Boot应用 (端口: 8082)
- 确保数据库连接正常
- 执行数据库初始化脚本 (创建4张表 + 初始API清单数据)

### 1.2 前端环境
- 启动Vue开发服务器 (端口: 10801)
- 确保路由已正确注册
- 确保service已正确配置

### 1.3 测试数据准备
- 准备测试用户数据 (tp_person_basicinfo表)
- 准备测试部门数据 (tp_dept表)

## 2. 功能测试用例

### 2.1 应用管理 - 列表查询

**测试步骤：**
1. 登录中台系统
2. 访问菜单: 系统管理 > 第三方应用管理
3. 查看应用列表

**预期结果：**
- 页面正常加载
- 显示查询条件: 应用名称、应用编码、状态
- 显示操作按钮: 新增应用
- 表格显示列: 应用名称、应用编码、API Key（脱敏）、状态、IP白名单、过期时间、创建人、创建时间
- 每行显示操作按钮: 编辑、权限配置、查看密钥、启用/禁用、删除

**测试条件查询：**
- 输入应用名称，点击查询
- 选择状态(启用/禁用)，点击查询
- 验证查询结果符合条件

---

### 2.2 应用管理 - 新增应用

**测试步骤：**
1. 点击"新增应用"按钮
2. 填写表单:
   - 应用名称: 测试应用1
   - 应用编码: TEST_APP_001
   - 状态: 启用
   - IP白名单: 192.168.1.100,192.168.1.101
   - 过期时间: 2025-12-31 23:59:59
   - 应用描述: 这是一个测试应用
3. 点击"保存"按钮

**预期结果：**
- 表单验证通过（应用名称、应用编码必填）
- 保存成功提示
- 弹出密钥信息窗口，显示API Key和API Secret（**仅此一次显示**）
- 复制并保存API Key和API Secret
- 列表自动刷新，显示新增的应用
- API Key显示为脱敏格式（前8位+****+后4位）

**边界测试：**
- 应用编码重复: 提示"应用编码已存在"
- 必填项为空: 提示"请填写必填项"
- 过期时间留空: 默认永不过期

---

### 2.3 应用管理 - 编辑应用

**测试步骤：**
1. 点击某个应用的"编辑"按钮
2. 修改应用信息:
   - 应用名称: 测试应用1（修改后）
   - IP白名单: 192.168.1.100,192.168.1.101,192.168.1.102
   - 应用描述: 修改描述
3. 点击"保存"按钮

**预期结果：**
- 表单回显原有数据
- 保存成功提示
- 列表自动刷新，显示修改后的信息
- **注意**: API Key和API Secret不可编辑

---

### 2.4 应用管理 - 查看密钥

**测试步骤：**
1. 点击某个应用的"查看密钥"按钮
2. 点击"显示密钥"按钮（弹出确认框）
3. 确认显示

**预期结果：**
- 显示API Key（完整）
- 显示密钥说明: "由于安全原因，已加密的密钥无法查看原文，请重新生成新密钥"
- 提供"复制"按钮
- 提供"重新生成密钥"按钮

**测试重新生成密钥：**
1. 点击"重新生成密钥"按钮
2. 确认操作
3. 查看新生成的密钥信息

**预期结果：**
- 弹出新密钥显示窗口（仅显示一次）
- API Key保持不变
- API Secret已更新（新值）
- 旧的API Secret立即失效

---

### 2.5 应用管理 - 权限配置

**测试步骤：**
1. 点击某个应用的"权限配置"按钮
2. 查看API清单列表
3. 勾选部分API（例如: 根据ID查询用户）
4. 点击"保存"按钮

**预期结果：**
- 显示所有可用的API清单
- 显示列: 授权复选框、API名称、请求方法、API路径、接口描述
- 请求方法显示不同颜色标签（GET-蓝色、POST-绿色、PUT-橙色、DELETE-红色）
- 回显已授权的API（复选框已勾选）
- 提供"全选/取消全选"功能
- 保存成功提示

**测试权限验证：**
- 后续使用该应用的API Key调用API时，只能访问已授权的接口
- 访问未授权的接口应返回403错误

---

### 2.6 应用管理 - 启用/禁用应用

**测试步骤：**
1. 点击某个应用的"禁用"按钮
2. 确认操作
3. 查看应用状态变化
4. 再次点击"启用"按钮

**预期结果：**
- 禁用成功: 状态显示为"禁用"（红色）
- 启用成功: 状态显示为"启用"（绿色）
- 禁用后的应用无法调用API（返回403错误）

---

### 2.7 应用管理 - 删除应用

**测试步骤：**
1. 点击某个应用的"删除"按钮
2. 确认删除操作

**预期结果：**
- 弹出确认提示: "确定要删除该应用吗？删除后将无法恢复！"
- 删除成功提示
- 列表自动刷新，该应用消失
- 数据库中logDelete字段标记为1（逻辑删除）
- 该应用的API Key立即失效

---

### 2.8 应用管理 - 查看应用详情

**测试步骤：**
1. 点击应用名称链接
2. 查看应用详细信息

**预期结果：**
- 以只读形式显示所有应用信息
- 显示创建人、创建时间、修改人、修改时间
- 提供"关闭"按钮

---

## 3. 开放API测试

### 3.1 API Key认证测试

**测试用例1: 有效API Key**
```bash
curl -X GET "http://localhost:8082/open-api/v1/users/2024112900000001" \
  -H "Authorization: Bearer {有效的API-Key}"
```

**预期结果：**
- 返回200状态码
- 返回脱敏后的用户信息
- 记录API调用日志

---

**测试用例2: 无效API Key**
```bash
curl -X GET "http://localhost:8082/open-api/v1/users/2024112900000001" \
  -H "Authorization: Bearer invalid-api-key"
```

**预期结果：**
- 返回401状态码
- 返回错误信息: "Invalid API Key"

---

**测试用例3: 缺少API Key**
```bash
curl -X GET "http://localhost:8082/open-api/v1/users/2024112900000001"
```

**预期结果：**
- 返回401状态码
- 返回错误信息: "API Key is required"

---

### 3.2 IP白名单测试

**测试步骤：**
1. 创建一个应用，设置IP白名单: 192.168.1.100
2. 从白名单内IP访问API
3. 从白名单外IP访问API

**预期结果：**
- 白名单内IP: 访问成功
- 白名单外IP: 返回403，提示"IP地址不在白名单中"

---

### 3.3 应用状态测试

**测试步骤：**
1. 禁用应用
2. 使用该应用的API Key访问API

**预期结果：**
- 返回403状态码
- 返回错误信息: "应用已禁用"

---

### 3.4 应用过期测试

**测试步骤：**
1. 创建一个已过期的应用（过期时间设置为过去）
2. 使用该应用的API Key访问API

**预期结果：**
- 返回403状态码
- 返回错误信息: "应用已过期"

---

### 3.5 API权限测试

**测试步骤：**
1. 为应用A只授权"根据ID查询用户"接口
2. 使用应用A的API Key访问"根据ID查询用户"接口 ✓
3. 使用应用A的API Key访问"分页查询用户列表"接口 ✗

**预期结果：**
- 访问已授权接口: 成功
- 访问未授权接口: 返回403，提示"无权限访问该API"

---

### 3.6 数据脱敏测试

**测试步骤：**
1. 准备测试数据:
   - 姓名: 张三
   - 工号: E001234501
   - 手机号: 13812345678
   - 邮箱: zhangsan@example.com
   - 身份证: 330102199001011234
2. 调用开放API获取用户信息

**预期结果：**
- 姓名: 张*
- 工号: E0****01
- 手机号: 138****5678
- 邮箱: z***n@example.com
- 身份证: 330102********1234

**复姓测试：**
- 原始姓名: 欧阳峰
- 脱敏后: 欧阳*

---

### 3.7 分页查询测试

**测试步骤：**
```bash
curl -X GET "http://localhost:8082/open-api/v1/users?deptId=dept001&page=1&size=10" \
  -H "Authorization: Bearer {API-Key}"
```

**预期结果：**
- 返回分页数据
- 包含total、size、current、pages字段
- records数组包含脱敏后的用户列表

**边界测试：**
- page=0: 自动调整为1
- size超大: 限制最大值
- deptId不存在: 返回空列表

---

## 4. API调用日志测试

### 4.1 日志记录测试

**测试步骤：**
1. 使用API Key调用任意开放API
2. 访问日志查询接口: `/pc/api-call-log/list`

**预期结果：**
- 成功记录API调用日志
- 日志包含以下信息:
  - 应用ID
  - API ID
  - 请求路径
  - 请求方法
  - 请求参数
  - 响应状态码
  - 响应时间
  - IP地址
  - 调用时间

---

### 4.2 异步日志测试

**测试步骤：**
1. 连续快速调用API（例如100次）
2. 检查日志记录情况

**预期结果：**
- 所有调用都成功记录日志
- 异步记录不影响API响应速度
- 无日志丢失

---

## 5. 性能测试建议

### 5.1 并发测试
- 模拟多个应用同时调用API
- 验证系统在高并发下的稳定性

### 5.2 压力测试
- 单个应用高频调用API
- 观察系统资源使用情况

### 5.3 数据量测试
- 大数据量分页查询
- 验证查询性能

---

## 6. 测试检查清单

- [ ] 应用管理 - 列表查询
- [ ] 应用管理 - 新增应用
- [ ] 应用管理 - 编辑应用
- [ ] 应用管理 - 查看密钥
- [ ] 应用管理 - 重新生成密钥
- [ ] 应用管理 - 权限配置
- [ ] 应用管理 - 启用/禁用
- [ ] 应用管理 - 删除应用
- [ ] 应用管理 - 查看详情
- [ ] API认证 - 有效API Key
- [ ] API认证 - 无效API Key
- [ ] API认证 - 缺少API Key
- [ ] IP白名单验证
- [ ] 应用状态验证（禁用）
- [ ] 应用过期验证
- [ ] API权限验证
- [ ] 数据脱敏 - 姓名
- [ ] 数据脱敏 - 工号
- [ ] 数据脱敏 - 手机号
- [ ] 数据脱敏 - 邮箱
- [ ] 数据脱敏 - 身份证
- [ ] 分页查询功能
- [ ] API调用日志记录
- [ ] 异步日志性能

---

## 7. 已知问题和注意事项

1. **密钥显示时机**: API Secret仅在新增和重新生成时显示一次，务必提醒用户保存
2. **IP白名单格式**: 多个IP用英文逗号分隔，需验证格式正确性
3. **时间格式**: 数据库时间格式为VARCHAR(14) yyyyMMddHHmmss，前端需正确转换
4. **逻辑删除**: 删除操作为逻辑删除，数据库记录仍存在
5. **API权限**: 新增应用后默认无任何API权限，需手动配置

---

**文档版本**: v1.0  
**最后更新**: 2024-11-30  
**测试人员**: ___________  
**测试日期**: ___________
