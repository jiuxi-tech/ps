# PS-BE Moduleæ¨¡å—é‡æ„æµ‹è¯•è¯¦ç»†æŒ‡å—

## æ–‡æ¡£æ¦‚è¿°

æœ¬æµ‹è¯•æŒ‡å—ä¸ã€Šæ¨¡å—ç»†ç²’åº¦çš„ä¼˜åŒ–è®¡åˆ’.mdã€‹ç›¸å¯¹åº”ï¼Œä¸ºæ¯ä¸ªé‡æ„é˜¶æ®µæä¾›è¯¦ç»†çš„æµ‹è¯•ç­–ç•¥ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡å’Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬æŒ‡å¯¼ã€‚ç¡®ä¿é‡æ„è¿‡ç¨‹ä¸­åŠŸèƒ½ç¨³å®šæ€§å’Œä»£ç è´¨é‡ã€‚

## æµ‹è¯•åŸåˆ™ä¸ç­–ç•¥

### æ ¸å¿ƒæµ‹è¯•åŸåˆ™

1. **åŠŸèƒ½å›å½’é›¶å®¹å¿**ï¼šä»»ä½•é‡æ„éƒ½ä¸èƒ½ç ´åç°æœ‰åŠŸèƒ½
2. **æµ‹è¯•å…ˆè¡Œ**ï¼šé‡æ„å‰ç¼–å†™æµ‹è¯•ï¼Œé‡æ„åéªŒè¯é€šè¿‡
3. **åˆ†å±‚æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ¥å£æµ‹è¯•å…¨è¦†ç›–
4. **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½è¦æ”¯æŒè‡ªåŠ¨åŒ–æ‰§è¡Œ
5. **æŒç»­éªŒè¯**ï¼šæ¯ä¸ªæäº¤éƒ½è¦é€šè¿‡å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

### æµ‹è¯•åˆ†å±‚ç­–ç•¥

```
æµ‹è¯•é‡‘å­—å¡”ç»“æ„ï¼š
â”œâ”€â”€ E2Eæµ‹è¯• (10%) - ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹æµ‹è¯•
â”œâ”€â”€ é›†æˆæµ‹è¯• (20%) - æ¨¡å—é—´åä½œæµ‹è¯•
â”œâ”€â”€ æ¥å£æµ‹è¯• (30%) - APIå±‚æµ‹è¯•
â””â”€â”€ å•å…ƒæµ‹è¯• (40%) - é¢†åŸŸæ¨¡å‹å’Œä¸šåŠ¡é€»è¾‘æµ‹è¯•
```

## ç¬¬ä¸€é˜¶æ®µï¼šæ¨¡å—æ•´åˆæµ‹è¯•ï¼ˆç¬¬1-2å‘¨ï¼‰

### 1.1 é‡å¤æ¨¡å—æ•´åˆæµ‹è¯•

#### 1.1.1 Systemæ¨¡å—æ•´åˆæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯systemæ¨¡å—åŠŸèƒ½å®Œå…¨è¿ç§»åˆ°sysæ¨¡å—
- ç¡®ä¿æ–°æ—§æ¥å£éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- éªŒè¯æ•°æ®ä¸€è‡´æ€§

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
// ç¤ºä¾‹æµ‹è¯•ç±»ç»“æ„
@TestMethodOrder(OrderAnnotation.class)
@SpringBootTest
class SystemModuleIntegrationTest {
    
    @Test
    @Order(1)
    void testLegacySystemConfigService() {
        // æµ‹è¯•æ—§çš„TpSystemConfigç›¸å…³æ¥å£
    }
    
    @Test
    @Order(2)
    void testNewSystemConfigService() {
        // æµ‹è¯•æ–°çš„SystemConfigç›¸å…³æ¥å£
    }
    
    @Test
    @Order(3)
    void testDataConsistency() {
        // éªŒè¯æ–°æ—§æ¥å£æ“ä½œåŒä¸€æ•°æ®çš„ä¸€è‡´æ€§
    }
    
    @Test
    @Order(4)
    void testAdapterPattern() {
        // æµ‹è¯•é€‚é…å™¨æ¨¡å¼çš„æ­£ç¡®æ€§
    }
}
```

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬æŒ‡å¯¼ï¼š**

1. **æ•°æ®å¯¹æ¯”æµ‹è¯•è„šæœ¬**
   ```bash
   # è„šæœ¬åç§°ï¼šcompare_system_config_data.sh
   # åŠŸèƒ½ï¼šå¯¹æ¯”æ–°æ—§æ¥å£çš„æ•°æ®ä¸€è‡´æ€§
   
   echo "å¼€å§‹ç³»ç»Ÿé…ç½®æ•°æ®ä¸€è‡´æ€§æµ‹è¯•..."
   
   # é€šè¿‡æ—§æ¥å£è·å–é…ç½®åˆ—è¡¨
   OLD_API_RESULT=$(curl -s http://localhost:8080/api/legacy/system/config/list)
   
   # é€šè¿‡æ–°æ¥å£è·å–é…ç½®åˆ—è¡¨
   NEW_API_RESULT=$(curl -s http://localhost:8080/api/sys/config/list)
   
   # å¯¹æ¯”ç»“æœæ•°é‡
   OLD_COUNT=$(echo $OLD_API_RESULT | jq '.data | length')
   NEW_COUNT=$(echo $NEW_API_RESULT | jq '.data | length')
   
   if [ "$OLD_COUNT" -eq "$NEW_COUNT" ]; then
       echo "âœ… æ•°æ®æ•°é‡ä¸€è‡´: $OLD_COUNT"
   else
       echo "âŒ æ•°æ®æ•°é‡ä¸ä¸€è‡´: æ—§æ¥å£ $OLD_COUNT, æ–°æ¥å£ $NEW_COUNT"
       exit 1
   fi
   
   echo "ç³»ç»Ÿé…ç½®æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å®Œæˆ"
   ```

2. **åŠŸèƒ½å›å½’æµ‹è¯•è„šæœ¬**
   ```bash
   # è„šæœ¬åç§°ï¼šsystem_module_regression_test.sh
   # åŠŸèƒ½ï¼šéªŒè¯ç³»ç»Ÿé…ç½®æ¨¡å—æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
   
   echo "å¼€å§‹ç³»ç»Ÿé…ç½®æ¨¡å—å›å½’æµ‹è¯•..."
   
   # æµ‹è¯•é…ç½®æŸ¥è¯¢åŠŸèƒ½
   CONFIG_QUERY_RESULT=$(curl -s -o /dev/null -w "%{http_code}" \
       http://localhost:8080/api/sys/config/get?key=test.config)
   
   if [ "$CONFIG_QUERY_RESULT" -eq 200 ]; then
       echo "âœ… é…ç½®æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸"
   else
       echo "âŒ é…ç½®æŸ¥è¯¢åŠŸèƒ½å¼‚å¸¸: HTTP $CONFIG_QUERY_RESULT"
       exit 1
   fi
   
   # æµ‹è¯•é…ç½®æ›´æ–°åŠŸèƒ½
   UPDATE_RESULT=$(curl -s -X PUT \
       -H "Content-Type: application/json" \
       -d '{"configKey":"test.config","configValue":"test_value","configName":"æµ‹è¯•é…ç½®"}' \
       -o /dev/null -w "%{http_code}" \
       http://localhost:8080/api/sys/config/update)
   
   if [ "$UPDATE_RESULT" -eq 200 ]; then
       echo "âœ… é…ç½®æ›´æ–°åŠŸèƒ½æ­£å¸¸"
   else
       echo "âŒ é…ç½®æ›´æ–°åŠŸèƒ½å¼‚å¸¸: HTTP $UPDATE_RESULT"
       exit 1
   fi
   
   echo "ç³»ç»Ÿé…ç½®æ¨¡å—å›å½’æµ‹è¯•å®Œæˆ"
   ```

#### 1.1.2 Organizationæ¨¡å—æ•´åˆæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯organizationæ¨¡å—åŠŸèƒ½è¿ç§»åˆ°orgæ¨¡å—
- æµ‹è¯•éƒ¨é—¨ã€ä¼ä¸šç®¡ç†åŠŸèƒ½å®Œæ•´æ€§
- éªŒè¯ç»„ç»‡æ¶æ„å±‚çº§å…³ç³»æ­£ç¡®æ€§

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class OrganizationModuleIntegrationTest {
    
    @Test
    void testDepartmentHierarchy() {
        // æµ‹è¯•éƒ¨é—¨å±‚çº§ç»“æ„
        // 1. åˆ›å»ºçˆ¶éƒ¨é—¨
        // 2. åˆ›å»ºå­éƒ¨é—¨
        // 3. éªŒè¯å±‚çº§å…³ç³»
        // 4. éªŒè¯æŸ¥è¯¢ç»“æœ
    }
    
    @Test
    void testEnterpriseManagement() {
        // æµ‹è¯•ä¼ä¸šç®¡ç†åŠŸèƒ½
        // 1. åˆ›å»ºä¼ä¸š
        // 2. æ›´æ–°ä¼ä¸šä¿¡æ¯
        // 3. æŸ¥è¯¢ä¼ä¸šè¯¦æƒ…
        // 4. åˆ é™¤ä¼ä¸š
    }
    
    @Test
    void testCrossModuleIntegration() {
        // æµ‹è¯•è·¨æ¨¡å—é›†æˆ
        // ç»„ç»‡å˜æ›´ â†’ ç”¨æˆ·æ¨¡å—åŒæ­¥
        // ç»„ç»‡å˜æ›´ â†’ æƒé™æ¨¡å—åŒæ­¥
    }
}
```

#### 1.1.3 Authorizationæ¨¡å—æ•´åˆæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯authorizationæ¨¡å—åŠŸèƒ½è¿ç§»åˆ°authæ¨¡å—
- æµ‹è¯•æƒé™æ§åˆ¶å®Œæ•´æ€§
- éªŒè¯è§’è‰²æƒé™åˆ†é…æ­£ç¡®æ€§

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class AuthorizationModuleIntegrationTest {
    
    @Test
    void testRolePermissionBinding() {
        // æµ‹è¯•è§’è‰²æƒé™ç»‘å®š
        // 1. åˆ›å»ºè§’è‰²
        // 2. åˆ†é…æƒé™
        // 3. éªŒè¯æƒé™ç”Ÿæ•ˆ
        // 4. æµ‹è¯•æƒé™æ’¤é”€
    }
    
    @Test
    void testMenuPermissionControl() {
        // æµ‹è¯•èœå•æƒé™æ§åˆ¶
        // 1. é…ç½®èœå•æƒé™
        // 2. ç”¨æˆ·ç™»å½•éªŒè¯
        // 3. èœå•è®¿é—®æµ‹è¯•
        // 4. æƒé™å˜æ›´éªŒè¯
    }
}
```

### 1.2 é€‚é…å™¨å±‚æµ‹è¯•

#### 1.2.1 é€‚é…å™¨åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯é€‚é…å™¨æ­£ç¡®è½¬æ¢æ–°æ—§æ•°æ®æ ¼å¼
- æµ‹è¯•é€‚é…å™¨å¼‚å¸¸å¤„ç†
- éªŒè¯æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**

```bash
# è„šæœ¬åç§°ï¼šadapter_performance_test.sh
# åŠŸèƒ½ï¼šæµ‹è¯•é€‚é…å™¨å±‚æ€§èƒ½

echo "å¼€å§‹é€‚é…å™¨æ€§èƒ½æµ‹è¯•..."

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date +%s%N)

# æ‰¹é‡è°ƒç”¨é€‚é…å™¨æ¥å£
for i in {1..100}; do
    curl -s http://localhost:8080/api/adapter/system/config/list > /dev/null
done

# è®°å½•ç»“æŸæ—¶é—´
END_TIME=$(date +%s%N)

# è®¡ç®—è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
AVG_TIME=$(( DURATION / 100 ))

echo "é€‚é…å™¨å¹³å‡å“åº”æ—¶é—´: ${AVG_TIME}ms"

if [ "$AVG_TIME" -lt 100 ]; then
    echo "âœ… é€‚é…å™¨æ€§èƒ½æµ‹è¯•é€šè¿‡"
else
    echo "âŒ é€‚é…å™¨æ€§èƒ½æµ‹è¯•å¤±è´¥ï¼Œå¹³å‡å“åº”æ—¶é—´è¿‡é•¿"
    exit 1
fi
```

## ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—é‡æ„æµ‹è¯•ï¼ˆç¬¬3-6å‘¨ï¼‰

### 2.1 ç”¨æˆ·æ¨¡å—é‡æ„æµ‹è¯•

#### 2.1.1 é¢†åŸŸæ¨¡å‹æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯Userèšåˆæ ¹æ‹†åˆ†ååŠŸèƒ½æ­£ç¡®
- æµ‹è¯•å€¼å¯¹è±¡éªŒè¯é€»è¾‘
- éªŒè¯é¢†åŸŸäº‹ä»¶å‘å¸ƒæœºåˆ¶

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@ExtendWith(MockitoExtension.class)
class UserDomainModelTest {
    
    @Test
    void testUserAggregateCreation() {
        // æµ‹è¯•ç”¨æˆ·èšåˆæ ¹åˆ›å»º
        UserProfile profile = new UserProfile("å¼ ä¸‰", "ç”·", LocalDate.of(1990, 1, 1));
        User user = User.create("user123", profile, UserCategory.INDIVIDUAL, "admin", "tenant1");
        
        assertThat(user.getPersonId()).isEqualTo("user123");
        assertThat(user.getProfile().getPersonName()).isEqualTo("å¼ ä¸‰");
        assertThat(user.getStatus()).isEqualTo(UserStatus.ACTIVE);
        assertThat(user.hasDomainEvents()).isTrue();
    }
    
    @Test
    void testUserAccountCreation() {
        // æµ‹è¯•ç”¨æˆ·è´¦æˆ·åˆ›å»º
        User user = createTestUser();
        user.createAccount("testuser", "password123", "admin");
        
        assertThat(user.hasAccount()).isTrue();
        assertThat(user.getAccount().getUsername()).isEqualTo("testuser");
        assertThat(user.getDomainEvents()).hasSize(2); // ç”¨æˆ·åˆ›å»º + è´¦æˆ·åˆ›å»ºäº‹ä»¶
    }
    
    @Test
    void testValueObjectValidation() {
        // æµ‹è¯•å€¼å¯¹è±¡éªŒè¯
        assertThatThrownBy(() -> new Email("invalid-email"))
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> new PhoneNumber("123"))
            .isInstanceOf(IllegalArgumentException.class);
    }
    
    @Test
    void testDomainEventPublishing() {
        // æµ‹è¯•é¢†åŸŸäº‹ä»¶å‘å¸ƒ
        User user = createTestUser();
        List<UserEvent> events = user.getDomainEvents();
        
        assertThat(events).hasSize(1);
        assertThat(events.get(0)).isInstanceOf(UserCreatedEvent.class);
        
        UserCreatedEvent event = (UserCreatedEvent) events.get(0);
        assertThat(event.getPersonId()).isEqualTo(user.getPersonId());
    }
}
```

#### 2.1.2 åº”ç”¨æœåŠ¡æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯åº”ç”¨æœåŠ¡äº‹åŠ¡è¾¹ç•Œ
- æµ‹è¯•ä¸šåŠ¡è§„åˆ™éªŒè¯
- éªŒè¯å¼‚å¸¸å¤„ç†æœºåˆ¶

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
@Transactional
class UserApplicationServiceTest {
    
    @Autowired
    private UserApplicationService userApplicationService;
    
    @MockBean
    private UserRepository userRepository;
    
    @Test
    void testCreateUserWithValidData() {
        // æµ‹è¯•æ­£å¸¸ç”¨æˆ·åˆ›å»ºæµç¨‹
        UserCreateDTO createDTO = new UserCreateDTO();
        createDTO.setPersonName("å¼ ä¸‰");
        createDTO.setGender("ç”·");
        createDTO.setBirthDate(LocalDate.of(1990, 1, 1));
        createDTO.setEmail("zhangsan@example.com");
        createDTO.setPhoneNumber("13800138000");
        
        when(userRepository.save(any(User.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));
        
        UserResponseDTO result = userApplicationService.createUser(createDTO, "admin", "tenant1");
        
        assertThat(result).isNotNull();
        assertThat(result.getPersonName()).isEqualTo("å¼ ä¸‰");
        verify(userRepository).save(any(User.class));
    }
    
    @Test
    void testCreateUserWithDuplicateEmail() {
        // æµ‹è¯•é‚®ç®±é‡å¤çš„å¼‚å¸¸å¤„ç†
        UserCreateDTO createDTO = new UserCreateDTO();
        createDTO.setEmail("existing@example.com");
        
        when(userRepository.existsByEmail("existing@example.com"))
            .thenReturn(true);
        
        assertThatThrownBy(() -> 
            userApplicationService.createUser(createDTO, "admin", "tenant1"))
            .isInstanceOf(BusinessException.class)
            .hasMessage("é‚®ç®±å·²å­˜åœ¨");
    }
    
    @Test
    @Rollback
    void testTransactionRollback() {
        // æµ‹è¯•äº‹åŠ¡å›æ»šæœºåˆ¶
        UserCreateDTO createDTO = createValidUserDTO();
        
        when(userRepository.save(any(User.class)))
            .thenThrow(new RuntimeException("æ•°æ®åº“å¼‚å¸¸"));
        
        assertThatThrownBy(() -> 
            userApplicationService.createUser(createDTO, "admin", "tenant1"))
            .isInstanceOf(RuntimeException.class);
        
        // éªŒè¯äº‹åŠ¡å›æ»šåæ•°æ®åº“çŠ¶æ€
        assertThat(userRepository.count()).isZero();
    }
}
```

#### 2.1.3 ä»“å‚¨å±‚æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯æ•°æ®æŒä¹…åŒ–æ­£ç¡®æ€§
- æµ‹è¯•æŸ¥è¯¢æ–¹æ³•å‡†ç¡®æ€§
- éªŒè¯æ•°æ®è½¬æ¢æ— è¯¯

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepositoryImpl userRepository;
    
    @Test
    void testSaveAndFindUser() {
        // æµ‹è¯•ç”¨æˆ·ä¿å­˜å’ŒæŸ¥è¯¢
        User user = createTestUser();
        User savedUser = userRepository.save(user);
        
        Optional<User> foundUser = userRepository.findById(savedUser.getPersonId());
        
        assertThat(foundUser).isPresent();
        assertThat(foundUser.get().getPersonId()).isEqualTo(savedUser.getPersonId());
        assertThat(foundUser.get().getProfile().getPersonName())
            .isEqualTo(savedUser.getProfile().getPersonName());
    }
    
    @Test
    void testFindByEmail() {
        // æµ‹è¯•æŒ‰é‚®ç®±æŸ¥è¯¢
        User user = createTestUser();
        user.getContactInfo().setEmail(new Email("test@example.com"));
        entityManager.persistAndFlush(convertToPO(user));
        
        Optional<User> result = userRepository.findByEmail("test@example.com");
        
        assertThat(result).isPresent();
        assertThat(result.get().getContactInfo().getEmail().getValue())
            .isEqualTo("test@example.com");
    }
    
    @Test
    void testComplexQuery() {
        // æµ‹è¯•å¤æ‚æŸ¥è¯¢
        // åˆ›å»ºå¤šä¸ªæµ‹è¯•ç”¨æˆ·
        List<User> users = createMultipleTestUsers();
        users.forEach(user -> entityManager.persistAndFlush(convertToPO(user)));
        
        // æŒ‰æ¡ä»¶æŸ¥è¯¢
        List<User> activeUsers = userRepository.findByStatusAndTenant(
            UserStatus.ACTIVE, "tenant1");
        
        assertThat(activeUsers).hasSize(2);
        assertThat(activeUsers).allMatch(user -> user.isActive());
    }
}
```

### 2.2 æƒé™æ¨¡å—é‡æ„æµ‹è¯•

#### 2.2.1 RBACæ¨¡å‹æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯è§’è‰²æƒé™åˆ†é…æœºåˆ¶
- æµ‹è¯•æƒé™ç»§æ‰¿é€»è¾‘
- éªŒè¯æ•°æ®æƒé™æ§åˆ¶

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class RBACModelTest {
    
    @Test
    void testRolePermissionAssignment() {
        // æµ‹è¯•è§’è‰²æƒé™åˆ†é…
        Role adminRole = new Role("ADMIN", "ç®¡ç†å‘˜", RoleType.SYSTEM);
        Permission userManagePermission = new Permission(
            "USER_MANAGE", "ç”¨æˆ·ç®¡ç†", PermissionType.OPERATION);
        
        adminRole.assignPermission(userManagePermission);
        
        assertThat(adminRole.hasPermission("USER_MANAGE")).isTrue();
        assertThat(adminRole.getPermissions()).contains(userManagePermission);
    }
    
    @Test
    void testDataPermissionControl() {
        // æµ‹è¯•æ•°æ®æƒé™æ§åˆ¶
        Role deptManagerRole = new Role("DEPT_MANAGER", "éƒ¨é—¨ç»ç†", RoleType.BUSINESS);
        DataPermission dataPermission = new DataPermission(
            DataScope.DEPARTMENT, "dept123");
        
        deptManagerRole.assignDataPermission(dataPermission);
        
        assertThat(deptManagerRole.canAccessData("dept123")).isTrue();
        assertThat(deptManagerRole.canAccessData("dept456")).isFalse();
    }
    
    @Test
    void testPermissionInheritance() {
        // æµ‹è¯•æƒé™ç»§æ‰¿
        Role parentRole = new Role("PARENT", "çˆ¶è§’è‰²", RoleType.SYSTEM);
        Role childRole = new Role("CHILD", "å­è§’è‰²", RoleType.BUSINESS);
        
        Permission permission = new Permission("TEST_PERM", "æµ‹è¯•æƒé™", PermissionType.OPERATION);
        parentRole.assignPermission(permission);
        childRole.setParentRole(parentRole);
        
        assertThat(childRole.hasEffectivePermission("TEST_PERM")).isTrue();
    }
}
```

#### 2.2.2 æƒé™ç¼“å­˜æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯æƒé™ç¼“å­˜æœºåˆ¶
- æµ‹è¯•ç¼“å­˜æ›´æ–°ç­–ç•¥
- éªŒè¯ç¼“å­˜ä¸€è‡´æ€§

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class PermissionCacheTest {
    
    @Autowired
    private PermissionCacheService permissionCacheService;
    
    @Test
    void testPermissionCaching() {
        // æµ‹è¯•æƒé™ç¼“å­˜
        String userId = "user123";
        Set<String> permissions = Set.of("USER_READ", "USER_WRITE");
        
        // ç¼“å­˜æƒé™
        permissionCacheService.cacheUserPermissions(userId, permissions);
        
        // éªŒè¯ç¼“å­˜å‘½ä¸­
        Optional<Set<String>> cachedPermissions = 
            permissionCacheService.getUserPermissions(userId);
        
        assertThat(cachedPermissions).isPresent();
        assertThat(cachedPermissions.get()).containsExactlyInAnyOrderElementsOf(permissions);
    }
    
    @Test
    void testCacheInvalidation() {
        // æµ‹è¯•ç¼“å­˜å¤±æ•ˆ
        String userId = "user123";
        permissionCacheService.cacheUserPermissions(userId, Set.of("USER_READ"));
        
        // ç”¨æˆ·æƒé™å˜æ›´ï¼Œæ¸…é™¤ç¼“å­˜
        permissionCacheService.evictUserPermissions(userId);
        
        Optional<Set<String>> cachedPermissions = 
            permissionCacheService.getUserPermissions(userId);
        
        assertThat(cachedPermissions).isEmpty();
    }
}
```

### 2.3 ç³»ç»Ÿé…ç½®æ¨¡å—é‡æ„æµ‹è¯•

#### 2.3.1 é…ç½®ç®¡ç†æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯é…ç½®çƒ­æ›´æ–°æœºåˆ¶
- æµ‹è¯•é…ç½®éªŒè¯æ¡†æ¶
- éªŒè¯é…ç½®åˆ†ç»„ç®¡ç†

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class SystemConfigManagementTest {
    
    @Test
    void testConfigHotReload() {
        // æµ‹è¯•é…ç½®çƒ­æ›´æ–°
        String configKey = "test.hot.reload";
        String oldValue = "old_value";
        String newValue = "new_value";
        
        // è®¾ç½®åˆå§‹é…ç½®
        systemConfigService.setConfigValue(configKey, oldValue);
        assertThat(systemConfigService.getConfigValue(configKey)).isEqualTo(oldValue);
        
        // æ›´æ–°é…ç½®å¹¶è§¦å‘çƒ­æ›´æ–°
        systemConfigService.updateConfigValue(configKey, newValue);
        systemConfigService.triggerHotReload(configKey);
        
        // éªŒè¯é…ç½®å·²æ›´æ–°
        assertThat(systemConfigService.getConfigValue(configKey)).isEqualTo(newValue);
    }
    
    @Test
    void testConfigValidation() {
        // æµ‹è¯•é…ç½®éªŒè¯
        SystemConfigCreateDTO invalidConfig = new SystemConfigCreateDTO();
        invalidConfig.setConfigKey(""); // ç©ºé”®å€¼
        invalidConfig.setConfigValue("invalid_json{"); // æ— æ•ˆJSON
        invalidConfig.setDataType("JSON");
        
        assertThatThrownBy(() -> 
            systemConfigService.createSystemConfig(invalidConfig, "admin"))
            .isInstanceOf(ValidationException.class);
    }
    
    @Test
    void testConfigGrouping() {
        // æµ‹è¯•é…ç½®åˆ†ç»„
        // åˆ›å»ºä¸åŒç»„çš„é…ç½®
        createConfigInGroup("database", "db.host", "localhost");
        createConfigInGroup("database", "db.port", "3306");
        createConfigInGroup("cache", "cache.ttl", "300");
        
        // æŒ‰ç»„æŸ¥è¯¢é…ç½®
        List<SystemConfig> dbConfigs = 
            systemConfigService.getConfigsByGroup("database");
        List<SystemConfig> cacheConfigs = 
            systemConfigService.getConfigsByGroup("cache");
        
        assertThat(dbConfigs).hasSize(2);
        assertThat(cacheConfigs).hasSize(1);
    }
}
```

## ç¬¬ä¸‰é˜¶æ®µï¼šæ¨¡å—é—´åä½œæµ‹è¯•ï¼ˆç¬¬7-8å‘¨ï¼‰

### 3.1 äº‹ä»¶é©±åŠ¨æ¶æ„æµ‹è¯•

#### 3.1.1 é¢†åŸŸäº‹ä»¶æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯äº‹ä»¶å‘å¸ƒæœºåˆ¶
- æµ‹è¯•äº‹ä»¶å¤„ç†é€»è¾‘
- éªŒè¯è·¨æ¨¡å—äº‹ä»¶ä¼ æ’­

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
class DomainEventTest {
    
    @Autowired
    private DomainEventBus domainEventBus;
    
    @EventListener
    static class TestEventHandler {
        private final List<DomainEvent> handledEvents = new ArrayList<>();
        
        @EventListener
        public void handle(UserCreatedEvent event) {
            handledEvents.add(event);
        }
        
        public List<DomainEvent> getHandledEvents() {
            return handledEvents;
        }
    }
    
    @Test
    void testEventPublishing() {
        // æµ‹è¯•äº‹ä»¶å‘å¸ƒ
        UserCreatedEvent event = new UserCreatedEvent(
            "user123", "å¼ ä¸‰", UserCategory.INDIVIDUAL, "admin", "tenant1");
        
        domainEventBus.publish(event);
        
        // ç­‰å¾…äº‹ä»¶å¤„ç†
        await().atMost(Duration.ofSeconds(5))
            .until(() -> testEventHandler.getHandledEvents().size() > 0);
        
        assertThat(testEventHandler.getHandledEvents()).hasSize(1);
    }
    
    @Test
    void testCrossModuleEventPropagation() {
        // æµ‹è¯•è·¨æ¨¡å—äº‹ä»¶ä¼ æ’­
        // ç”¨æˆ·åˆ›å»º â†’ æƒé™æ¨¡å—åˆ›å»ºé»˜è®¤è§’è‰²
        UserCreatedEvent userEvent = new UserCreatedEvent(
            "user123", "å¼ ä¸‰", UserCategory.INDIVIDUAL, "admin", "tenant1");
        
        domainEventBus.publish(userEvent);
        
        // éªŒè¯æƒé™æ¨¡å—æ¥æ”¶åˆ°äº‹ä»¶å¹¶å¤„ç†
        await().atMost(Duration.ofSeconds(5))
            .until(() -> roleRepository.findByUserId("user123").isPresent());
        
        Optional<Role> defaultRole = roleRepository.findByUserId("user123");
        assertThat(defaultRole).isPresent();
        assertThat(defaultRole.get().getRoleType()).isEqualTo(RoleType.DEFAULT);
    }
}
```

#### 3.1.2 é›†æˆäº‹ä»¶æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯æ¨¡å—é—´é›†æˆäº‹ä»¶
- æµ‹è¯•äº‹ä»¶æ¶ˆæ¯æ ¼å¼
- éªŒè¯äº‹ä»¶å¯é æ€§æŠ•é€’

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**

```bash
# è„šæœ¬åç§°ï¼šintegration_event_test.sh
# åŠŸèƒ½ï¼šæµ‹è¯•é›†æˆäº‹ä»¶å¤„ç†

echo "å¼€å§‹é›†æˆäº‹ä»¶æµ‹è¯•..."

# å‘é€ç”¨æˆ·åˆ›å»ºäº‹ä»¶
USER_CREATE_RESPONSE=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "personName": "æµ‹è¯•ç”¨æˆ·",
        "email": "test@example.com",
        "deptId": "dept123"
    }' \
    http://localhost:8080/api/user/create)

USER_ID=$(echo $USER_CREATE_RESPONSE | jq -r '.data.personId')

# ç­‰å¾…äº‹ä»¶å¤„ç†
sleep 2

# éªŒè¯æƒé™æ¨¡å—æ˜¯å¦æ¥æ”¶åˆ°äº‹ä»¶
ROLE_RESPONSE=$(curl -s http://localhost:8080/api/auth/role/user/$USER_ID)
ROLE_COUNT=$(echo $ROLE_RESPONSE | jq '.data | length')

if [ "$ROLE_COUNT" -gt 0 ]; then
    echo "âœ… ç”¨æˆ·åˆ›å»ºäº‹ä»¶å¤„ç†æˆåŠŸï¼Œå·²åˆ†é…é»˜è®¤è§’è‰²"
else
    echo "âŒ ç”¨æˆ·åˆ›å»ºäº‹ä»¶å¤„ç†å¤±è´¥ï¼Œæœªåˆ†é…é»˜è®¤è§’è‰²"
    exit 1
fi

# éªŒè¯ç»„ç»‡æ¨¡å—æ˜¯å¦æ¥æ”¶åˆ°äº‹ä»¶
ORG_RESPONSE=$(curl -s http://localhost:8080/api/org/department/dept123/members)
MEMBER_EXISTS=$(echo $ORG_RESPONSE | jq --arg uid "$USER_ID" '.data[] | select(.personId == $uid) | length')

if [ "$MEMBER_EXISTS" -gt 0 ]; then
    echo "âœ… ç”¨æˆ·éƒ¨é—¨å…³è”äº‹ä»¶å¤„ç†æˆåŠŸ"
else
    echo "âŒ ç”¨æˆ·éƒ¨é—¨å…³è”äº‹ä»¶å¤„ç†å¤±è´¥"
    exit 1
fi

echo "é›†æˆäº‹ä»¶æµ‹è¯•å®Œæˆ"
```

### 3.2 APIç½‘å…³å±‚æµ‹è¯•

#### 3.2.1 ç»Ÿä¸€æ¥å£æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯APIç½‘å…³è·¯ç”±æ­£ç¡®æ€§
- æµ‹è¯•ç»Ÿä¸€é”™è¯¯å¤„ç†
- éªŒè¯å“åº”æ ¼å¼ä¸€è‡´æ€§

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class ApiGatewayTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @LocalServerPort
    private int port;
    
    @Test
    void testUnifiedResponseFormat() {
        // æµ‹è¯•ç»Ÿä¸€å“åº”æ ¼å¼
        String url = "http://localhost:" + port + "/api/user/list";
        
        ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // éªŒè¯å“åº”æ ¼å¼
        JsonNode jsonResponse = objectMapper.readTree(response.getBody());
        assertThat(jsonResponse.has("code")).isTrue();
        assertThat(jsonResponse.has("message")).isTrue();
        assertThat(jsonResponse.has("data")).isTrue();
        assertThat(jsonResponse.has("timestamp")).isTrue();
    }
    
    @Test
    void testErrorHandling() {
        // æµ‹è¯•ç»Ÿä¸€é”™è¯¯å¤„ç†
        String url = "http://localhost:" + port + "/api/user/999999"; // ä¸å­˜åœ¨çš„ç”¨æˆ·ID
        
        ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
        
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
        
        JsonNode jsonResponse = objectMapper.readTree(response.getBody());
        assertThat(jsonResponse.get("code").asText()).isEqualTo("USER_NOT_FOUND");
        assertThat(jsonResponse.get("message").asText()).contains("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    @Test
    void testCrossModuleRouting() {
        // æµ‹è¯•è·¨æ¨¡å—è·¯ç”±
        String[] endpoints = {
            "/api/user/profile",
            "/api/auth/permissions",
            "/api/org/departments",
            "/api/sys/configs"
        };
        
        for (String endpoint : endpoints) {
            String url = "http://localhost:" + port + endpoint;
            ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
            
            assertThat(response.getStatusCode().is2xxSuccessful())
                .as("Endpoint %s should be accessible", endpoint)
                .isTrue();
        }
    }
}
```

### 3.3 å…±äº«ç»„ä»¶æµ‹è¯•

#### 3.3.1 é€šç”¨ç»„ä»¶æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯åŸºç¡€å®ä½“ç±»åŠŸèƒ½
- æµ‹è¯•é€šç”¨å·¥å…·ç±»
- éªŒè¯å…±äº«å€¼å¯¹è±¡

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
class CommonComponentTest {
    
    @Test
    void testBaseEntity() {
        // æµ‹è¯•åŸºç¡€å®ä½“ç±»
        TestEntity entity = new TestEntity();
        entity.setCreator("admin");
        entity.setCreateTime(LocalDateTime.now());
        
        assertThat(entity.getCreator()).isEqualTo("admin");
        assertThat(entity.getCreateTime()).isNotNull();
        assertThat(entity.getId()).isNotNull(); // è‡ªåŠ¨ç”ŸæˆID
    }
    
    @Test
    void testCommonValueObjects() {
        // æµ‹è¯•é€šç”¨å€¼å¯¹è±¡
        Email email = new Email("test@example.com");
        PhoneNumber phone = new PhoneNumber("13800138000");
        
        assertThat(email.getValue()).isEqualTo("test@example.com");
        assertThat(email.getDomain()).isEqualTo("example.com");
        assertThat(phone.getValue()).isEqualTo("13800138000");
        assertThat(phone.getRegion()).isEqualTo("CN");
    }
    
    @Test
    void testUtilityClasses() {
        // æµ‹è¯•å·¥å…·ç±»
        String result = StringUtils.camelToSnakeCase("userName");
        assertThat(result).isEqualTo("user_name");
        
        boolean isValid = ValidationUtils.isValidEmail("test@example.com");
        assertThat(isValid).isTrue();
        
        LocalDateTime dateTime = DateTimeUtils.parseDateTime("2023-09-13 10:30:00");
        assertThat(dateTime.getYear()).isEqualTo(2023);
    }
}
```

## ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ç­–ç•¥å®Œå–„ï¼ˆç¬¬9-10å‘¨ï¼‰

### 4.1 å•å…ƒæµ‹è¯•å®Œå–„

#### 4.1.1 æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

**è¦†ç›–ç‡ç›®æ ‡ï¼š**
- é¢†åŸŸæ¨¡å‹ï¼š95%ä»¥ä¸Š
- ä¸šåŠ¡é€»è¾‘ï¼š90%ä»¥ä¸Š
- å·¥å…·ç±»ï¼š100%
- æ€»ä½“è¦†ç›–ç‡ï¼š80%ä»¥ä¸Š

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**

```bash
# è„šæœ¬åç§°ï¼štest_coverage_check.sh
# åŠŸèƒ½ï¼šæ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡

echo "å¼€å§‹æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥..."

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn clean test jacoco:report

# æå–è¦†ç›–ç‡æ•°æ®
COVERAGE_FILE="target/site/jacoco/jacoco.xml"

if [ ! -f "$COVERAGE_FILE" ]; then
    echo "âŒ è¦†ç›–ç‡æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# è§£ææ€»ä½“è¦†ç›–ç‡
TOTAL_COVERAGE=$(xmllint --xpath "//report/counter[@type='INSTRUCTION']/@missed" $COVERAGE_FILE | cut -d'"' -f2)
TOTAL_COVERED=$(xmllint --xpath "//report/counter[@type='INSTRUCTION']/@covered" $COVERAGE_FILE | cut -d'"' -f2)

COVERAGE_PERCENT=$(echo "scale=2; $TOTAL_COVERED * 100 / ($TOTAL_COVERED + $TOTAL_COVERAGE)" | bc)

echo "æ€»ä½“æµ‹è¯•è¦†ç›–ç‡: ${COVERAGE_PERCENT}%"

# æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è¦æ±‚
if (( $(echo "$COVERAGE_PERCENT >= 80" | bc -l) )); then
    echo "âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡"
else
    echo "âŒ æµ‹è¯•è¦†ç›–ç‡ä¸è¾¾æ ‡ï¼Œè¦æ±‚80%ä»¥ä¸Š"
    exit 1
fi

# æ£€æŸ¥å„æ¨¡å—è¦†ç›–ç‡
MODULES=("user" "auth" "org" "sys")

for module in "${MODULES[@]}"; do
    MODULE_COVERAGE=$(xmllint --xpath "//package[starts-with(@name,'com.jiuxi.module.$module')]/counter[@type='INSTRUCTION']/@covered" $COVERAGE_FILE | cut -d'"' -f2)
    MODULE_MISSED=$(xmllint --xpath "//package[starts-with(@name,'com.jiuxi.module.$module')]/counter[@type='INSTRUCTION']/@missed" $COVERAGE_FILE | cut -d'"' -f2)
    
    if [ -n "$MODULE_COVERAGE" ] && [ -n "$MODULE_MISSED" ]; then
        MODULE_PERCENT=$(echo "scale=2; $MODULE_COVERAGE * 100 / ($MODULE_COVERAGE + $MODULE_MISSED)" | bc)
        echo "${module}æ¨¡å—è¦†ç›–ç‡: ${MODULE_PERCENT}%"
    fi
done

echo "æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥å®Œæˆ"
```

#### 4.1.2 è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**æµ‹è¯•é‡ç‚¹ï¼š**
- ç©ºå€¼å¤„ç†
- è¾¹ç•Œå€¼éªŒè¯
- å¼‚å¸¸åœºæ™¯è¦†ç›–

**æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿ï¼š**

```java
@ParameterizedTest
@ValueSource(strings = {"", " ", "null"})
void testInvalidStringInputs(String input) {
    // æµ‹è¯•æ— æ•ˆå­—ç¬¦ä¸²è¾“å…¥
    String actualInput = "null".equals(input) ? null : input;
    
    assertThatThrownBy(() -> 
        userService.createUser(actualInput, "valid@email.com"))
        .isInstanceOf(IllegalArgumentException.class);
}

@ParameterizedTest
@ValueSource(ints = {-1, 0, 101, Integer.MAX_VALUE})
void testBoundaryValues(int value) {
    // æµ‹è¯•è¾¹ç•Œå€¼
    if (value < 1 || value > 100) {
        assertThatThrownBy(() -> 
            configService.updatePriority(value))
            .isInstanceOf(IllegalArgumentException.class);
    }
}
```

### 4.2 é›†æˆæµ‹è¯•å®æ–½

#### 4.2.1 æ•°æ®åº“é›†æˆæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯æ•°æ®æŒä¹…åŒ–æ­£ç¡®æ€§
- æµ‹è¯•äº‹åŠ¡ç®¡ç†æœºåˆ¶
- éªŒè¯æ•°æ®ä¸€è‡´æ€§çº¦æŸ

**æµ‹è¯•ç¯å¢ƒé…ç½®ï¼š**

```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
  test:
    database:
      replace: none
```

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
@Testcontainers
@Transactional
class DatabaseIntegrationTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:13")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }
    
    @Test
    void testCrossTableTransaction() {
        // æµ‹è¯•è·¨è¡¨äº‹åŠ¡
        assertThatCode(() -> {
            // åˆ›å»ºç”¨æˆ·
            User user = userService.createUser(createUserDTO());
            
            // åˆ†é…è§’è‰²ï¼ˆåº”è¯¥åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
            roleService.assignRoleToUser(user.getPersonId(), "DEFAULT_ROLE");
            
            // å¦‚æœä»»ä¸€æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡åº”è¯¥å›æ»š
        }).doesNotThrowAnyException();
    }
    
    @Test
    void testDataConstraints() {
        // æµ‹è¯•æ•°æ®çº¦æŸ
        assertThatThrownBy(() -> {
            // å°è¯•åˆ›å»ºé‡å¤é‚®ç®±çš„ç”¨æˆ·
            userService.createUser(createUserDTO("duplicate@email.com"));
            userService.createUser(createUserDTO("duplicate@email.com"));
        }).isInstanceOf(DataIntegrityViolationException.class);
    }
}
```

#### 4.2.2 å¤–éƒ¨æ¥å£é›†æˆæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯ä¸Keycloaké›†æˆ
- æµ‹è¯•å¤–éƒ¨APIè°ƒç”¨
- éªŒè¯æ•°æ®åŒæ­¥æœºåˆ¶

**æµ‹è¯•ç”¨ä¾‹è®¾è®¡ï¼š**

```java
@SpringBootTest
@MockServer
class ExternalIntegrationTest {
    
    @Autowired
    private KeycloakIntegrationService keycloakService;
    
    private MockServerClient mockServer;
    
    @Test
    void testKeycloakUserSync() {
        // æ¨¡æ‹ŸKeycloak APIå“åº”
        mockServer
            .when(request()
                .withMethod("GET")
                .withPath("/auth/admin/realms/master/users"))
            .respond(response()
                .withStatusCode(200)
                .withHeader("Content-Type", "application/json")
                .withBody(createKeycloakUsersResponse()));
        
        // æ‰§è¡ŒåŒæ­¥
        SyncResult result = keycloakService.syncUsers();
        
        assertThat(result.getSuccessCount()).isGreaterThan(0);
        assertThat(result.getFailureCount()).isZero();
    }
    
    @Test
    void testKeycloakConnectionFailure() {
        // æ¨¡æ‹Ÿè¿æ¥å¤±è´¥
        mockServer
            .when(request()
                .withPath("/auth/admin/realms/master/users"))
            .respond(response()
                .withStatusCode(500));
        
        assertThatThrownBy(() -> keycloakService.syncUsers())
            .isInstanceOf(IntegrationException.class);
    }
}
```

### 4.3 APIæ¥å£æµ‹è¯•

#### 4.3.1 RESTful APIæµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- éªŒè¯APIè§„èŒƒç¬¦åˆæ€§
- æµ‹è¯•HTTPçŠ¶æ€ç æ­£ç¡®æ€§
- éªŒè¯è¯·æ±‚å“åº”æ ¼å¼

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**

```bash
# è„šæœ¬åç§°ï¼šapi_contract_test.sh
# åŠŸèƒ½ï¼šAPIå¥‘çº¦æµ‹è¯•

echo "å¼€å§‹APIå¥‘çº¦æµ‹è¯•..."

# æµ‹è¯•ç”¨æˆ·æ¨¡å—API
echo "æµ‹è¯•ç”¨æˆ·API..."

# åˆ›å»ºç”¨æˆ·
CREATE_RESPONSE=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d '{
        "personName": "æµ‹è¯•ç”¨æˆ·",
        "email": "test@example.com",
        "phoneNumber": "13800138000"
    }' \
    -w "%{http_code}" \
    http://localhost:8080/api/user/create)

HTTP_CODE=$(echo $CREATE_RESPONSE | tail -c 4)
RESPONSE_BODY=$(echo $CREATE_RESPONSE | head -c -4)

if [ "$HTTP_CODE" -eq 200 ]; then
    echo "âœ… ç”¨æˆ·åˆ›å»ºAPIæµ‹è¯•é€šè¿‡"
    USER_ID=$(echo $RESPONSE_BODY | jq -r '.data.personId')
else
    echo "âŒ ç”¨æˆ·åˆ›å»ºAPIæµ‹è¯•å¤±è´¥: HTTP $HTTP_CODE"
    echo "å“åº”å†…å®¹: $RESPONSE_BODY"
    exit 1
fi

# æŸ¥è¯¢ç”¨æˆ·
QUERY_RESPONSE=$(curl -s -w "%{http_code}" \
    http://localhost:8080/api/user/$USER_ID)

HTTP_CODE=$(echo $QUERY_RESPONSE | tail -c 4)

if [ "$HTTP_CODE" -eq 200 ]; then
    echo "âœ… ç”¨æˆ·æŸ¥è¯¢APIæµ‹è¯•é€šè¿‡"
else
    echo "âŒ ç”¨æˆ·æŸ¥è¯¢APIæµ‹è¯•å¤±è´¥: HTTP $HTTP_CODE"
    exit 1
fi

# æ›´æ–°ç”¨æˆ·
UPDATE_RESPONSE=$(curl -s -X PUT \
    -H "Content-Type: application/json" \
    -d '{
        "personName": "æ›´æ–°åçš„ç”¨æˆ·å",
        "email": "updated@example.com"
    }' \
    -w "%{http_code}" \
    http://localhost:8080/api/user/$USER_ID)

HTTP_CODE=$(echo $UPDATE_RESPONSE | tail -c 4)

if [ "$HTTP_CODE" -eq 200 ]; then
    echo "âœ… ç”¨æˆ·æ›´æ–°APIæµ‹è¯•é€šè¿‡"
else
    echo "âŒ ç”¨æˆ·æ›´æ–°APIæµ‹è¯•å¤±è´¥: HTTP $HTTP_CODE"
    exit 1
fi

# åˆ é™¤ç”¨æˆ·
DELETE_RESPONSE=$(curl -s -X DELETE \
    -w "%{http_code}" \
    http://localhost:8080/api/user/$USER_ID)

HTTP_CODE=$(echo $DELETE_RESPONSE | tail -c 4)

if [ "$HTTP_CODE" -eq 200 ]; then
    echo "âœ… ç”¨æˆ·åˆ é™¤APIæµ‹è¯•é€šè¿‡"
else
    echo "âŒ ç”¨æˆ·åˆ é™¤APIæµ‹è¯•å¤±è´¥: HTTP $HTTP_CODE"
    exit 1
fi

echo "ç”¨æˆ·APIæµ‹è¯•å®Œæˆ"

# æµ‹è¯•æƒé™æ¨¡å—API
echo "æµ‹è¯•æƒé™API..."

# ç±»ä¼¼çš„æµ‹è¯•é€»è¾‘...

echo "APIå¥‘çº¦æµ‹è¯•å®Œæˆ"
```

#### 4.3.2 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç›®æ ‡ï¼š**
- å»ºç«‹æ€§èƒ½åŸºå‡†çº¿
- éªŒè¯æ¥å£å“åº”æ—¶é—´
- æµ‹è¯•å¹¶å‘å¤„ç†èƒ½åŠ›

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**

```bash
# è„šæœ¬åç§°ï¼šapi_performance_baseline.sh
# åŠŸèƒ½ï¼šå»ºç«‹APIæ€§èƒ½åŸºå‡†

echo "å¼€å§‹APIæ€§èƒ½åŸºå‡†æµ‹è¯•..."

# å®‰è£…å¿…è¦å·¥å…·
if ! command -v wrk &> /dev/null; then
    echo "å®‰è£…wrkå‹æµ‹å·¥å…·..."
    # æ ¹æ®ç³»ç»Ÿå®‰è£…wrk
fi

# å‡†å¤‡æµ‹è¯•æ•°æ®
echo "å‡†å¤‡æµ‹è¯•æ•°æ®..."
curl -s -X POST \
    -H "Content-Type: application/json" \
    -d '{"personName": "å‹æµ‹ç”¨æˆ·", "email": "load@test.com"}' \
    http://localhost:8080/api/user/create > /dev/null

# å•æ¥å£æ€§èƒ½æµ‹è¯•
echo "æµ‹è¯•ç”¨æˆ·æŸ¥è¯¢æ¥å£æ€§èƒ½..."
wrk -t4 -c10 -d30s --latency http://localhost:8080/api/user/list > user_query_result.txt

# è§£æç»“æœ
REQUESTS_PER_SEC=$(grep "Requests/sec:" user_query_result.txt | awk '{print $2}')
AVG_LATENCY=$(grep "Latency" user_query_result.txt | awk '{print $2}')

echo "ç”¨æˆ·æŸ¥è¯¢æ¥å£æ€§èƒ½ï¼š"
echo "  QPS: $REQUESTS_PER_SEC"
echo "  å¹³å‡å»¶è¿Ÿ: $AVG_LATENCY"

# è®¾ç½®æ€§èƒ½åŸºå‡†
MIN_QPS=100
MAX_LATENCY_MS=500

QPS_VALUE=$(echo $REQUESTS_PER_SEC | cut -d'.' -f1)
LATENCY_VALUE=$(echo $AVG_LATENCY | sed 's/ms//')

if [ "$QPS_VALUE" -ge "$MIN_QPS" ]; then
    echo "âœ… QPSè¾¾æ ‡ ($QPS_VALUE >= $MIN_QPS)"
else
    echo "âŒ QPSä¸è¾¾æ ‡ ($QPS_VALUE < $MIN_QPS)"
fi

if (( $(echo "$LATENCY_VALUE <= $MAX_LATENCY_MS" | bc -l) )); then
    echo "âœ… å»¶è¿Ÿè¾¾æ ‡ (${LATENCY_VALUE}ms <= ${MAX_LATENCY_MS}ms)"
else
    echo "âŒ å»¶è¿Ÿè¶…æ ‡ (${LATENCY_VALUE}ms > ${MAX_LATENCY_MS}ms)"
fi

echo "APIæ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"
```

## ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•æ–‡æ¡£ä¸å·¥å…·ï¼ˆç¬¬11-12å‘¨ï¼‰

### 5.1 æµ‹è¯•æ–‡æ¡£ç¼–å†™

#### 5.1.1 æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£æ¨¡æ¿

**æ¨¡æ¿ç»“æ„ï¼š**

```markdown
# æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£

## åŸºæœ¬ä¿¡æ¯
- æµ‹è¯•ç”¨ä¾‹ID: TC_USER_001
- æµ‹è¯•æ¨¡å—: ç”¨æˆ·ç®¡ç†
- æµ‹è¯•åŠŸèƒ½: ç”¨æˆ·åˆ›å»º
- ä¼˜å…ˆçº§: P1
- åˆ›å»ºæ—¥æœŸ: 2023-09-13
- åˆ›å»ºäºº: æµ‹è¯•å·¥ç¨‹å¸ˆ

## æµ‹è¯•ç›®æ ‡
éªŒè¯ç”¨æˆ·åˆ›å»ºåŠŸèƒ½çš„æ­£ç¡®æ€§ï¼ŒåŒ…æ‹¬æ•°æ®éªŒè¯ã€ä¸šåŠ¡è§„åˆ™å’Œå¼‚å¸¸å¤„ç†ã€‚

## å‰ç½®æ¡ä»¶
1. ç³»ç»Ÿå·²å¯åŠ¨
2. æ•°æ®åº“è¿æ¥æ­£å¸¸
3. å…·æœ‰ç”¨æˆ·ç®¡ç†æƒé™

## æµ‹è¯•æ­¥éª¤
1. å‘é€ç”¨æˆ·åˆ›å»ºè¯·æ±‚
2. éªŒè¯è¯·æ±‚å‚æ•°
3. æ‰§è¡Œç”¨æˆ·åˆ›å»ºé€»è¾‘
4. æ£€æŸ¥è¿”å›ç»“æœ

## æµ‹è¯•æ•°æ®
```json
{
    "personName": "å¼ ä¸‰",
    "email": "zhangsan@example.com",
    "phoneNumber": "13800138000",
    "deptId": "dept123"
}
```

## æœŸæœ›ç»“æœ
- HTTPçŠ¶æ€ç : 200
- è¿”å›ç”¨æˆ·ID
- æ•°æ®åº“ä¸­åˆ›å»ºç”¨æˆ·è®°å½•
- è§¦å‘ç”¨æˆ·åˆ›å»ºäº‹ä»¶

## å®é™…ç»“æœ
ï¼ˆå¾…å¡«å†™ï¼‰

## æµ‹è¯•ç»“è®º
ï¼ˆå¾…å¡«å†™ï¼‰
```

#### 5.1.2 ç¼ºé™·æŠ¥å‘Šæ¨¡æ¿

**æ¨¡æ¿ç»“æ„ï¼š**

```markdown
# ç¼ºé™·æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- ç¼ºé™·ID: BUG_001
- å‘ç°æ—¥æœŸ: 2023-09-13
- æŠ¥å‘Šäºº: æµ‹è¯•å·¥ç¨‹å¸ˆ
- ä¸¥é‡ç¨‹åº¦: ä¸¥é‡
- ä¼˜å…ˆçº§: P1
- çŠ¶æ€: æ–°å»º

## ç¼ºé™·æè¿°
åœ¨ç”¨æˆ·åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå½“é‚®ç®±æ ¼å¼æ— æ•ˆæ—¶ï¼Œç³»ç»Ÿè¿”å›500é”™è¯¯è€Œä¸æ˜¯400é”™è¯¯ã€‚

## å¤ç°æ­¥éª¤
1. è®¿é—®ç”¨æˆ·åˆ›å»ºæ¥å£
2. ä¼ å…¥æ— æ•ˆé‚®ç®±æ ¼å¼ "invalid-email"
3. æäº¤è¯·æ±‚

## æœŸæœ›ç»“æœ
- è¿”å›HTTP 400é”™è¯¯
- é”™è¯¯æ¶ˆæ¯æ˜ç¡®æŒ‡å‡ºé‚®ç®±æ ¼å¼æ— æ•ˆ

## å®é™…ç»“æœ
- è¿”å›HTTP 500é”™è¯¯
- é”™è¯¯æ¶ˆæ¯ä¸º"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯"

## ç¯å¢ƒä¿¡æ¯
- æ“ä½œç³»ç»Ÿ: Windows 10
- JDKç‰ˆæœ¬: 17
- åº”ç”¨ç‰ˆæœ¬: 1.0.0-SNAPSHOT

## é™„ä»¶
- é”™è¯¯æ—¥å¿—æ–‡ä»¶
- è¯·æ±‚å“åº”æˆªå›¾
```

### 5.2 æµ‹è¯•å·¥å…·å¼€å‘

#### 5.2.1 æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·

**å·¥å…·åŠŸèƒ½ï¼š**
- è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨æˆ·æ•°æ®
- åˆ›å»ºæµ‹è¯•ç»„ç»‡æ¶æ„
- ç”Ÿæˆæƒé™æµ‹è¯•æ•°æ®

**å®ç°ç¤ºä¾‹ï¼š**

```java
@Component
public class TestDataGenerator {
    
    public List<UserCreateDTO> generateUsers(int count) {
        List<UserCreateDTO> users = new ArrayList<>();
        
        for (int i = 1; i <= count; i++) {
            UserCreateDTO user = new UserCreateDTO();
            user.setPersonName("æµ‹è¯•ç”¨æˆ·" + i);
            user.setEmail("user" + i + "@test.com");
            user.setPhoneNumber("1380013800" + String.format("%02d", i % 100));
            user.setGender(i % 2 == 0 ? "ç”·" : "å¥³");
            user.setBirthDate(LocalDate.of(1990 + (i % 30), (i % 12) + 1, (i % 28) + 1));
            
            users.add(user);
        }
        
        return users;
    }
    
    public List<DepartmentCreateDTO> generateDepartments(int count) {
        List<DepartmentCreateDTO> departments = new ArrayList<>();
        
        for (int i = 1; i <= count; i++) {
            DepartmentCreateDTO dept = new DepartmentCreateDTO();
            dept.setDeptName("æµ‹è¯•éƒ¨é—¨" + i);
            dept.setDeptCode("TEST_DEPT_" + i);
            dept.setDeptType(DepartmentType.BUSINESS);
            
            departments.add(dept);
        }
        
        return departments;
    }
}
```

#### 5.2.2 æµ‹è¯•æ‰§è¡Œè„šæœ¬

**å…¨é‡æµ‹è¯•è„šæœ¬ï¼š**

```bash
#!/bin/bash
# è„šæœ¬åç§°ï¼šrun_all_tests.sh
# åŠŸèƒ½ï¼šæ‰§è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶

set -e

echo "======================================"
echo "PS-BE æ¨¡å—é‡æ„æµ‹è¯•å¥—ä»¶"
echo "======================================"

# æ£€æŸ¥ç¯å¢ƒ
echo "æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ..."
if ! command -v java &> /dev/null; then
    echo "âŒ Javaç¯å¢ƒæœªå®‰è£…"
    exit 1
fi

if ! command -v mvn &> /dev/null; then
    echo "âŒ Mavenæœªå®‰è£…"
    exit 1
fi

# å¯åŠ¨åº”ç”¨
echo "å¯åŠ¨æµ‹è¯•åº”ç”¨..."
mvn spring-boot:start -Dspring-boot.run.profiles=test &
APP_PID=$!

# ç­‰å¾…åº”ç”¨å¯åŠ¨
echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
for i in {1..30}; do
    if curl -s http://localhost:8080/actuator/health > /dev/null; then
        echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
        break
    fi
    sleep 2
done

# æ‰§è¡Œå•å…ƒæµ‹è¯•
echo "æ‰§è¡Œå•å…ƒæµ‹è¯•..."
mvn test -Dtest="*UnitTest"

# æ‰§è¡Œé›†æˆæµ‹è¯•
echo "æ‰§è¡Œé›†æˆæµ‹è¯•..."
mvn test -Dtest="*IntegrationTest"

# æ‰§è¡ŒAPIæµ‹è¯•
echo "æ‰§è¡ŒAPIæµ‹è¯•..."
./api_contract_test.sh

# æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
echo "æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
./api_performance_baseline.sh

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
echo "ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
mvn jacoco:report

# æ¸…ç†
echo "æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
kill $APP_PID

echo "======================================"
echo "æµ‹è¯•å®Œæˆï¼"
echo "æµ‹è¯•æŠ¥å‘Šä½ç½®: target/site/jacoco/index.html"
echo "======================================"
```

#### 5.2.3 æŒç»­é›†æˆé…ç½®

**Jenkins Pipelineé…ç½®ï¼š**

```groovy
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'feature/module-refactor', url: 'https://github.com/company/ps-be.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('Unit Tests') {
            steps {
                sh 'mvn test -Dtest="*UnitTest"'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                sh 'mvn test -Dtest="*IntegrationTest"'
            }
        }
        
        stage('API Tests') {
            steps {
                sh './scripts/api_contract_test.sh'
            }
        }
        
        stage('Code Coverage') {
            steps {
                sh 'mvn jacoco:report'
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Coverage Report'
                ])
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡'
        }
        failure {
            echo 'âŒ æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        }
    }
}
```

## æµ‹è¯•éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - æ‰€æœ‰ç°æœ‰APIåŠŸèƒ½æ­£å¸¸
   - æ–°å¢åŠŸèƒ½æŒ‰éœ€æ±‚å®ç°
   - ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯å¯ç”¨

2. **æ•°æ®ä¸€è‡´æ€§**
   - æ–°æ—§æ¥å£æ“ä½œåŒä¸€æ•°æ®
   - æ•°æ®è¿ç§»æ— ä¸¢å¤±
   - å…³è”å…³ç³»ä¿æŒæ­£ç¡®

3. **æ€§èƒ½åŸºå‡†**
   - é‡æ„åæ€§èƒ½ä¸é™çº§
   - å…³é”®æ¥å£å“åº”æ—¶é—´ < 500ms
   - å¹¶å‘å¤„ç†èƒ½åŠ›æ»¡è¶³è¦æ±‚

### è´¨é‡éªŒæ”¶æ ‡å‡†

1. **æµ‹è¯•è¦†ç›–ç‡**
   - å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
   - é›†æˆæµ‹è¯•è¦†ç›–ä¸»è¦æµç¨‹
   - APIæµ‹è¯•è¦†ç›–æ‰€æœ‰æ¥å£

2. **ä»£ç è´¨é‡**
   - æ— ä¸¥é‡ä»£ç è´¨é‡é—®é¢˜
   - å¾ªç¯ä¾èµ–æ¸…é›¶
   - ä»£ç å¤æ‚åº¦æ§åˆ¶åœ¨åˆç†èŒƒå›´

3. **ç¨³å®šæ€§**
   - è¿ç»­è¿è¡Œ24å°æ—¶æ— å¼‚å¸¸
   - å†…å­˜æ³„æ¼æ£€æŸ¥é€šè¿‡
   - é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

## æ€»ç»“

æœ¬æµ‹è¯•æŒ‡å—ä¸ºPS-BEæ¨¡å—é‡æ„æä¾›äº†å®Œæ•´çš„æµ‹è¯•ç­–ç•¥å’Œå®æ–½æ–¹æ¡ˆã€‚é€šè¿‡åˆ†é˜¶æ®µã€åˆ†å±‚æ¬¡çš„æµ‹è¯•æ–¹æ³•ï¼Œç¡®ä¿é‡æ„è¿‡ç¨‹ä¸­åŠŸèƒ½ç¨³å®šæ€§å’Œä»£ç è´¨é‡ã€‚

**æµ‹è¯•ä»·å€¼ä½“ç°ï¼š**
- ğŸ›¡ï¸ **é£é™©æ§åˆ¶**ï¼šé€šè¿‡å…¨é¢æµ‹è¯•é™ä½é‡æ„é£é™©
- ğŸ” **è´¨é‡ä¿è¯**ï¼šç¡®ä¿ä»£ç è´¨é‡å’ŒåŠŸèƒ½å®Œæ•´æ€§  
- ğŸš€ **æŒç»­é›†æˆ**ï¼šæ”¯æŒè‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŒç»­äº¤ä»˜
- ğŸ“Š **æ•°æ®é©±åŠ¨**ï¼šé€šè¿‡æµ‹è¯•æ•°æ®æŒ‡å¯¼é‡æ„å†³ç­–
- ğŸ”„ **å›å½’éªŒè¯**ï¼šç¡®ä¿é‡æ„ä¸ç ´åç°æœ‰åŠŸèƒ½