<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiuxi.admin.core.mapper.TpPasswordHistoryMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.jiuxi.admin.core.bean.entity.TpPasswordHistory">
        <id property="historyId" column="HISTORY_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="personId" column="PERSON_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="passwordHash" column="PASSWORD_HASH"/>
        <result property="changeType" column="CHANGE_TYPE"/>
        <result property="changeReason" column="CHANGE_REASON"/>
        <result property="changedBy" column="CHANGED_BY"/>
        <result property="changedByName" column="CHANGED_BY_NAME"/>
        <result property="changeTime" column="CHANGE_TIME"/>
        <result property="ipAddress" column="IP_ADDRESS"/>
        <result property="userAgent" column="USER_AGENT"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="remark" column="REMARK"/>
        <result property="createdTime" column="CREATED_TIME"/>
    </resultMap>

    <!-- VO结果映射 -->
    <resultMap id="VoResultMap" type="com.jiuxi.admin.core.bean.vo.TpPasswordHistoryVO">
        <id property="historyId" column="HISTORY_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="personId" column="PERSON_ID"/>
        <result property="username" column="USERNAME"/>
        <result property="personName" column="PERSON_NAME"/>
        <result property="passwordHash" column="PASSWORD_HASH"/>
        <result property="changeType" column="CHANGE_TYPE"/>
        <result property="changeReason" column="CHANGE_REASON"/>
        <result property="changedBy" column="CHANGED_BY"/>
        <result property="changedByName" column="CHANGED_BY_NAME"/>
        <result property="changeTime" column="CHANGE_TIME"/>
        <result property="ipAddress" column="IP_ADDRESS"/>
        <result property="userAgent" column="USER_AGENT"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="remark" column="REMARK"/>
        <result property="createdTime" column="CREATED_TIME"/>
    </resultMap>

    <!-- 基础查询列 -->
    <sql id="Base_Column_List">
        HISTORY_ID,
        ACCOUNT_ID,
        PERSON_ID,
        USERNAME,
        PASSWORD_HASH,
        CHANGE_TYPE,
        CHANGE_REASON,
        CHANGED_BY,
        CHANGED_BY_NAME,
        CHANGE_TIME,
        IP_ADDRESS,
        USER_AGENT,
        TENANT_ID,
        REMARK,
        CREATED_TIME
    </sql>

    <!-- 查询条件 -->
    <sql id="Query_Where_Clause">
        <where>
            <if test="query.accountId != null and query.accountId != ''">
                AND h.ACCOUNT_ID = #{query.accountId}
            </if>
            <if test="query.personId != null and query.personId != ''">
                AND h.PERSON_ID = #{query.personId}
            </if>
            <if test="query.username != null and query.username != ''">
                AND h.USERNAME LIKE CONCAT('%', #{query.username}, '%')
            </if>
            <if test="query.personName != null and query.personName != ''">
                AND p.PERSON_NAME LIKE CONCAT('%', #{query.personName}, '%')
            </if>
            <if test="query.changeType != null">
                AND h.CHANGE_TYPE = #{query.changeType}
            </if>
            <if test="query.changedByName != null and query.changedByName != ''">
                AND h.CHANGED_BY_NAME LIKE CONCAT('%', #{query.changedByName}, '%')
            </if>
            <if test="query.startTime != null and query.startTime != ''">
                AND h.CHANGE_TIME &gt;= #{query.startTime}
            </if>
            <if test="query.endTime != null and query.endTime != ''">
                AND h.CHANGE_TIME &lt;= #{query.endTime}
            </if>
            <if test="query.tenantId != null and query.tenantId != ''">
                AND h.TENANT_ID = #{query.tenantId}
            </if>
        </where>
    </sql>

    <!-- 分页查询密码历史列表 -->
    <select id="list" resultMap="VoResultMap">
        SELECT
            h.HISTORY_ID,
            h.ACCOUNT_ID,
            h.PERSON_ID,
            h.USERNAME,
            p.PERSON_NAME,
            h.CHANGE_TYPE,
            h.CHANGE_REASON,
            h.CHANGED_BY,
            h.CHANGED_BY_NAME,
            h.CHANGE_TIME,
            h.IP_ADDRESS,
            h.USER_AGENT,
            h.TENANT_ID,
            h.REMARK,
            h.CREATED_TIME
        FROM tp_password_history h
        LEFT JOIN tp_person_basicinfo p ON h.PERSON_ID = p.PERSON_ID
        <include refid="Query_Where_Clause"/>
        ORDER BY h.CHANGE_TIME DESC
        <if test="query.current != null and query.size != null">
            LIMIT #{query.size} OFFSET #{query.current}
        </if>
    </select>

    <!-- 统计记录数 -->
    <select id="count" resultType="int">
        SELECT COUNT(1)
        FROM tp_password_history h
        LEFT JOIN tp_person_basicinfo p ON h.PERSON_ID = p.PERSON_ID
        <include refid="Query_Where_Clause"/>
    </select>

    <!-- 根据ID查询详情 -->
    <select id="view" resultMap="VoResultMap">
        SELECT
            h.HISTORY_ID,
            h.ACCOUNT_ID,
            h.PERSON_ID,
            h.USERNAME,
            p.PERSON_NAME,
            h.PASSWORD_HASH,
            h.CHANGE_TYPE,
            h.CHANGE_REASON,
            h.CHANGED_BY,
            h.CHANGED_BY_NAME,
            h.CHANGE_TIME,
            h.IP_ADDRESS,
            h.USER_AGENT,
            h.TENANT_ID,
            h.REMARK,
            h.CREATED_TIME
        FROM tp_password_history h
        LEFT JOIN tp_person_basicinfo p ON h.PERSON_ID = p.PERSON_ID
        WHERE h.HISTORY_ID = #{historyId}
    </select>

    <!-- 插入密码历史记录 -->
    <insert id="insertHistory">
        INSERT INTO tp_password_history (
            HISTORY_ID,
            ACCOUNT_ID,
            PERSON_ID,
            USERNAME,
            PASSWORD_HASH,
            CHANGE_TYPE,
            CHANGE_REASON,
            CHANGED_BY,
            CHANGED_BY_NAME,
            CHANGE_TIME,
            IP_ADDRESS,
            USER_AGENT,
            TENANT_ID,
            REMARK
        ) VALUES (
            #{record.historyId},
            #{record.accountId},
            #{record.personId},
            #{record.username},
            #{record.passwordHash},
            #{record.changeType},
            #{record.changeReason},
            #{record.changedBy},
            #{record.changedByName},
            #{record.changeTime},
            #{record.ipAddress},
            #{record.userAgent},
            #{record.tenantId},
            #{record.remark}
        )
    </insert>

    <!-- 根据账号ID查询最近N条密码历史 -->
    <select id="selectRecentByAccountId" resultMap="BaseResultMap">
        SELECT
            <include refid="Base_Column_List"/>
        FROM tp_password_history
        WHERE ACCOUNT_ID = #{accountId}
        ORDER BY CHANGE_TIME DESC
        LIMIT #{limit}
    </select>

</mapper>
