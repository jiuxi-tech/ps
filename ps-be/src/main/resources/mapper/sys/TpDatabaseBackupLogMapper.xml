<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jiuxi.admin.core.mapper.TpDatabaseBackupLogMapper">

    <!-- 备份记录表结果映射 -->
    <resultMap type="com.jiuxi.admin.core.bean.entity.TpDatabaseBackupLog" id="tpDatabaseBackupLogMap">
        <result property="backupId" column="BACKUP_ID"/>
        <result property="backupName" column="BACKUP_NAME"/>
        <result property="backupType" column="BACKUP_TYPE"/>
        <result property="backupStatus" column="BACKUP_STATUS"/>
        <result property="databaseName" column="DATABASE_NAME"/>
        <result property="backupFilePath" column="BACKUP_FILE_PATH"/>
        <result property="backupFileName" column="BACKUP_FILE_NAME"/>
        <result property="backupFileSize" column="BACKUP_FILE_SIZE"/>
        <result property="backupStartTime" column="BACKUP_START_TIME"/>
        <result property="backupEndTime" column="BACKUP_END_TIME"/>
        <result property="backupDuration" column="BACKUP_DURATION"/>
        <result property="backupCommand" column="BACKUP_COMMAND"/>
        <result property="errorMessage" column="ERROR_MESSAGE"/>
        <result property="actived" column="ACTIVED"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="creator" column="CREATOR"/>
        <result property="createTime" column="CREATE_TIME"/>
        <result property="updator" column="UPDATOR"/>
        <result property="updateTime" column="UPDATE_TIME"/>
        <result property="extend01" column="EXTEND01"/>
        <result property="extend02" column="EXTEND02"/>
        <result property="extend03" column="EXTEND03"/>
    </resultMap>

    <!-- 备份记录VO结果映射 -->
    <resultMap type="com.jiuxi.admin.core.bean.vo.TpDatabaseBackupLogVO" id="tpDatabaseBackupLogVOMap">
        <result property="backupId" column="BACKUP_ID"/>
        <result property="backupName" column="BACKUP_NAME"/>
        <result property="backupType" column="BACKUP_TYPE"/>
        <result property="backupStatus" column="BACKUP_STATUS"/>
        <result property="databaseName" column="DATABASE_NAME"/>
        <result property="backupFilePath" column="BACKUP_FILE_PATH"/>
        <result property="backupFileName" column="BACKUP_FILE_NAME"/>
        <result property="backupFileSize" column="BACKUP_FILE_SIZE"/>
        <result property="backupStartTime" column="BACKUP_START_TIME"/>
        <result property="backupEndTime" column="BACKUP_END_TIME"/>
        <result property="backupDuration" column="BACKUP_DURATION"/>
        <result property="backupCommand" column="BACKUP_COMMAND"/>
        <result property="errorMessage" column="ERROR_MESSAGE"/>
        <result property="actived" column="ACTIVED"/>
        <result property="tenantId" column="TENANT_ID"/>
        <result property="creator" column="CREATOR"/>
        <result property="createTime" column="CREATE_TIME"/>
        <result property="updator" column="UPDATOR"/>
        <result property="updateTime" column="UPDATE_TIME"/>
        <result property="extend01" column="EXTEND01"/>
        <result property="extend02" column="EXTEND02"/>
        <result property="extend03" column="EXTEND03"/>
        <!-- 显示名称字段 -->
        <result property="backupTypeName" column="BACKUP_TYPE_NAME"/>
        <result property="backupStatusName" column="BACKUP_STATUS_NAME"/>
        <result property="creatorName" column="CREATOR_NAME"/>
        <result property="updatorName" column="UPDATOR_NAME"/>
    </resultMap>

    <!-- 新增备份记录 -->
    <insert id="save" parameterType="com.jiuxi.admin.core.bean.entity.TpDatabaseBackupLog">
        INSERT INTO tp_database_backup_log
            (BACKUP_ID, BACKUP_NAME, BACKUP_TYPE, BACKUP_STATUS, DATABASE_NAME, 
             BACKUP_FILE_PATH, BACKUP_FILE_NAME, BACKUP_FILE_SIZE, BACKUP_START_TIME, 
             BACKUP_END_TIME, BACKUP_DURATION, BACKUP_COMMAND, ERROR_MESSAGE, 
             ACTIVED, TENANT_ID, CREATOR, CREATE_TIME, UPDATOR, UPDATE_TIME, 
             EXTEND01, EXTEND02, EXTEND03)
        VALUES
            (#{backupId}, #{backupName}, #{backupType}, #{backupStatus}, #{databaseName}, 
             #{backupFilePath}, #{backupFileName}, #{backupFileSize}, #{backupStartTime}, 
             #{backupEndTime}, #{backupDuration}, #{backupCommand}, #{errorMessage}, 
             #{actived}, #{tenantId}, #{creator}, #{createTime}, #{updator}, #{updateTime}, 
             #{extend01}, #{extend02}, #{extend03})
    </insert>

    <!-- 更新备份记录 -->
    <update id="update" parameterType="com.jiuxi.admin.core.bean.entity.TpDatabaseBackupLog">
        UPDATE tp_database_backup_log
        <set>
            <if test="null != backupName">BACKUP_NAME = #{backupName},</if>
            <if test="null != backupType">BACKUP_TYPE = #{backupType},</if>
            <if test="null != backupStatus">BACKUP_STATUS = #{backupStatus},</if>
            <if test="null != databaseName">DATABASE_NAME = #{databaseName},</if>
            <if test="null != backupFilePath">BACKUP_FILE_PATH = #{backupFilePath},</if>
            <if test="null != backupFileName">BACKUP_FILE_NAME = #{backupFileName},</if>
            <if test="null != backupFileSize">BACKUP_FILE_SIZE = #{backupFileSize},</if>
            <if test="null != backupStartTime">BACKUP_START_TIME = #{backupStartTime},</if>
            <if test="null != backupEndTime">BACKUP_END_TIME = #{backupEndTime},</if>
            <if test="null != backupDuration">BACKUP_DURATION = #{backupDuration},</if>
            <if test="null != backupCommand">BACKUP_COMMAND = #{backupCommand},</if>
            <if test="null != errorMessage">ERROR_MESSAGE = #{errorMessage},</if>
            <if test="null != actived">ACTIVED = #{actived},</if>
            <if test="null != tenantId">TENANT_ID = #{tenantId},</if>
            <if test="null != updator">UPDATOR = #{updator},</if>
            UPDATE_TIME = NOW()
        </set>
        WHERE BACKUP_ID = #{backupId}
    </update>

    <!-- 分页查询备份记录列表 -->
    <select id="getPage" parameterType="com.jiuxi.admin.core.bean.query.TpDatabaseBackupLogQuery" resultMap="tpDatabaseBackupLogVOMap">
        SELECT 
            l.BACKUP_ID, l.BACKUP_NAME, l.BACKUP_TYPE, l.BACKUP_STATUS, l.DATABASE_NAME,
            l.BACKUP_FILE_PATH, l.BACKUP_FILE_NAME, l.BACKUP_FILE_SIZE, l.BACKUP_START_TIME,
            l.BACKUP_END_TIME, l.BACKUP_DURATION, l.BACKUP_COMMAND, l.ERROR_MESSAGE,
            l.ACTIVED, l.TENANT_ID, l.CREATOR, l.CREATE_TIME, l.UPDATOR, l.UPDATE_TIME,
            l.EXTEND01, l.EXTEND02, l.EXTEND03,
            CASE l.BACKUP_TYPE 
                WHEN 1 THEN '自动备份' 
                WHEN 2 THEN '手动备份' 
                ELSE '未知' 
            END AS BACKUP_TYPE_NAME,
            CASE l.BACKUP_STATUS 
                WHEN 1 THEN '进行中' 
                WHEN 2 THEN '成功' 
                WHEN 3 THEN '失败' 
                ELSE '未知' 
            END AS BACKUP_STATUS_NAME,
            l.CREATOR AS CREATOR_NAME,
            l.UPDATOR AS UPDATOR_NAME
        FROM tp_database_backup_log l
        WHERE l.ACTIVED = 1
        <if test="query.backupName != null and query.backupName != ''">
            AND l.BACKUP_NAME LIKE CONCAT('%', #{query.backupName}, '%')
        </if>
        <if test="query.backupType != null">
            AND l.BACKUP_TYPE = #{query.backupType}
        </if>
        <if test="query.backupStatus != null">
            AND l.BACKUP_STATUS = #{query.backupStatus}
        </if>
        <if test="query.databaseName != null and query.databaseName != ''">
            AND l.DATABASE_NAME = #{query.databaseName}
        </if>
        <if test="query.backupStartTimeBegin != null and query.backupStartTimeBegin != ''">
            AND l.BACKUP_START_TIME >= #{query.backupStartTimeBegin}
        </if>
        <if test="query.backupStartTimeEnd != null and query.backupStartTimeEnd != ''">
            AND l.BACKUP_START_TIME &lt;= #{query.backupStartTimeEnd}
        </if>
        <if test="query.creator != null and query.creator != ''">
            AND l.CREATOR = #{query.creator}
        </if>
        <if test="query.tenantId != null and query.tenantId != ''">
            AND l.TENANT_ID = #{query.tenantId}
        </if>
        ORDER BY l.BACKUP_START_TIME DESC
    </select>

    <!-- 查询备份记录列表 -->
    <select id="getList" parameterType="com.jiuxi.admin.core.bean.query.TpDatabaseBackupLogQuery" resultMap="tpDatabaseBackupLogVOMap">
        SELECT 
            l.BACKUP_ID, l.BACKUP_NAME, l.BACKUP_TYPE, l.BACKUP_STATUS, l.DATABASE_NAME,
            l.BACKUP_FILE_PATH, l.BACKUP_FILE_NAME, l.BACKUP_FILE_SIZE, l.BACKUP_START_TIME,
            l.BACKUP_END_TIME, l.BACKUP_DURATION, l.BACKUP_COMMAND, l.ERROR_MESSAGE,
            l.ACTIVED, l.TENANT_ID, l.CREATOR, l.CREATE_TIME, l.UPDATOR, l.UPDATE_TIME,
            CASE l.BACKUP_TYPE 
                WHEN 1 THEN '自动备份' 
                WHEN 2 THEN '手动备份' 
                ELSE '未知' 
            END AS BACKUP_TYPE_NAME,
            CASE l.BACKUP_STATUS 
                WHEN 1 THEN '进行中' 
                WHEN 2 THEN '成功' 
                WHEN 3 THEN '失败' 
                ELSE '未知' 
            END AS BACKUP_STATUS_NAME
        FROM tp_database_backup_log l
        WHERE l.ACTIVED = 1
        <if test="query.backupName != null and query.backupName != ''">
            AND l.BACKUP_NAME LIKE CONCAT('%', #{query.backupName}, '%')
        </if>
        <if test="query.backupType != null">
            AND l.BACKUP_TYPE = #{query.backupType}
        </if>
        <if test="query.backupStatus != null">
            AND l.BACKUP_STATUS = #{query.backupStatus}
        </if>
        <if test="query.databaseName != null and query.databaseName != ''">
            AND l.DATABASE_NAME = #{query.databaseName}
        </if>
        <if test="query.tenantId != null and query.tenantId != ''">
            AND l.TENANT_ID = #{query.tenantId}
        </if>
        ORDER BY l.BACKUP_START_TIME DESC
    </select>

    <!-- 查看备份记录详情 -->
    <select id="view" parameterType="String" resultMap="tpDatabaseBackupLogVOMap">
        SELECT 
            l.BACKUP_ID, l.BACKUP_NAME, l.BACKUP_TYPE, l.BACKUP_STATUS, l.DATABASE_NAME,
            l.BACKUP_FILE_PATH, l.BACKUP_FILE_NAME, l.BACKUP_FILE_SIZE, l.BACKUP_START_TIME,
            l.BACKUP_END_TIME, l.BACKUP_DURATION, l.BACKUP_COMMAND, l.ERROR_MESSAGE,
            l.ACTIVED, l.TENANT_ID, l.CREATOR, l.CREATE_TIME, l.UPDATOR, l.UPDATE_TIME,
            l.EXTEND01, l.EXTEND02, l.EXTEND03,
            CASE l.BACKUP_TYPE 
                WHEN 1 THEN '自动备份' 
                WHEN 2 THEN '手动备份' 
                ELSE '未知' 
            END AS BACKUP_TYPE_NAME,
            CASE l.BACKUP_STATUS 
                WHEN 1 THEN '进行中' 
                WHEN 2 THEN '成功' 
                WHEN 3 THEN '失败' 
                ELSE '未知' 
            END AS BACKUP_STATUS_NAME
        FROM tp_database_backup_log l
        WHERE l.ACTIVED = 1 AND l.BACKUP_ID = #{backupId}
    </select>

    <!-- 删除备份记录（逻辑删除） -->
    <update id="delete" parameterType="com.jiuxi.admin.core.bean.entity.TpDatabaseBackupLog">
        UPDATE tp_database_backup_log
        SET ACTIVED = 0,
            UPDATOR = #{updator},
            UPDATE_TIME = NOW()
        WHERE BACKUP_ID = #{backupId}
    </update>

    <!-- 查询正在进行中的备份任务 -->
    <select id="getRunningBackups" resultMap="tpDatabaseBackupLogMap">
        SELECT BACKUP_ID, BACKUP_NAME, BACKUP_TYPE, BACKUP_STATUS, DATABASE_NAME,
               BACKUP_START_TIME, CREATOR, CREATE_TIME
        FROM tp_database_backup_log
        WHERE ACTIVED = 1 
          AND BACKUP_STATUS = 1
        <if test="databaseName != null and databaseName != ''">
            AND DATABASE_NAME = #{databaseName}
        </if>
        ORDER BY BACKUP_START_TIME DESC
    </select>

    <!-- 查询最近的备份记录 -->
    <select id="getRecentBackups" resultMap="tpDatabaseBackupLogVOMap">
        SELECT 
            l.BACKUP_ID, l.BACKUP_NAME, l.BACKUP_TYPE, l.BACKUP_STATUS, l.DATABASE_NAME,
            l.BACKUP_FILE_PATH, l.BACKUP_FILE_NAME, l.BACKUP_FILE_SIZE, l.BACKUP_START_TIME,
            l.BACKUP_END_TIME, l.BACKUP_DURATION, l.ERROR_MESSAGE,
            CASE l.BACKUP_TYPE 
                WHEN 1 THEN '自动备份' 
                WHEN 2 THEN '手动备份' 
                ELSE '未知' 
            END AS BACKUP_TYPE_NAME,
            CASE l.BACKUP_STATUS 
                WHEN 1 THEN '进行中' 
                WHEN 2 THEN '成功' 
                WHEN 3 THEN '失败' 
                ELSE '未知' 
            END AS BACKUP_STATUS_NAME
        FROM tp_database_backup_log l
        WHERE l.ACTIVED = 1
        <if test="databaseName != null and databaseName != ''">
            AND l.DATABASE_NAME = #{databaseName}
        </if>
        ORDER BY l.BACKUP_START_TIME DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

</mapper>