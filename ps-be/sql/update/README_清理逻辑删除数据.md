# 清理逻辑删除部门数据脚本包

## 📦 脚本清单

本目录包含以下用于清理 `tp_dept_basicinfo` 表中逻辑删除数据的脚本：

| 文件名 | 用途 | 适用人员 |
|--------|------|----------|
| `clean_deleted_departments.sql` | 完整的分析和清理脚本，包含详细注释 | DBA、开发人员 |
| `clean_deleted_departments_execute.sql` | 快速执行脚本，直接进行清理操作 | 经验丰富的DBA |
| `清理逻辑删除部门数据说明.md` | 详细使用文档和操作指南 | 所有相关人员 |

## 🎯 使用场景

### 何时需要清理逻辑删除数据？

1. **数据库空间紧张**
   - 逻辑删除的记录占用大量存储空间
   - 需要释放磁盘空间

2. **性能优化需求**
   - 表中数据量过大影响查询性能
   - 需要减少无效数据提升查询速度

3. **数据维护要求**
   - 定期清理历史遗留数据
   - 保持数据库整洁

4. **审计合规需要**
   - 按规定时间删除过期数据
   - 符合数据保留政策

## 📋 快速开始

### 方案一：完整分析后清理（推荐）

适合首次使用或需要详细了解数据情况的场景。

```bash
# 1. 查看说明文档
cat 清理逻辑删除部门数据说明.md

# 2. 执行分析脚本
mysql -u用户名 -p数据库名 < clean_deleted_departments.sql

# 3. 根据分析结果决定是否清理
# 4. 修改脚本取消删除部分的注释
# 5. 重新执行脚本完成清理
```

### 方案二：快速清理（仅限有经验的DBA）

适合已经熟悉脚本逻辑的DBA快速执行清理。

```bash
# ⚠️ 执行前确保已备份数据库
mysql -u用户名 -p数据库名 < clean_deleted_departments_execute.sql
```

## ⚠️ 重要提醒

### 执行前必须确认

- [ ] 已完整备份数据库
- [ ] 已在测试环境验证
- [ ] 已获得业务部门审批
- [ ] 了解脚本的删除逻辑
- [ ] 准备好回滚方案

### 安全删除条件

脚本只会删除同时满足以下**所有**条件的部门：

1. ✅ `ACTIVED = 0`（已逻辑删除）
2. ✅ 没有激活的子部门
3. ✅ 没有人员部门关系引用
4. ✅ 没有人员标签关系引用

**不满足条件的部门不会被删除**，确保数据安全。

## 🔍 脚本功能说明

### clean_deleted_departments.sql

**完整分析和清理脚本**

#### 功能模块

1. **步骤1: 数据分析**
   - 统计逻辑删除部门总数
   - 查看逻辑删除部门详情
   - 按删除时间排序展示

2. **步骤2: 引用关系检查**
   - 检查子部门引用情况
   - 检查人员部门关系
   - 检查人员标签关系
   - 详细列出有引用的部门

3. **步骤3: 识别可删除数据**
   - 找出所有可安全删除的部门
   - 统计可删除数量
   - 按删除时间排序

4. **步骤4: 执行物理删除**
   - 备份要删除的数据
   - 执行物理删除操作
   - 验证删除结果

5. **步骤5: 清理孤立数据**
   - 清理孤立的部门扩展信息
   - 优化表结构

#### 使用方式

```sql
-- 1. 先执行分析查询（步骤1-3）
-- 2. 根据分析结果决定是否删除
-- 3. 取消步骤4的注释执行删除
-- 4. 验证结果
```

### clean_deleted_departments_execute.sql

**快速执行脚本**

#### 功能特点

- 自动创建备份表
- 使用事务控制删除
- 需要手动COMMIT确认
- 包含验证和回滚脚本

#### 执行流程

```sql
-- 1. 自动备份到 tp_dept_basicinfo_deleted_backup
-- 2. 开始事务
-- 3. 执行删除
-- 4. 查看影响行数
-- 5. 验证结果
-- 6. 手动 COMMIT 或 ROLLBACK
```

## 📊 执行效果示例

### 执行前数据状态

```
tp_dept_basicinfo 总记录数: 1,250
├── ACTIVED = 1: 1,205 (正常部门)
└── ACTIVED = 0: 45 (逻辑删除)
    ├── 有子部门引用: 5
    ├── 有人员关系: 12
    ├── 有标签关系: 3
    └── 可安全删除: 25
```

### 执行后数据状态

```
tp_dept_basicinfo 总记录数: 1,225
├── ACTIVED = 1: 1,205 (正常部门)
└── ACTIVED = 0: 20 (逻辑删除，有引用)

物理删除数量: 25
备份表记录: 25
空间释放: 约 XXX KB
```

## 🔄 回滚方案

如果需要恢复已删除的数据：

```sql
-- 从备份表恢复所有数据
INSERT INTO tp_dept_basicinfo 
SELECT * FROM tp_dept_basicinfo_deleted_backup;

-- 或恢复特定部门
INSERT INTO tp_dept_basicinfo 
SELECT * FROM tp_dept_basicinfo_deleted_backup
WHERE DEPT_ID = '指定的部门ID';
```

## 📈 性能影响

### 预期性能提升

- **查询速度**: 减少无效数据扫描，查询速度提升 5-10%
- **存储空间**: 释放逻辑删除数据占用的空间
- **索引维护**: 减少索引大小，提升索引效率

### 建议执行频率

- **小型系统**: 每年1-2次
- **中型系统**: 每季度1次
- **大型系统**: 每月1次

根据实际数据增长情况调整。

## 📞 技术支持

### 常见问题

**Q: 脚本会删除所有逻辑删除的部门吗？**

A: 不会。只删除没有任何引用关系的部门，有引用的部门会被保留。

**Q: 如果误删了重要数据怎么办？**

A: 脚本会自动创建备份表，可以从备份表恢复数据。建议执行前也要做全库备份。

**Q: 执行需要多长时间？**

A: 取决于数据量，一般情况下几秒到几分钟。建议先在测试环境测试。

**Q: 会影响系统运行吗？**

A: 删除操作会锁表，建议在业务低峰期执行。使用事务可以随时回滚。

### 联系方式

如遇到问题，请联系：
- 📧 数据库团队: [DBA邮箱]
- 📱 技术支持: [支持电话]
- 💬 开发团队: [开发组邮箱]

## 📚 相关文档

- [数据库维护规范](../docs/数据库维护规范.md)
- [部门数据模型设计](../../refactor/5-analysis/2025-09-17/org/org-数据模型分析.md)
- [数据备份恢复流程](../docs/数据备份恢复流程.md)

## 📝 更新日志

### v1.0.0 (2025-01-27)

- ✨ 初始版本发布
- 📝 完整的分析脚本
- 🚀 快速执行脚本
- 📖 详细使用文档
- ✅ 安全删除逻辑
- 🔄 回滚恢复方案

---

**最后更新**: 2025-01-27  
**维护人员**: 数据库团队  
**版本**: v1.0.0

