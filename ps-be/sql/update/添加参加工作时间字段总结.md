# 参加工作时间字段添加总结

## 一、需求说明

在人员新增、个人信息查看、个人信息编辑页面中添加"参加工作时间"字段的显示和编辑功能。

## 二、现状确认

经过检查，人员扩展信息表 `tp_person_exinfo` **已经存在** `PART_WORK_DATE` 字段（参加工作时间），无需创建新字段。

```sql
-- 字段已存在于表中
PART_WORK_DATE VARCHAR(100) COMMENT '参加工作时间'
```

## 三、修改内容

### 1. 后端修改

#### 1.1 TpPersonBasicinfoVO.java
**文件路径**：`ps-be/src/main/java/com/jiuxi/admin/core/bean/vo/TpPersonBasicinfoVO.java`

**修改内容**：
- 添加 `partWorkDate` 字段
- 添加 getter 和 setter 方法

```java
/**
 * 参加工作时间
 */
private String partWorkDate;

public String getPartWorkDate() {
    return partWorkDate;
}

public void setPartWorkDate(String partWorkDate) {
    this.partWorkDate = partWorkDate;
}
```

**设计说明**：
根据"VO字段扩展与跨表保存模式"，当基本信息VO需要新增字段但实际存储在扩展信息表时，应在VO中添加对应字段，并在保存主表数据后，检查该字段值，如有则同步保存至扩展信息表。

#### 1.2 UserPersonServiceImpl.java
**文件路径**：`ps-be/src/main/java/com/jiuxi/module/user/app/impl/UserPersonServiceImpl.java`

**修改内容**：

**a) save 方法（新增人员）**
```java
// 保存职称、职务职级、参加工作时间到扩展信息表（如果有）
if (StrUtil.isNotBlank(vo.getZhicheng()) || StrUtil.isNotBlank(vo.getZwzj()) || StrUtil.isNotBlank(vo.getPartWorkDate())) {
    LOGGER.info("准备保存扩展信息，personId：{}, zhicheng：{}, zwzj：{}, partWorkDate：{}", 
                personId, vo.getZhicheng(), vo.getZwzj(), vo.getPartWorkDate());
    TpPersonExinfo exinfo = new TpPersonExinfo();
    exinfo.setPersonId(personId);
    exinfo.setZhicheng(vo.getZhicheng());
    exinfo.setZwzj(vo.getZwzj());
    exinfo.setPartWorkDate(vo.getPartWorkDate()); // 新增
    exinfo.setTenantId(bean.getTenantId());
    tpPersonExinfoMapper.save(exinfo);
    LOGGER.info("扩展信息保存成功");
}
```

**b) update 方法（修改人员）**
```java
// 更新或保存职务职级、职称、参加工作时间到扩展信息表
if (StrUtil.isNotBlank(vo.getZwzj()) || StrUtil.isNotBlank(vo.getZhicheng()) || StrUtil.isNotBlank(vo.getPartWorkDate())) {
    LOGGER.info("准备更新扩展信息，personId：{}, zwzj：{}, zhicheng：{}, partWorkDate：{}", 
                personId, vo.getZwzj(), vo.getZhicheng(), vo.getPartWorkDate());
    
    // 检查扩展信息是否存在
    int exinfoCount = tpPersonExinfoMapper.count(personId);
    TpPersonExinfo exinfo = new TpPersonExinfo();
    exinfo.setPersonId(personId);
    exinfo.setZwzj(vo.getZwzj());
    exinfo.setZhicheng(vo.getZhicheng());
    exinfo.setPartWorkDate(vo.getPartWorkDate()); // 新增
    
    if (exinfoCount == 0) {
        // 不存在则新增
        exinfo.setTenantId(bean.getTenantId());
        tpPersonExinfoMapper.save(exinfo);
        LOGGER.info("扩展信息新增成功");
    } else {
        // 存在则更新
        tpPersonExinfoMapper.update(exinfo);
        LOGGER.info("扩展信息更新成功");
    }
}
```

### 2. 前端修改

#### 2.1 政府人员新增页面
**文件路径**：`ps-fe/@fb/admin-base/views/sys/person/org/add-basicinfo.vue`

**修改内容**：

**a) 模板部分**
```vue
<fb-row>
    <fb-col span="12">
        <fb-form-item label="职称">
            <fb-input
                type="text"
                v-model="formData.zhicheng"
                placeholder="请输入职称">
            </fb-input>
        </fb-form-item>
    </fb-col>
    <fb-col span="12">
        <fb-form-item label="参加工作时间">
            <tp-datepicker v-model="formData.partWorkDate" format="YYYY-MM-DD"
                           value-format="YYYYMMDD"></tp-datepicker>
        </fb-form-item>
    </fb-col>
</fb-row>
```

**b) 数据部分**
```javascript
formData: {
    // ... 其他字段
    zhicheng: '',
    // 参加工作时间
    partWorkDate: '',
    // ...
}
```

**页面布局**：
- 行1：[人员编号] [职务职级]
- 行2：[职称] [参加工作时间]
- 行3：[联系电话] [Email]

#### 2.2 个人信息查看页面
**文件路径**：`ps-fe/@fb/admin-base/views/sys/user-home/profile.vue`

**修改内容**：
```vue
<div class="info-row">
    <div class="info-label">
        <fb-icon name="calendar" class="label-icon"></fb-icon>
        <span>参加工作时间</span>
    </div>
    <div class="info-value">{{ formatDate(userInfo.partWorkDate) }}</div>
</div>
```

**显示位置**：工作信息卡片中，显示在"人员编号"之后。

#### 2.3 个人信息编辑页面
**文件路径**：`ps-fe/@fb/admin-base/views/sys/user-home/profile_edit.vue`

**修改内容**：

**a) 模板部分**
```vue
<fb-row>
    <fb-col span="12">
        <fb-form-item label="人员编号" prop="personNo">
            <fb-input v-model="formData.personNo" placeholder="请输入人员编号"></fb-input>
        </fb-form-item>
    </fb-col>
    <fb-col span="12">
        <fb-form-item label="参加工作时间" prop="partWorkDate">
            <tp-datepicker v-model="formData.partWorkDate" format="YYYY-MM-DD" value-format="YYYYMMDD"
                clearable></tp-datepicker>
        </fb-form-item>
    </fb-col>
</fb-row>
```

**b) 数据初始化**
```javascript
formData: {
    // ... 其他字段
    partWorkDate: '',
    // ...
}

// initFormData 方法中
partWorkDate: userInfo.partWorkDate || '',
```

**c) 保存数据**
```javascript
const basicData = {
    // ... 其他字段
    partWorkDate: this.formData.partWorkDate, // 参加工作时间
    // ...
}
```

## 四、数据流转说明

### 4.1 新增人员流程
1. 前端在政府人员新增页面输入"参加工作时间"
2. 提交到后端 `UserPersonServiceImpl.save()` 方法
3. 前端传递的 `partWorkDate` 字段通过 `TpPersonBasicinfoVO` 接收
4. 保存基本信息后，检查 `vo.getPartWorkDate()` 是否有值
5. 如果有值，则同步保存到 `tp_person_exinfo` 表的 `PART_WORK_DATE` 字段

### 4.2 修改人员流程
1. 前端在个人信息编辑页面修改"参加工作时间"
2. 提交到后端 `UserPersonServiceImpl.update()` 方法
3. 检查扩展信息表中是否已有该人员的记录
4. 如果不存在，则新增扩展信息记录；如果存在，则更新扩展信息
5. `PART_WORK_DATE` 字段被更新

### 4.3 查看人员流程
1. 后端从 `tp_person_exinfo` 表查询 `PART_WORK_DATE` 字段
2. 通过 `TpPersonExinfoVO` 传递到前端
3. 前端在个人信息查看页面显示格式化后的日期

## 五、字段格式说明

- **数据库存储格式**：`VARCHAR(100)`，例如 `20010815`（YYYYMMDD）
- **前端显示格式**：`YYYY-MM-DD`，例如 `2001-08-15`
- **前端输入组件**：`tp-datepicker`，日期选择器
- **值格式转换**：`value-format="YYYYMMDD"`，确保提交到后端的格式为 `YYYYMMDD`

## 六、已有字段说明

`tp_person_exinfo` 表中已经存在以下相关字段：
- `PART_WORK_DATE`：参加工作时间（本次使用的字段）
- `ZWZJ`：职务职级（之前已添加）
- `ZHICHENG`：职称（之前已添加）

这些字段都属于扩展信息，按照"VO字段扩展与跨表保存模式"进行统一处理。

## 七、影响范围

### 修改的文件清单

**后端文件（2个）**：
1. `ps-be/src/main/java/com/jiuxi/admin/core/bean/vo/TpPersonBasicinfoVO.java`
2. `ps-be/src/main/java/com/jiuxi/module/user/app/impl/UserPersonServiceImpl.java`

**前端文件（3个）**：
1. `ps-fe/@fb/admin-base/views/sys/person/org/add-basicinfo.vue` - 政府人员新增页面
2. `ps-fe/@fb/admin-base/views/sys/user-home/profile.vue` - 个人信息查看页面
3. `ps-fe/@fb/admin-base/views/sys/user-home/profile_edit.vue` - 个人信息编辑页面

### 涉及的功能模块
- 人员管理 - 政府人员新增
- 用户中心 - 个人信息查看
- 用户中心 - 个人信息编辑

## 八、测试建议

### 8.1 新增人员测试
1. 打开政府人员新增页面
2. 填写必填字段和"参加工作时间"
3. 提交保存
4. 检查数据库 `tp_person_exinfo` 表的 `PART_WORK_DATE` 字段是否正确保存

### 8.2 修改人员测试
1. 打开个人信息编辑页面
2. 修改"参加工作时间"
3. 保存
4. 检查数据库是否正确更新

### 8.3 查看人员测试
1. 打开个人信息查看页面
2. 确认"参加工作时间"字段正确显示
3. 确认日期格式化正确（YYYY-MM-DD）

### 8.4 边界测试
- 测试空值保存（参加工作时间为空）
- 测试日期格式转换
- 测试新增人员时扩展信息表的自动创建
- 测试修改人员时扩展信息的更新逻辑

## 九、注意事项

1. **字段已存在**：数据库中已有 `PART_WORK_DATE` 字段，无需执行 DDL 语句
2. **数据格式**：前后端统一使用 `YYYYMMDD` 格式存储，前端展示时格式化为 `YYYY-MM-DD`
3. **跨表保存**：遵循"VO字段扩展与跨表保存模式"，在基本信息VO中添加字段，在服务层自动同步到扩展信息表
4. **兼容性**：保存逻辑中已考虑扩展信息表记录不存在的情况，会自动创建
5. **一致性**：与 `zwzj`、`zhicheng` 字段使用相同的保存模式

## 十、完成状态

✅ 后端 VO 添加字段
✅ 后端服务层新增逻辑
✅ 后端服务层修改逻辑
✅ 前端政府人员新增页面
✅ 前端个人信息查看页面
✅ 前端个人信息编辑页面
✅ 代码编译检查通过

---

**修改日期**：2025-11-28
**修改人员**：AI Assistant
