# 参加工作时间格式规则优化总结

## 一、需求背景

**用户需求**：
参加工作时间规则调整，可以为：
- **年**：如 `2020`, `1999`, `1985`
- **年-月**：如 `2020-01`, `1999-12`
- **年-月-日**：如 `1988-08-15`, `2020-12-30`

**原有限制**：
只支持 `YYYY-MM-DD` 格式（如 `2001-08-15`）

## 二、修改内容

### 1. ValidationUtil.java - 校验逻辑扩展

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\shared\common\utils\ValidationUtil.java`

#### 1.1 validatePartWorkDate 方法

**修改前**：
```java
// 支持 YYYY-MM-DD 格式
if (!partWorkDate.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
    return "参加工作时间格式错误，应为YYYY-MM-DD格式，如2001-08-15";
}

// 解析年月日
String[] parts = partWorkDate.split("-");
int year = Integer.parseInt(parts[0]);
int month = Integer.parseInt(parts[1]);
int day = Integer.parseInt(parts[2]);

// ... 后续校验
```

**修改后**：
```java
/**
 * 校验参加工作时间
 * 支持三种格式：
 * - YYYY：年，如2020
 * - YYYY-MM：年-月，如2020-01
 * - YYYY-MM-DD：年-月-日，如1988-08-15
 */
public static String validatePartWorkDate(String partWorkDate) {
    if (partWorkDate == null || partWorkDate.trim().isEmpty()) {
        return null;
    }
    
    partWorkDate = partWorkDate.trim();
    
    // 判断格式类型
    String[] parts = partWorkDate.split("-");
    int year, month = 1, day = 1;
    
    try {
        if (parts.length == 1) {
            // 格式1: YYYY (只有年)
            if (!partWorkDate.matches("^\\d{4}$")) {
                return "参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式";
            }
            year = Integer.parseInt(parts[0]);
            
        } else if (parts.length == 2) {
            // 格式2: YYYY-MM (年-月)
            if (!partWorkDate.matches("^\\d{4}-\\d{2}$")) {
                return "参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式";
            }
            year = Integer.parseInt(parts[0]);
            month = Integer.parseInt(parts[1]);
            
            // 校验月份范围
            if (month < 1 || month > 12) {
                return "参加工作时间的月份应在01-12之间";
            }
            
        } else if (parts.length == 3) {
            // 格式3: YYYY-MM-DD (年-月-日)
            if (!partWorkDate.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
                return "参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式";
            }
            year = Integer.parseInt(parts[0]);
            month = Integer.parseInt(parts[1]);
            day = Integer.parseInt(parts[2]);
            
            // 校验月份范围
            if (month < 1 || month > 12) {
                return "参加工作时间的月份应在01-12之间";
            }
            
            // 校验日期范围
            if (day < 1 || day > 31) {
                return "参加工作时间的日期应在01-31之间";
            }
            
            // 使用Java日期API验证日期是否合法（例如2001-02-30是非法的）
            try {
                java.time.LocalDate.of(year, month, day);
            } catch (Exception e) {
                return "参加工作时间的日期不合法";
            }
            
        } else {
            return "参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式";
        }
        
        // 校验年份合理性
        int currentYear = java.time.Year.now().getValue();
        if (year < 1900 || year > currentYear) {
            return "参加工作时间的年份应在1900-" + currentYear + "之间";
        }
        
    } catch (NumberFormatException e) {
        return "参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式";
    }
    
    return null;
}
```

**改进点**：
- ✅ 支持 `YYYY` 格式（仅年份）
- ✅ 支持 `YYYY-MM` 格式（年-月）
- ✅ 保留 `YYYY-MM-DD` 格式（年-月-日）
- ✅ 根据不同格式进行相应的校验
- ✅ 完整格式时才验证日期合法性

#### 1.2 formatDateToYYYYMMDD 方法

**修改前**：
```java
/**
 * 将 YYYY-MM-DD 格式转换为 YYYYMMDD 格式
 */
public static String formatDateToYYYYMMDD(String date) {
    // ...
    
    // 如果是 YYYY-MM-DD 格式，转换为 YYYYMMDD
    if (date.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
        return date.replace("-", "");
    }
    
    return date;
}
```

**修改后**：
```java
/**
 * 将多种日期格式转换为 YYYYMMDD 格式
 * 支持输入格式：
 * - YYYY -> YYYY0101
 * - YYYY-MM -> YYYYMM01
 * - YYYY-MM-DD -> YYYYMMDD
 */
public static String formatDateToYYYYMMDD(String date) {
    if (date == null || date.trim().isEmpty()) {
        return "";
    }
    
    date = date.trim();
    
    // 如果已经是 YYYYMMDD 格式，直接返回
    if (date.matches("^\\d{8}$")) {
        return date;
    }
    
    // 判断格式类型
    String[] parts = date.split("-");
    
    if (parts.length == 1 && date.matches("^\\d{4}$")) {
        // YYYY -> YYYY0101
        return date + "0101";
        
    } else if (parts.length == 2 && date.matches("^\\d{4}-\\d{2}$")) {
        // YYYY-MM -> YYYYMM01
        return date.replace("-", "") + "01";
        
    } else if (parts.length == 3 && date.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
        // YYYY-MM-DD -> YYYYMMDD
        return date.replace("-", "");
    }
    
    return date; // 其他格式直接返回
}
```

**转换规则**：
- `2020` → `20200101` （补充01月01日）
- `2020-08` → `20200801` （补充01日）
- `2020-08-15` → `20200815` （完整日期）

### 2. ExcelUtil.java - 模板示例更新

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\shared\common\utils\ExcelUtil.java`

```java
// 写入示例数据（注：参加工作时间支持 YYYY、YYYY-MM、YYYY-MM-DD 三种格式）
Row exampleRow = sheet.createRow(1);
String[] exampleData = {
    "zhangsan", "123456", "张三", "男", "办公室", 
    "2001-08-15", "四级调研员", "副教授", "411723196710175102"
};
```

### 3. UserImportDTO.java - 注释更新

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\module\user\app\dto\UserImportDTO.java`

```java
/**
 * 参加工作时间（支持 YYYY、YYYY-MM、YYYY-MM-DD 三种格式，可选）
 */
private String partWorkDate;
```

## 三、格式示例与处理

### 格式1：仅年份（YYYY）

**输入示例**：
```
2020
1999
1985
```

**验证规则**：
- ✅ 4位数字
- ✅ 年份范围：1900 至当前年份

**存储转换**：
- `2020` → 存储为 `20200101`
- `1999` → 存储为 `19990101`
- `1985` → 存储为 `19850101`

**导出显示**：
- 保持原格式（暂不处理导出，因为数据库已统一为YYYYMMDD）

### 格式2：年-月（YYYY-MM）

**输入示例**：
```
2020-01
1999-12
2010-06
```

**验证规则**：
- ✅ YYYY-MM 格式（连字符分隔）
- ✅ 年份范围：1900 至当前年份
- ✅ 月份范围：01-12

**存储转换**：
- `2020-01` → 存储为 `20200101`
- `1999-12` → 存储为 `19991201`
- `2010-06` → 存储为 `20100601`

### 格式3：年-月-日（YYYY-MM-DD）

**输入示例**：
```
1988-08-15
2020-12-30
2001-02-28
```

**验证规则**：
- ✅ YYYY-MM-DD 格式（连字符分隔）
- ✅ 年份范围：1900 至当前年份
- ✅ 月份范围：01-12
- ✅ 日期范围：01-31
- ✅ 日期合法性（如 2001-02-30 会被拒绝）

**存储转换**：
- `1988-08-15` → 存储为 `19880815`
- `2020-12-30` → 存储为 `20201230`
- `2001-02-28` → 存储为 `20010228`

**导出显示**：
- `19880815` → 导出为 `1988-08-15`
- `20201230` → 导出为 `2020-12-30`

## 四、数据流转示例

### 示例1：导入年份格式

```
Excel输入: 2020
  ↓
校验: validatePartWorkDate("2020") → 通过
  ↓
转换: formatDateToYYYYMMDD("2020") → "20200101"
  ↓
存储: tp_person_exinfo.PART_WORK_DATE = "20200101"
  ↓
导出: formatDateToYYYYMMDD_Hyphen("20200101") → "2020-01-01"
```

### 示例2：导入年-月格式

```
Excel输入: 2020-08
  ↓
校验: validatePartWorkDate("2020-08") → 通过
  ↓
转换: formatDateToYYYYMMDD("2020-08") → "20200801"
  ↓
存储: tp_person_exinfo.PART_WORK_DATE = "20200801"
  ↓
导出: formatDateToYYYYMMDD_Hyphen("20200801") → "2020-08-01"
```

### 示例3：导入完整日期格式

```
Excel输入: 1988-08-15
  ↓
校验: validatePartWorkDate("1988-08-15") → 通过
  ↓
转换: formatDateToYYYYMMDD("1988-08-15") → "19880815"
  ↓
存储: tp_person_exinfo.PART_WORK_DATE = "19880815"
  ↓
导出: formatDateToYYYYMMDD_Hyphen("19880815") → "1988-08-15"
```

## 五、校验规则详情

### 1. 年份校验

**所有格式通用**：
- ✅ 年份 ≥ 1900
- ✅ 年份 ≤ 当前年份
- ❌ 年份 < 1900：拒绝
- ❌ 年份 > 当前年份：拒绝

**示例**：
```
✅ 1900      → 通过
✅ 2024      → 通过（假设当前年份为2024）
❌ 1899      → 拒绝（年份过小）
❌ 2025      → 拒绝（年份超过当前年份，假设当前为2024）
```

### 2. 月份校验

**适用格式**：YYYY-MM、YYYY-MM-DD

- ✅ 月份范围：01-12
- ❌ 月份 < 01：拒绝
- ❌ 月份 > 12：拒绝

**示例**：
```
✅ 2020-01   → 通过
✅ 2020-12   → 通过
❌ 2020-00   → 拒绝（月份过小）
❌ 2020-13   → 拒绝（月份过大）
```

### 3. 日期校验

**适用格式**：YYYY-MM-DD

- ✅ 日期范围：01-31
- ✅ 使用 LocalDate API 严格验证日期合法性
- ❌ 日期 < 01：拒绝
- ❌ 日期 > 31：拒绝
- ❌ 非法日期（如 2月30日）：拒绝

**示例**：
```
✅ 2020-02-29 → 通过（闰年）
✅ 2020-12-31 → 通过
❌ 2021-02-29 → 拒绝（平年无2月29日）
❌ 2020-02-30 → 拒绝（2月无30日）
❌ 2020-01-00 → 拒绝（日期过小）
❌ 2020-01-32 → 拒绝（日期过大）
```

## 六、错误提示

### 格式错误

**输入**：`2020/08/15`、`2020.08.15`、`20200815`

**错误提示**：
```
参加工作时间格式错误，应为YYYY、YYYY-MM或YYYY-MM-DD格式
```

### 年份错误

**输入**：`1899`、`2099`

**错误提示**：
```
参加工作时间的年份应在1900-2024之间
```
（2024为当前年份示例）

### 月份错误

**输入**：`2020-13`、`2020-00`

**错误提示**：
```
参加工作时间的月份应在01-12之间
```

### 日期错误

**输入**：`2020-01-32`、`2020-02-30`

**错误提示**：
```
参加工作时间的日期应在01-31之间
```
或
```
参加工作时间的日期不合法
```

## 七、测试建议

### 1. 格式验证测试

- [ ] `2020` → 通过
- [ ] `2020-08` → 通过
- [ ] `2020-08-15` → 通过
- [ ] `2020/08/15` → 拒绝（格式错误）
- [ ] `2020.08.15` → 拒绝（格式错误）
- [ ] `20200815` → 拒绝（格式错误，应添加连字符）

### 2. 年份边界测试

- [ ] `1900` → 通过
- [ ] `1899` → 拒绝（年份过小）
- [ ] 当前年份 → 通过
- [ ] 当前年份+1 → 拒绝（年份过大）

### 3. 月份边界测试

- [ ] `2020-01` → 通过
- [ ] `2020-12` → 通过
- [ ] `2020-00` → 拒绝（月份过小）
- [ ] `2020-13` → 拒绝（月份过大）

### 4. 日期合法性测试

- [ ] `2020-02-29` → 通过（闰年）
- [ ] `2021-02-29` → 拒绝（平年）
- [ ] `2020-02-30` → 拒绝（2月无30日）
- [ ] `2020-04-31` → 拒绝（4月只有30天）
- [ ] `2020-12-31` → 通过

### 5. 存储转换测试

- [ ] `2020` → `20200101`
- [ ] `2020-08` → `20200801`
- [ ] `2020-08-15` → `20200815`

### 6. 导出转换测试

- [ ] `20200101` → `2020-01-01`
- [ ] `20200801` → `2020-08-01`
- [ ] `20200815` → `2020-08-15`

## 八、向后兼容性

### 已有数据

数据库中已存在的 `YYYYMMDD` 格式数据：
- ✅ 导出时正常转换为 `YYYY-MM-DD` 格式
- ✅ 不影响已有数据的查询和展示

### 旧格式导入

如果用户仍使用完整的 `YYYY-MM-DD` 格式：
- ✅ 完全兼容，正常导入
- ✅ 转换逻辑保持一致

## 九、注意事项

1. **默认补全规则**：
   - 仅年份时，默认补全为1月1日
   - 年-月时，默认补全为该月1日

2. **导出格式**：
   - 当前导出统一使用 `YYYY-MM-DD` 格式
   - 如需保持原始输入精度（区分年、年-月、年-月-日），需要额外字段标识

3. **精度丢失**：
   - 输入 `2020` 后导出变为 `2020-01-01`
   - 输入 `2020-08` 后导出变为 `2020-08-01`
   - 如需保持原始精度，建议在数据库增加精度字段

---

**修改日期**: 2025-11-28  
**修改人**: AI Assistant  
**影响范围**: 用户导入导出功能 - 参加工作时间字段
