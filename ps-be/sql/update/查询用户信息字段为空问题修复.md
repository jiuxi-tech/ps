# 查询用户信息 zwzj、zhicheng、partWorkDate 为空问题修复

## 一、问题描述

### 问题现象
调用 `GET /sys/person/view?personId=xxx&deptId=xxx` 接口查询用户信息时，返回的数据中：
- `zwzj`（职务职级）为空
- `zhicheng`（职称）为空  
- `partWorkDate`（参加工作时间）为空

### 问题原因分析

#### 1. 数据存储位置
这三个字段存储在 **扩展信息表** `tp_person_exinfo` 中，而不是基本信息表 `tp_person_basicinfo`。

| 字段 | 存储表 | 说明 |
|------|--------|------|
| zwzj | tp_person_exinfo | 职务职级 |
| zhicheng | tp_person_exinfo | 职称 |
| partWorkDate | tp_person_exinfo | 参加工作时间 |

#### 2. 代码缺陷
`UserPersonServiceImpl.view()` 方法中：
- ✅ 查询了基本信息表 `tp_person_basicinfo`
- ❌ **没有查询扩展信息表** `tp_person_exinfo`
- ❌ 导致 `zwzj`、`zhicheng`、`partWorkDate` 等字段没有赋值

## 二、修复方案

### 2.1 修复位置
**文件路径**：`ps-be/src/main/java/com/jiuxi/module/user/app/impl/UserPersonServiceImpl.java`

**方法**：`view(String personId, String deptId)`

### 2.2 修复内容

在查询基本信息后，**增加查询扩展信息的逻辑**，并将扩展信息中的字段赋值到基本信息VO中。

```java
@Override
public TpPersonBasicinfoVO view(String personId, String deptId) {
    try {
        // 1. 查询基本信息
        TpPersonBasicinfoVO vo = tpPersonBasicinfoMapper.view(personId);
        
        // 2. 解密手机号
        if (vo != null && StrUtil.isNotBlank(vo.getPhone())) {
            String decryptedPhone = PhoneEncryptionUtils.safeDecrypt(vo.getPhone());
            vo.setPhone(decryptedPhone);
        }

        // 3. 查询扩展信息，并将 zwzj、zhicheng、partWorkDate 等字段赋值到基本信息VO ⭐ 新增
        TpPersonExinfoVO exinfoVO = tpPersonExinfoMapper.view(personId);
        if (exinfoVO != null) {
            vo.setZwzj(exinfoVO.getZwzj());                      // 职务职级
            vo.setZhicheng(exinfoVO.getZhicheng());              // 职称
            vo.setPartWorkDate(exinfoVO.getPartWorkDate());      // 参加工作时间
            LOGGER.debug("查询扩展信息成功，personId: {}, zwzj: {}, zhicheng: {}, partWorkDate: {}", 
                        personId, exinfoVO.getZwzj(), exinfoVO.getZhicheng(), exinfoVO.getPartWorkDate());
        } else {
            LOGGER.debug("扩展信息不存在，personId: {}", personId);
        }

        // 4. 根据用户id查询所在部门（原有逻辑）
        // ... 部门查询逻辑 ...

        return vo;
    } catch (Exception e) {
        LOGGER.error("查看用户基本信息失败！personId:{}, deptId:{}, e: {}", personId, deptId, ExceptionUtils.getStackTrace(e));
        throw new TopinfoRuntimeException(-1, "查看用户基本信息失败！");
    }
}
```

## 三、修复后的数据流转

### 3.1 查询流程

```
前端调用 /sys/person/view
    ↓
UserPersonServiceImpl.view()
    ↓
1. 查询基本信息表 tp_person_basicinfo
    ↓
2. 查询扩展信息表 tp_person_exinfo  ⭐ 新增
    ↓
3. 将扩展信息字段赋值到基本信息VO
   - vo.setZwzj(exinfoVO.getZwzj())
   - vo.setZhicheng(exinfoVO.getZhicheng())
   - vo.setPartWorkDate(exinfoVO.getPartWorkDate())
    ↓
4. 返回完整的用户信息（包含 zwzj、zhicheng、partWorkDate）
    ↓
前端收到数据并显示
```

### 3.2 返回数据示例

**修复前**：
```json
{
    "personId": "1994369088654147584",
    "personName": "张三",
    "zwzj": null,          ❌ 空
    "zhicheng": null,      ❌ 空
    "partWorkDate": null   ❌ 空
}
```

**修复后**：
```json
{
    "personId": "1994369088654147584",
    "personName": "张三",
    "zwzj": "四级调研员",     ✅ 有值
    "zhicheng": "高级工程师",  ✅ 有值
    "partWorkDate": "20010815" ✅ 有值
}
```

## 四、关键设计说明

### 4.1 为什么使用 TpPersonBasicinfoVO 返回扩展信息字段？

根据"**VO字段扩展与跨表保存模式**"：
- 当基本信息VO需要新增字段但实际存储在扩展信息表时
- 应在 VO 中添加对应字段
- 在查询时从扩展信息表读取并赋值
- 在保存时同步保存至扩展信息表

这样做的好处：
1. ✅ **前端统一接口**：前端只需调用一个 `view` 接口，不需要分别调用基本信息和扩展信息接口
2. ✅ **数据完整性**：返回的 VO 包含完整的用户信息
3. ✅ **向后兼容**：不影响现有前端代码
4. ✅ **减少网络请求**：一次请求获取所有数据

### 4.2 与其他方法的一致性

| 方法 | 基本信息表 | 扩展信息表 | 说明 |
|------|-----------|-----------|------|
| `save()` | ✅ 保存 | ✅ 保存 | 新增时同时保存两个表 |
| `update()` | ✅ 更新 | ✅ 更新 | 修改时同时更新两个表 |
| `view()` | ✅ 查询 | ✅ 查询 ⭐ 本次修复 | 查询时合并两个表的数据 |

## 五、影响范围

### 5.1 修改的文件
- `ps-be/src/main/java/com/jiuxi/module/user/app/impl/UserPersonServiceImpl.java`
  - 修改方法：`view(String personId, String deptId)`
  - 新增逻辑：查询扩展信息并赋值

### 5.2 受益的页面
修复后，以下页面都能正确显示这些字段：
1. ✅ 个人信息查看页面 - 显示职务职级、职称、参加工作时间
2. ✅ 个人信息编辑页面 - 回显职务职级、职称、参加工作时间
3. ✅ 人员详情页面 - 显示完整的人员信息
4. ✅ 人员列表页面 - 如果需要显示这些字段

## 六、日志输出

修复后，在查询用户信息时会输出以下日志：

**扩展信息存在时**：
```
DEBUG - 查询扩展信息成功，personId: 1994369088654147584, zwzj: 四级调研员, zhicheng: 高级工程师, partWorkDate: 20010815
```

**扩展信息不存在时**：
```
DEBUG - 扩展信息不存在，personId: 1994369088654147584
```

这些日志有助于：
- 确认扩展信息是否正确查询
- 排查数据为空的原因
- 监控查询性能

## 七、测试验证

### 7.1 测试步骤
1. 重启后端服务
2. 调用查询接口：
   ```
   GET /sys/person/view?personId=1994369088654147584&deptId=1764272370000001
   ```
3. 检查返回数据中的字段：
   - ✅ `zwzj` 应该有值（如：四级调研员）
   - ✅ `zhicheng` 应该有值（如：高级工程师）
   - ✅ `partWorkDate` 应该有值（如：20010815）

### 7.2 验证查询
在数据库中验证数据是否存在：
```sql
SELECT 
    tpb.PERSON_ID,
    tpb.PERSON_NAME,
    tpe.ZWZJ,
    tpe.ZHICHENG,
    tpe.PART_WORK_DATE
FROM tp_person_basicinfo tpb
LEFT JOIN tp_person_exinfo tpe ON tpb.PERSON_ID = tpe.PERSON_ID
WHERE tpb.PERSON_ID = '1994369088654147584';
```

## 八、注意事项

### 8.1 扩展信息为空的情况
如果扩展信息表中没有该人员的记录，`zwzj`、`zhicheng`、`partWorkDate` 仍然会是 `null`，这是正常的。

### 8.2 性能考虑
- 每次查询用户信息时会额外查询一次扩展信息表
- 如果性能敏感，可以考虑：
  - 使用 JOIN 查询一次性获取所有数据
  - 使用缓存减少数据库查询

### 8.3 数据一致性
确保在新增/修改用户时，扩展信息表的数据也正确保存，否则查询时会为空。

## 九、与之前修改的关联

此修复与之前的字段重构相关联：

### 之前的修改
1. ✅ 数据库添加 `ZWZJ`、`ZHICHENG` 字段
2. ✅ 实体类添加对应字段
3. ✅ `save()` 方法保存这些字段
4. ✅ `update()` 方法更新这些字段
5. ✅ 前端页面显示和编辑这些字段

### 本次修复
6. ✅ `view()` 方法查询这些字段 ⭐ 关键缺失环节

现在，**新增、修改、查询** 三个环节都完整了！

## 十、总结

### 问题根源
- `view()` 方法只查询了基本信息表，没有查询扩展信息表
- 导致存储在扩展信息表中的字段（`zwzj`、`zhicheng`、`partWorkDate`）无法返回

### 解决方案
- 在 `view()` 方法中增加扩展信息查询
- 将扩展信息字段赋值到基本信息 VO
- 确保前端能获取完整的用户信息

### 修复效果
- ✅ 查询用户信息时能正确返回 `zwzj`、`zhicheng`、`partWorkDate`
- ✅ 前端页面能正确显示这些字段
- ✅ 编辑页面能正确回显这些字段
- ✅ 数据流转完整（新增→修改→查询）

---

**修复日期**：2025-11-28
**修复人员**：AI Assistant
**影响范围**：用户信息查询接口
**测试状态**：待测试
