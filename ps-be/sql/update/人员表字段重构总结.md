# 人员表字段重构总结

## 一、需求背景

为了避免字段语义混淆，对人员表进行业务字段重构，添加两个明确的业务字段：
- **职务职级**（`ZWZJ`）
- **职称**（`ZHICHENG`）

隐藏原有的混乱字段：
- `office` (tp_person_basicinfo.OFFICE) - 职位
- `position` (tp_person_exinfo.POSITION) - 岗位
- `TITLE_CODE` (tp_person_exinfo.TITLE_CODE) - 职称编码/文本
- `RANK` (tp_person_exinfo.RANK) - 职务职级

## 二、数据库变更

### 2.1 表结构修改

**文件**：`ps-be/sql/update/add_zwzj_zhicheng_fields.sql`

**变更内容**：
```sql
-- 添加新字段
ALTER TABLE tp_person_exinfo 
ADD COLUMN ZWZJ VARCHAR(100) DEFAULT NULL COMMENT '职务职级（如：四级调研员、科长等）',
ADD COLUMN ZHICHENG VARCHAR(100) DEFAULT NULL COMMENT '职称（如：教授、副教授、工程师等）';

-- 数据迁移
UPDATE tp_person_exinfo 
SET ZWZJ = COALESCE(RANK, POSITION)
WHERE ZWZJ IS NULL AND (RANK IS NOT NULL OR POSITION IS NOT NULL);

UPDATE tp_person_exinfo 
SET ZHICHENG = TITLE_CODE
WHERE ZHICHENG IS NULL AND TITLE_CODE IS NOT NULL;
```

**执行说明**：
1. 使用事务保证数据一致性
2. 自动迁移历史数据
3. 保留旧字段用于兼容，但不再使用
4. 包含验证SQL查看迁移结果

### 2.2 字段说明

| 字段名 | 类型 | 说明 | 状态 |
|--------|------|------|------|
| ZWZJ | VARCHAR(100) | 职务职级（如：四级调研员、科长、处长等） | ✅ 新增，推荐使用 |
| ZHICHENG | VARCHAR(100) | 职称（如：教授、副教授、高级工程师等） | ✅ 新增，推荐使用 |
| OFFICE | VARCHAR | 职位 | ⚠️ 已废弃 |
| POSITION | VARCHAR | 岗位 | ⚠️ 已废弃 |
| RANK | VARCHAR | 职务职级（旧） | ⚠️ 已废弃 |
| TITLE_CODE | VARCHAR | 职称编码/文本（旧） | ⚠️ 已废弃 |

## 三、后端代码修改

### 3.1 实体类修改

**修改文件**：
1. `TpPersonExinfo.java` - 人员扩展信息实体
2. `TpPersonExinfoVO.java` - 人员扩展信息VO
3. `TpPersonBasicinfoVO.java` - 人员基本信息VO

**变更内容**：
- 添加新字段：`zwzj`、`zhicheng`
- 旧字段标记为 `@Deprecated`
- 添加对应的 getter/setter 方法

### 3.2 Mapper XML修改

**修改文件**：`TpPersonExinfoMapper.xml`

**变更内容**：
```xml
<!-- insert语句添加新字段 -->
INSERT INTO tp_person_exinfo
    (..., ZWZJ, ZHICHENG, ...)
VALUES
    (..., #{zwzj}, #{zhicheng}, ...)

<!-- select语句添加新字段 -->
SELECT ..., tpe.ZWZJ, tpe.ZHICHENG, ... FROM tp_person_exinfo tpe

<!-- update语句添加新字段 -->
<if test="null != zwzj">ZWZJ = #{zwzj},</if>
<if test="null != zhicheng">ZHICHENG = #{zhicheng},</if>
```

### 3.3 服务层修改

**修改文件**：`UserPersonServiceImpl.java`

**变更内容**：
```java
// 保存职称和职务职级到扩展信息表（如果有）
if (StrUtil.isNotBlank(vo.getZhicheng()) || StrUtil.isNotBlank(vo.getZwzj())) {
    TpPersonExinfo exinfo = new TpPersonExinfo();
    exinfo.setPersonId(personId);
    exinfo.setZhicheng(vo.getZhicheng());
    exinfo.setZwzj(vo.getZwzj());
    exinfo.setTenantId(bean.getTenantId());
    tpPersonExinfoMapper.save(exinfo);
}
```

### 3.4 导入导出修改

**修改文件**：
1. `UserImportDTO.java` - 导入DTO
2. `UserExportDTO.java` - 导出DTO
3. `UserImportExportServiceImpl.java` - 导入导出服务实现
4. `ExcelUtil.java` - Excel工具类

**变更内容**：
- DTO添加新字段：`zwzj`、`zhicheng`
- 旧字段标记为 `@Deprecated`
- 导入逻辑：直接使用新字段存储文本
- 导出逻辑：直接读取新字段输出
- Excel列映射：列6=职务职级，列7=职称

## 四、前端代码修改

### 4.1 政府人员新增/修改页面

**修改文件**：`ps-fe/@fb/admin-base/views/sys/person/org/add-basicinfo.vue`

**变更内容**：
```vue
<!-- 新增职务职级输入框 -->
<fb-form-item label="职务职级">
    <fb-input v-model="formData.zwzj" placeholder="请输入职务职级"></fb-input>
</fb-form-item>

<!-- 职称输入框（改用新字段） -->
<fb-form-item label="职称">
    <fb-input v-model="formData.zhicheng" placeholder="请输入职称"></fb-input>
</fb-form-item>

<!-- formData添加新字段 -->
formData: {
    zwzj: '',      // 职务职级
    zhicheng: '',  // 职称
}
```

### 4.2 企业人员新增/修改页面

**修改文件**：`ps-fe/@fb/admin-base/views/sys/person/ent/add-basicinfo.vue`

**变更内容**：与政府人员页面相同

## 五、Excel模板变更

### 5.1 导入模板

**表头定义**（按顺序）：
```
账号名 | 初始密码 | 姓名 | 性别 | 部门 | 参加工作时间 | 职务职级 | 职称 | 身份证号码
```

**示例数据**：
```
zhangsan | 123456 | 张三 | 男 | 办公室 | 2001.08 | 四级调研员 | 副教授 | 411723196710175102
```

### 5.2 导出模板

**表头定义**（按顺序）：
```
账号名 | 姓名 | 性别 | 部门 | 参加工作时间 | 职务职级 | 职称 | 身份证号码
```

## 六、修改文件清单

### 6.1 后端文件（10个）

| 序号 | 文件路径 | 修改类型 |
|------|----------|----------|
| 1 | `ps-be/sql/update/add_zwzj_zhicheng_fields.sql` | 新增 |
| 2 | `TpPersonExinfo.java` | 修改 |
| 3 | `TpPersonExinfoVO.java` | 修改 |
| 4 | `TpPersonBasicinfoVO.java` | 修改 |
| 5 | `TpPersonExinfoMapper.xml` | 修改 |
| 6 | `UserPersonServiceImpl.java` | 修改 |
| 7 | `UserImportDTO.java` | 修改 |
| 8 | `UserExportDTO.java` | 修改 |
| 9 | `UserImportExportServiceImpl.java` | 修改 |
| 10 | `ExcelUtil.java` | 修改 |

### 6.2 前端文件（2个）

| 序号 | 文件路径 | 修改类型 |
|------|----------|----------|
| 1 | `ps-fe/@fb/admin-base/views/sys/person/org/add-basicinfo.vue` | 修改 |
| 2 | `ps-fe/@fb/admin-base/views/sys/person/ent/add-basicinfo.vue` | 修改 |

## 七、部署步骤

### 7.1 数据库升级

```sql
-- 1. 执行数据库变更脚本
mysql --host=alilaoba.cn --port=13307 --user=root --password='***' --database=ps-bmp < ps-be/sql/update/add_zwzj_zhicheng_fields.sql

-- 2. 验证字段添加结果
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'ps-bmp'
  AND TABLE_NAME = 'tp_person_exinfo'
  AND COLUMN_NAME IN ('ZWZJ', 'ZHICHENG');

-- 3. 验证数据迁移结果
SELECT 
    COUNT(*) as 总记录数,
    COUNT(ZWZJ) as 职务职级有值数,
    COUNT(ZHICHENG) as 职称有值数
FROM tp_person_exinfo;
```

### 7.2 后端部署

```bash
# 1. 编译后端代码
cd d:\projects\ps\ps-be
mvn clean compile -DskipTests

# 2. 打包
mvn clean package -DskipTests

# 3. 重启服务
# 根据实际部署方式重启应用
```

### 7.3 前端部署

```bash
# 1. 构建前端代码
cd d:\projects\ps\ps-fe
npm run build

# 2. 部署到服务器
# 根据实际部署方式部署前端资源
```

## 八、测试验证

### 8.1 功能测试点

1. **人员新增功能**
   - ✅ 政府人员新增页面显示"职务职级"和"职称"输入框
   - ✅ 企业人员新增页面显示"职务职级"和"职称"输入框
   - ✅ 输入数据后保存到数据库 `tp_person_exinfo` 表的 `ZWZJ` 和 `ZHICHENG` 字段

2. **人员修改功能**
   - ✅ 查看人员信息时正确显示"职务职级"和"职称"
   - ✅ 修改后数据正确更新到数据库

3. **人员导入功能**
   - ✅ 下载导入模板包含"职务职级"和"职称"列
   - ✅ 导入Excel时正确解析这两列数据
   - ✅ 数据正确保存到数据库

4. **人员导出功能**
   - ✅ 导出Excel包含"职务职级"和"职称"列
   - ✅ 数据正确显示

### 8.2 数据验证

```sql
-- 查看最近添加/修改的记录
SELECT 
    pb.PERSON_NAME as 姓名,
    pe.ZWZJ as 职务职级,
    pe.ZHICHENG as 职称,
    pb.CREATE_TIME as 创建时间
FROM tp_person_basicinfo pb
LEFT JOIN tp_person_exinfo pe ON pb.PERSON_ID = pe.PERSON_ID
ORDER BY pb.CREATE_TIME DESC
LIMIT 10;
```

## 九、注意事项

1. **数据兼容性**
   - 旧字段（`office`、`position`、`rank`、`titleCode`）已标记为 `@Deprecated`
   - 旧字段保留在数据库中，仅用于数据兼容，不再使用
   - 历史数据已自动迁移到新字段

2. **代码规范**
   - 新代码统一使用 `zwzj` 和 `zhicheng` 字段
   - 不要再使用旧字段进行开发

3. **Excel模板**
   - 旧模板将不再支持，请通知用户下载新模板
   - 新模板列顺序：账号名、初始密码、姓名、性别、部门、参加工作时间、**职务职级**、**职称**、身份证号码

4. **前端显示**
   - "职务职级"和"职称"作为独立字段显示
   - 用户可自由输入文本，不受字典限制

## 十、回滚方案

如果出现问题需要回滚，执行以下步骤：

```sql
-- 1. 从新字段回滚到旧字段
UPDATE tp_person_exinfo 
SET RANK = ZWZJ, TITLE_CODE = ZHICHENG
WHERE ZWZJ IS NOT NULL OR ZHICHENG IS NOT NULL;

-- 2. 删除新字段（可选，谨慎执行）
-- ALTER TABLE tp_person_exinfo DROP COLUMN ZWZJ, DROP COLUMN ZHICHENG;
```

然后回滚代码到上一个版本。

## 十一、后续优化建议

1. 考虑添加字段校验规则（如长度限制）
2. 可以增加常用职务职级和职称的下拉提示功能
3. 统计报表需要更新，使用新字段进行数据分析
4. 旧字段在确认无问题后，可以在未来版本中彻底移除

---

**文档作者**：AI Assistant  
**创建时间**：2025-11-28  
**版本**：v1.0
