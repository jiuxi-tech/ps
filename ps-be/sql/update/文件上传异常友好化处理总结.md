# 文件上传大小超限异常友好化处理

## 一、问题描述

### 原始错误信息
```json
{
    "timestamp": "2025-11-28T15:27:57.603+00:00",
    "status": 500,
    "error": "Internal Server Error",
    "trace": "org.springframework.web.multipart.MaxUploadSizeExceededException: Maximum upload size exceeded; nested exception is java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.impl.FileSizeLimitExceededException: The field file exceeds its maximum permitted size of 1048576 bytes..."
}
```

### 问题分析
- **异常类型**：`MaxUploadSizeExceededException` - 文件上传大小超出限制
- **用户体验差**：显示堆栈信息，不友好
- **信息不明确**：用户不知道文件大小限制是多少

## 二、优化方案

### 2.1 优化目标
1. ✅ 隐藏技术堆栈信息
2. ✅ 显示友好的中文提示
3. ✅ 明确告知用户文件大小限制
4. ✅ 自动将字节转换为 KB/MB/GB 等易读单位

### 2.2 错误信息优化

**优化前**：
```
上传文件大小超出限制
```

**优化后**：
```
上传文件太大，单个文件大小不能超过 1.0MB
```
或
```
上传文件太大，总大小不能超过 10.0MB
```

## 三、实现细节

### 3.1 修改文件
**文件路径**：`ps-be/src/main/java/com/jiuxi/shared/common/handler/GlobalExceptionHandler.java`

### 3.2 核心功能

#### a) 智能解析文件大小限制
```java
// 尝试从异常信息中提取文件大小限制
if (e.getCause() != null && e.getCause().getMessage() != null) {
    String causeMsg = e.getCause().getMessage();
    // 匹配 "exceeds its maximum permitted size of 1048576 bytes" 这样的消息
    if (causeMsg.contains("maximum permitted size of")) {
        try {
            int start = causeMsg.indexOf("size of ") + 8;
            int end = causeMsg.indexOf(" bytes", start);
            if (start > 8 && end > start) {
                maxSize = Long.parseLong(causeMsg.substring(start, end).trim());
            }
        } catch (Exception ex) {
            log.debug("无法解析文件大小限制", ex);
        }
    }
}
```

#### b) 文件大小格式化
```java
/**
 * 格式化文件大小，转换为友好的显示格式
 * 
 * @param size 文件大小（字节）
 * @return 格式化后的文件大小字符串
 */
private String formatFileSize(long size) {
    if (size < 1024) {
        return size + "B";
    } else if (size < 1024 * 1024) {
        return String.format("%.1fKB", size / 1024.0);
    } else if (size < 1024 * 1024 * 1024) {
        return String.format("%.1fMB", size / (1024.0 * 1024));
    } else {
        return String.format("%.1fGB", size / (1024.0 * 1024 * 1024));
    }
}
```

#### c) 生成友好的错误消息
```java
// 如果成功提取到文件大小，转换为友好的格式
if (maxSize > 0) {
    String sizeStr = formatFileSize(maxSize);
    message = String.format("上传文件太大，单个文件大小不能超过 %s", sizeStr);
} else if (e.getMaxUploadSize() > 0) {
    String sizeStr = formatFileSize(e.getMaxUploadSize());
    message = String.format("上传文件太大，总大小不能超过 %s", sizeStr);
}
```

## 四、文件大小转换示例

| 字节数 | 转换结果 |
|--------|----------|
| 500 | 500B |
| 1024 | 1.0KB |
| 10240 | 10.0KB |
| 1048576 | 1.0MB |
| 10485760 | 10.0MB |
| 1073741824 | 1.0GB |

## 五、优化后的错误响应

### 5.1 响应格式
```json
{
    "code": "413",
    "message": "上传文件太大，单个文件大小不能超过 1.0MB",
    "data": null,
    "traceId": "xxx-xxx-xxx"
}
```

### 5.2 HTTP 状态码
- 保持 `200 OK`（业务异常）
- 错误码：`ResponseCodeEnum.PAYLOAD_TOO_LARGE.getCode()` (413)

## 六、异常处理流程

```
用户上传文件
    ↓
文件大小超出限制
    ↓
抛出 MaxUploadSizeExceededException
    ↓
GlobalExceptionHandler 捕获
    ↓
提取文件大小限制信息
    ↓
格式化文件大小 (1048576 bytes → 1.0MB)
    ↓
生成友好的错误消息
    ↓
返回给前端
    ↓
用户看到友好提示："上传文件太大，单个文件大小不能超过 1.0MB"
```

## 七、前端处理建议

前端可以在文件上传前进行预检查，提前提示用户：

```javascript
// 文件上传前检查
beforeUpload(file) {
    const maxSize = 1 * 1024 * 1024; // 1MB
    if (file.size > maxSize) {
        this.$message.error('上传文件太大，单个文件大小不能超过 1.0MB');
        return false;
    }
    return true;
}
```

## 八、相关配置

### 8.1 Spring Boot 文件上传配置
在 `application.yml` 或 `application.properties` 中配置：

```yaml
spring:
  servlet:
    multipart:
      # 单个文件最大大小
      max-file-size: 10MB
      # 总上传大小限制
      max-request-size: 50MB
```

或

```properties
# 单个文件最大大小
spring.servlet.multipart.max-file-size=10MB
# 总上传大小限制
spring.servlet.multipart.max-request-size=50MB
```

### 8.2 常见文件大小限制配置

| 场景 | 建议大小 |
|------|----------|
| 头像上传 | 1-2MB |
| 普通图片 | 5-10MB |
| 文档文件 | 10-20MB |
| 视频文件 | 50-100MB |
| Excel 批量导入 | 5-10MB |

## 九、测试验证

### 9.1 测试场景
1. ✅ 上传超过单个文件大小限制的文件
2. ✅ 上传总大小超过限制的多个文件
3. ✅ 验证错误消息是否友好
4. ✅ 验证文件大小格式化是否正确

### 9.2 测试步骤
1. 设置文件上传大小限制为 1MB
2. 尝试上传 2MB 的文件
3. 验证返回的错误消息：
   ```
   上传文件太大，单个文件大小不能超过 1.0MB
   ```

## 十、日志记录

优化后的异常处理会记录以下日志：

```
WARN  - 文件上传大小超限: Maximum upload size exceeded; nested exception is ...
INFO  - 异常详情 - 请求URL: http://localhost:10801/ps-be/sys/file/upload, 请求方法: POST, 客户端IP: 127.0.0.1, User-Agent: ...
```

## 十一、优势总结

### 优化前
- ❌ 显示技术堆栈信息
- ❌ 英文错误提示
- ❌ 用户不知道限制是多少
- ❌ 显示字节数（1048576 bytes）

### 优化后
- ✅ 隐藏技术细节
- ✅ 中文友好提示
- ✅ 明确告知文件大小限制
- ✅ 自动转换为易读单位（1.0MB）
- ✅ 区分单个文件和总大小限制

## 十二、注意事项

1. **文件大小限制配置**：确保 Spring Boot 配置中设置了合理的文件大小限制
2. **前端预检查**：建议在前端也进行文件大小检查，提升用户体验
3. **日志记录**：保留详细的异常日志，便于问题排查
4. **多语言支持**：如果需要国际化，可以将错误消息提取到资源文件中

## 十三、扩展建议

### 13.1 可选的进一步优化
1. 根据不同的文件类型设置不同的大小限制
2. 在错误消息中显示当前上传文件的实际大小
3. 提供文件压缩的建议
4. 记录上传失败的统计信息

### 13.2 示例错误消息（扩展版本）
```
上传失败：文件 "报告.pdf" 大小为 2.5MB，超过了允许的 1.0MB 限制。
建议：请压缩文件或分批上传。
```

---

**修改日期**：2025-11-28
**修改人员**：AI Assistant
**影响范围**：全局文件上传异常处理
**测试状态**：待测试
