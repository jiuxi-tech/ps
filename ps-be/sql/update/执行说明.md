# 清理逻辑删除数据 - 执行说明

## 📦 文件清单

### SQL脚本
- `clean_deleted_departments.sql` - 完整分析脚本
- `clean_deleted_departments_execute.sql` - 快速执行脚本

### 批处理脚本
- `执行清理.bat` - **自动执行清理（推荐）**
- `回滚清理.bat` - 回滚脚本，恢复已删除数据

### 文档
- `清理逻辑删除部门数据说明.md` - 详细文档
- `README_清理逻辑删除数据.md` - 总览文档
- `执行说明.md` - 本文档

## 🚀 快速开始

### 步骤1: 修改数据库连接配置

编辑 `执行清理.bat` 文件，修改以下变量：

```batch
set DB_HOST=localhost        :: 数据库主机地址
set DB_PORT=3306            :: 数据库端口
set DB_USER=root            :: 数据库用户名
set DB_NAME=ps-bmp          :: 数据库名称
```

同样修改 `回滚清理.bat` 中的配置（保持一致）。

### 步骤2: 执行清理

**方式一：使用批处理脚本（推荐）**

```bash
# 在 ps-be/sql/update 目录下
# 双击或在命令行执行：
执行清理.bat
```

脚本会自动：
1. 连接数据库
2. 执行分析，生成 `分析结果.txt`
3. 等待您确认
4. 执行清理，生成 `清理结果.txt`
5. 自动创建备份表 `tp_dept_basicinfo_deleted_backup`

**方式二：手动执行SQL（适合熟悉MySQL的用户）**

```bash
# 1. 执行分析
mysql -hlocalhost -P3306 -uroot -p ps-bmp < clean_deleted_departments.sql

# 2. 执行清理
mysql -hlocalhost -P3306 -uroot -p ps-bmp < clean_deleted_departments_execute.sql
```

### 步骤3: 验证结果

1. **查看清理结果**
   ```bash
   # 查看分析结果.txt
   # 查看清理结果.txt
   ```

2. **登录系统测试**
   - 测试组织机构树加载
   - 测试人员管理功能
   - 检查数据一致性

3. **查看备份表**
   ```sql
   SELECT COUNT(*) FROM tp_dept_basicinfo_deleted_backup;
   ```

## 🔄 如需回滚

如果发现数据删除有问题，可以立即回滚：

```bash
# 双击执行
回滚清理.bat
```

或手动执行：

```sql
-- 恢复所有已删除的数据
INSERT INTO tp_dept_basicinfo 
SELECT * FROM tp_dept_basicinfo_deleted_backup;

-- 验证
SELECT COUNT(*) FROM tp_dept_basicinfo WHERE ACTIVED = 0;
```

## 📊 预期执行流程

```
开始
  ↓
修改数据库配置
  ↓
执行 执行清理.bat
  ↓
[步骤1] 分析数据
  ├─ 统计逻辑删除部门
  ├─ 检查引用关系
  └─ 生成 分析结果.txt
  ↓
查看分析结果 → 决定是否继续
  ↓
[步骤2] 执行清理
  ├─ 创建备份表
  ├─ 物理删除数据
  └─ 生成 清理结果.txt
  ↓
验证结果
  ├─ 查看清理数量
  ├─ 测试系统功能
  └─ 确认数据正确
  ↓
完成 ✓
```

## ⚠️ 重要提醒

### 执行前检查清单

- [x] ✅ 已完整备份数据库
- [ ] 修改了数据库连接配置
- [ ] 了解要删除的数据范围
- [ ] 当前处于业务低峰期
- [ ] 有权限执行删除操作

### 安全机制

1. **自动备份**
   - 脚本会自动创建 `tp_dept_basicinfo_deleted_backup` 备份表
   - 备份所有将被删除的记录

2. **条件删除**
   - 只删除 `ACTIVED = 0` 且无任何引用的记录
   - 有子部门/人员/标签引用的记录不会被删除

3. **可回滚**
   - 提供回滚脚本
   - 可随时从备份表恢复数据

4. **二次确认**
   - 批处理脚本会要求输入 "YES" 确认
   - 避免误操作

## 📈 执行示例

### 示例输出（分析结果）

```
========================================
清理逻辑删除的部门数据
========================================

当前配置:
主机: localhost
端口: 3306
用户: root
数据库: ps-bmp

请按任意键继续. . .

========================================
步骤1: 执行数据分析
========================================
正在分析逻辑删除的部门数据...

[成功] 分析完成，结果已保存到: 分析结果.txt

分析结果摘要：
- 逻辑删除部门总数: 45
- 有子部门引用: 5
- 有人员关系: 12
- 有标签关系: 3
- 可安全删除: 25

请查看分析结果，确认是否继续执行清理操作

请按任意键继续. . .
```

### 示例输出（清理结果）

```
========================================
步骤2: 执行数据清理
========================================

[警告] 即将执行物理删除操作，此操作不可逆！
[警告] 请确认已备份数据库

确认执行清理操作？(输入 YES 继续): YES

正在执行清理操作...

[成功] 清理完成，结果已保存到: 清理结果.txt

清理结果:
- 备份记录数: 25
- 删除记录数: 25
- 剩余逻辑删除: 20

========================================
操作完成
========================================

请验证以下内容:
1. 查看清理结果.txt确认删除数量
2. 登录系统测试部门树功能
3. 测试人员管理功能
4. 确认数据一致性

备份表名: tp_dept_basicinfo_deleted_backup
如需回滚，请执行回滚脚本
```

## 🐛 故障排除

### 问题1: 提示 'mysql' 不是内部或外部命令

**原因**: MySQL bin目录不在系统PATH中

**解决**: 使用完整路径
```batch
"D:\phpstudy_pro\Extensions\MySQL5.7.26\bin\mysql.exe" -hlocalhost -P3306 -uroot -p ps-bmp < clean_deleted_departments.sql
```

或在批处理脚本中修改mysql命令路径。

### 问题2: 连接被拒绝

**原因**: 数据库连接信息错误

**解决**: 
1. 检查 DB_HOST、DB_PORT、DB_USER、DB_NAME 配置
2. 确认数据库服务正在运行
3. 确认用户名密码正确

### 问题3: 没有权限删除

**原因**: 数据库用户权限不足

**解决**: 使用有DELETE权限的用户，或联系DBA授权

### 问题4: 执行后发现数据有问题

**原因**: 误删了需要的数据

**解决**: 立即执行回滚
```bash
回滚清理.bat
```

## 📞 获取帮助

如遇到问题：

1. 查看生成的结果文件
   - `分析结果.txt`
   - `清理结果.txt`
   - `回滚结果.txt`

2. 查看详细文档
   - `清理逻辑删除部门数据说明.md`
   - `README_清理逻辑删除数据.md`

3. 联系技术支持
   - 数据库管理员
   - 系统开发团队

## 📝 执行记录模板

```
执行日期: 2025-01-27
执行人: XXX
环境: 生产/测试

数据库信息:
- 主机: localhost
- 端口: 3306
- 数据库: ps-bmp

执行前统计:
- 逻辑删除总数: ___
- 可删除数量: ___

执行结果:
- 备份记录数: ___
- 删除记录数: ___
- 剩余逻辑删除: ___

验证结果:
□ 部门树正常
□ 人员管理正常
□ 数据一致性OK

备注:
_______________
```

---

**最后更新**: 2025-01-27  
**版本**: v1.0.0

