# 参加工作时间格式优化总结

## 一、需求背景

用户导入导出功能中，参加工作时间字段需要：
1. **导入时**：支持 YYYY-MM-DD 格式，可以为空，但如果有值需严格校验
2. **导出时**：输出 YYYY-MM-DD 格式
3. **数据库存储**：继续使用 YYYYMMDD 格式（与现有数据保持一致）

## 二、修改内容

### 1. ValidationUtil.java - 校验逻辑优化

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\shared\common\utils\ValidationUtil.java`

#### 1.1 修改参加工作时间校验规则

```java
public static String validatePartWorkDate(String partWorkDate) {
    if (partWorkDate == null || partWorkDate.trim().isEmpty()) {
        // 参加工作时间非必填
        return null;
    }
    
    partWorkDate = partWorkDate.trim();
    
    // 支持 YYYY-MM-DD 格式
    if (!partWorkDate.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
        return "参加工作时间格式错误，应为YYYY-MM-DD格式,如2001-08-15";
    }
    
    // 解析年月日
    String[] parts = partWorkDate.split("-");
    int year = Integer.parseInt(parts[0]);
    int month = Integer.parseInt(parts[1]);
    int day = Integer.parseInt(parts[2]);
    
    // 校验月份范围
    if (month < 1 || month > 12) {
        return "参加工作时间的月份应在01-12之间";
    }
    
    // 校验日期范围
    if (day < 1 || day > 31) {
        return "参加工作时间的日期应在01-31之间";
    }
    
    // 校验年份合理性
    int currentYear = java.time.Year.now().getValue();
    if (year < 1900 || year > currentYear) {
        return "参加工作时间的年份应在1900-" + currentYear + "之间";
    }
    
    // 使用Java日期API验证日期是否合法（例如2001-02-30是非法的）
    try {
        java.time.LocalDate.of(year, month, day);
    } catch (Exception e) {
        return "参加工作时间的日期不合法";
    }
    
    return null;
}
```

**改进点**：
- ✅ 支持 YYYY-MM-DD 格式（原来是 YYYY.MM）
- ✅ 新增日期范围校验（1-31）
- ✅ 使用 LocalDate 严格校验日期合法性（如2月30日会被拒绝）

#### 1.2 新增日期格式转换工具方法

```java
/**
 * 将 YYYY-MM-DD 格式转换为 YYYYMMDD 格式
 * 
 * @param date YYYY-MM-DD 格式的日期
 * @return YYYYMMDD 格式，如果输入为空则返回空
 */
public static String formatDateToYYYYMMDD(String date) {
    if (date == null || date.trim().isEmpty()) {
        return "";
    }
    
    date = date.trim();
    
    // 如果已经是 YYYYMMDD 格式，直接返回
    if (date.matches("^\\d{8}$")) {
        return date;
    }
    
    // 如果是 YYYY-MM-DD 格式，转换为 YYYYMMDD
    if (date.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
        return date.replace("-", "");
    }
    
    return date; // 其他格式直接返回
}

/**
 * 将 YYYYMMDD 格式转换为 YYYY-MM-DD 格式
 * 
 * @param date YYYYMMDD 格式的日期
 * @return YYYY-MM-DD 格式，如果输入为空或格式不匹配则返回原值
 */
public static String formatDateToYYYYMMDD_Hyphen(String date) {
    if (date == null || date.trim().isEmpty()) {
        return "";
    }
    
    date = date.trim();
    
    // 如果已经是 YYYY-MM-DD 格式，直接返回
    if (date.matches("^\\d{4}-\\d{2}-\\d{2}$")) {
        return date;
    }
    
    // 如果是 YYYYMMDD 格式，转换为 YYYY-MM-DD
    if (date.matches("^\\d{8}$")) {
        return date.substring(0, 4) + "-" + date.substring(4, 6) + "-" + date.substring(6, 8);
    }
    
    return date; // 其他格式直接返回
}
```

**用途**：
- `formatDateToYYYYMMDD`: 导入时使用，将用户输入的 YYYY-MM-DD 转为数据库存储的 YYYYMMDD
- `formatDateToYYYYMMDD_Hyphen`: 导出时使用，将数据库的 YYYYMMDD 转为用户友好的 YYYY-MM-DD

### 2. UserImportExportServiceImpl.java - 导入导出逻辑修改

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\module\user\app\impl\UserImportExportServiceImpl.java`

#### 2.1 导入时转换格式（createNewUser 方法）

```java
// 2. 创建人员扩展信息
TpPersonExinfo exinfo = new TpPersonExinfo();
exinfo.setPersonId(personId);
// 将 YYYY-MM-DD 格式转换为 YYYYMMDD 格式存储
exinfo.setPartWorkDate(ValidationUtil.formatDateToYYYYMMDD(firstData.getPartWorkDate()));
// 新字段：职务职级、职称
exinfo.setZwzj(ValidationUtil.isNotEmpty(firstData.getZwzj()) ? firstData.getZwzj().trim() : null);
exinfo.setZhicheng(ValidationUtil.isNotEmpty(firstData.getZhicheng()) ? firstData.getZhicheng().trim() : null);
exinfo.setTenantId(tenantId);
```

#### 2.2 导出时转换格式（queryUsersForExport 方法）

```java
// 查询扩展信息
TpPersonExinfoVO exinfo = tpPersonExinfoMapper.view(person.getPersonId());
if (exinfo != null) {
    // 将 YYYYMMDD 格式转换为 YYYY-MM-DD 格式导出
    dto.setPartWorkDate(ValidationUtil.formatDateToYYYYMMDD_Hyphen(exinfo.getPartWorkDate()));
    
    // 新字段：职务职级、职称
    dto.setZwzj(exinfo.getZwzj());
    dto.setZhicheng(exinfo.getZhicheng());
}
```

### 3. ExcelUtil.java - 导入模板示例数据修改

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\shared\common\utils\ExcelUtil.java`

```java
// 写入示例数据
Row exampleRow = sheet.createRow(1);
String[] exampleData = {
    "zhangsan", "123456", "张三", "男", "办公室", 
    "2001-08-15",  // 修改为 YYYY-MM-DD 格式（原来是 2001.08）
    "四级调研员", "副教授", "411723196710175102"
};
```

### 4. UserImportDTO.java - 注释更新

**文件路径**: `d:\projects\ps\ps-be\src\main\java\com\jiuxi\module\user\app\dto\UserImportDTO.java`

```java
/**
 * 参加工作时间（格式：YYYY-MM-DD，可选）
 */
private String partWorkDate;
```

## 三、数据流转过程

### 导入流程

```
用户Excel输入
  ↓
[YYYY-MM-DD] (如: 2001-08-15)
  ↓
ValidationUtil.validatePartWorkDate() - 校验格式
  ↓
ValidationUtil.formatDateToYYYYMMDD() - 格式转换
  ↓
[YYYYMMDD] (如: 20010815)
  ↓
数据库 tp_person_exinfo.PART_WORK_DATE
```

### 导出流程

```
数据库 tp_person_exinfo.PART_WORK_DATE
  ↓
[YYYYMMDD] (如: 20010815)
  ↓
ValidationUtil.formatDateToYYYYMMDD_Hyphen() - 格式转换
  ↓
[YYYY-MM-DD] (如: 2001-08-15)
  ↓
用户Excel输出
```

## 四、测试要点

### 1. 导入校验测试

| 输入值 | 预期结果 |
|--------|---------|
| 空值 | 通过 |
| 2001-08-15 | 通过 |
| 2001-02-29 | 拒绝（平年2月无29日） |
| 2000-02-29 | 通过（闰年） |
| 2001-13-01 | 拒绝（月份超范围） |
| 2001-01-32 | 拒绝（日期超范围） |
| 1899-01-01 | 拒绝（年份过小） |
| 2099-01-01 | 拒绝（年份超过当前年） |
| 2001/08/15 | 拒绝（格式错误） |
| 2001.08.15 | 拒绝（格式错误） |

### 2. 导入导出往返测试

```
导入: 2001-08-15
  ↓
数据库: 20010815
  ↓
导出: 2001-08-15
```

确保往返一致性。

### 3. 兼容性测试

数据库中已有的 YYYYMMDD 格式数据应该能正常导出为 YYYY-MM-DD 格式。

## 五、注意事项

1. **数据库存储格式不变**：仍然使用 YYYYMMDD 格式，与现有数据保持一致
2. **用户交互格式统一**：导入模板、导出文件均使用 YYYY-MM-DD 格式
3. **严格的日期校验**：利用 LocalDate API 确保日期合法性（如2月30日会被拒绝）
4. **向后兼容**：格式转换方法支持双向转换，已有数据不受影响

## 六、相关文件清单

1. `ValidationUtil.java` - 校验逻辑和格式转换
2. `UserImportExportServiceImpl.java` - 导入导出业务逻辑
3. `ExcelUtil.java` - Excel文件处理
4. `UserImportDTO.java` - 导入数据传输对象

---

**修改日期**: 2025-11-28  
**修改人**: AI Assistant  
**影响范围**: 用户导入导出功能
