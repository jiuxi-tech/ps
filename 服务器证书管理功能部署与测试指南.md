# 服务器证书管理功能部署与测试指南

## 功能概述

服务器证书管理功能提供完整的SSL/TLS证书生命周期管理，包括证书上传、解析、应用、重启服务等操作。

## 核心功能

1. **证书列表管理**: 查看、筛选已上传的证书
2. **证书上传**: 支持PEM格式证书和私钥文件上传
3. **证书解析**: 自动解析证书信息（域名、发证机构、有效期等）
4. **证书应用**: 将证书文件部署到Nginx目录
5. **服务重启**: 重启Nginx服务使证书生效
6. **状态管理**: 跟踪证书使用状态和过期状态

## 部署步骤

### 1. 数据库初始化

执行SQL脚本创建证书管理表和系统配置：

```sql
-- 执行 ps-be/sql/tp_server_cert.sql
mysql -h <host> -P <port> -u <username> -p <database> < ps-be/sql/tp_server_cert.sql
```

### 2. 后端部署

确保以下文件已正确部署：

**实体类**:
- `com.jiuxi.admin.core.bean.entity.TpServerCert`
- `com.jiuxi.admin.core.bean.vo.TpServerCertVO`
- `com.jiuxi.admin.core.bean.query.TpServerCertQuery`

**数据访问层**:
- `com.jiuxi.admin.core.mapper.TpServerCertMapper`
- `mapper/sys/TpServerCertMapper.xml`

**服务层**:
- `com.jiuxi.admin.core.service.TpServerCertService`
- `com.jiuxi.admin.core.service.impl.TpServerCertServiceImpl`

**控制器层**:
- `com.jiuxi.module.sys.intf.web.controller.query.ServerCertQueryController`
- `com.jiuxi.module.sys.intf.web.controller.command.ServerCertCommandController`

### 3. 前端部署

确保以下文件已正确部署：

**页面文件**:
- `ps-fe/@fb/admin-base/views/sys/server-cert/list.vue`
- `ps-fe/@fb/admin-base/views/sys/server-cert/add.vue`
- `ps-fe/@fb/admin-base/views/sys/server-cert/view.vue`

**服务配置**:
- `ps-fe/@fb/admin-base/service/sys/serverCert/index.js`

### 4. 系统配置

在`tp_system_config`表中配置以下参数：

| 配置键 | 配置值 | 说明 |
|--------|--------|------|
| `nginx_cert_dir` | `/etc/nginx/ssl/` | Nginx证书文件存放目录 |
| `nginx_cert_name` | `server.crt` | Nginx证书文件名 |
| `nginx_cert_key` | `server.key` | Nginx私钥文件名 |
| `nginx_restart_cmd` | `systemctl restart nginx` | Nginx重启命令 |

### 5. 权限配置

确保应用有以下权限：
- 读写Nginx证书目录的权限
- 执行Nginx重启命令的权限
- 数据库读写权限

## 功能测试

### 测试准备

1. **准备测试证书**:
   - 准备有效的PEM格式证书文件
   - 准备对应的私钥文件
   - 准备过期证书用于测试过期功能

2. **环境检查**:
   ```bash
   # 检查Nginx配置目录
   ls -la /etc/nginx/ssl/
   
   # 检查Nginx状态
   systemctl status nginx
   
   # 检查数据库连接
   mysql -h <host> -P <port> -u <username> -p -e "SELECT 1"
   ```

### 基础功能测试

#### 1. 证书上传测试

**测试步骤**:
1. 访问证书管理页面
2. 点击"新增"按钮
3. 填写证书名称和描述
4. 上传PEM证书文件
5. 上传私钥文件
6. 查看证书信息预览
7. 点击"保存"

**预期结果**:
- 证书信息正确解析并显示
- 证书文件成功保存到数据库
- 列表页面显示新增的证书

#### 2. 证书应用测试

**测试步骤**:
1. 在证书列表中选择未应用的证书
2. 点击"应用"按钮
3. 确认应用操作

**预期结果**:
- 证书文件写入到Nginx目录
- 证书状态更新为"已应用"
- 使用状态更新为"使用中"
- 其他证书的使用状态更新为"未使用"

**验证方法**:
```bash
# 检查证书文件是否生成
ls -la /etc/nginx/ssl/
cat /etc/nginx/ssl/server.crt
cat /etc/nginx/ssl/server.key
```

#### 3. 服务重启测试

**测试步骤**:
1. 应用证书后点击"重启"按钮
2. 确认重启操作

**预期结果**:
- Nginx服务成功重启
- 新证书生效

**验证方法**:
```bash
# 检查Nginx状态
systemctl status nginx

# 检查证书是否生效
openssl s_client -connect localhost:443 -servername yourdomain.com
```

#### 4. 证书查看测试

**测试步骤**:
1. 点击证书名称或"查看"按钮
2. 查看证书详细信息

**预期结果**:
- 显示完整的证书信息
- 支持下载证书文件和私钥文件
- 操作按钮根据证书状态正确显示

#### 5. 证书修改测试

**测试步骤**:
1. 点击"修改"按钮
2. 修改证书信息
3. 保存修改

**预期结果**:
- 修改成功保存
- 证书信息正确更新

#### 6. 证书删除测试

**测试步骤**:
1. 选择未使用的证书
2. 点击"删除"按钮
3. 确认删除操作

**预期结果**:
- 证书成功删除
- 列表中不再显示该证书

**边界情况测试**:
- 尝试删除正在使用的证书（应该被阻止）

### 高级功能测试

#### 1. 证书过期检测

**测试步骤**:
1. 上传即将过期的证书
2. 点击"更新过期状态"按钮
3. 查看过期状态

**预期结果**:
- 过期证书状态正确标识
- 即将过期的证书有警告提示

#### 2. 证书验证测试

**测试步骤**:
1. 上传不匹配的证书和私钥
2. 查看验证结果

**预期结果**:
- 系统提示证书和私钥不匹配
- 阻止保存不匹配的证书

#### 3. 批量操作测试

**测试步骤**:
1. 创建多个测试证书
2. 进行批量删除操作

**预期结果**:
- 批量操作正确执行
- 操作结果正确反馈

### 异常情况测试

#### 1. 文件格式错误测试

**测试场景**:
- 上传非证书格式文件
- 上传损坏的证书文件
- 上传格式不正确的私钥文件

**预期结果**:
- 系统正确识别并拒绝错误格式文件
- 显示相应错误提示

#### 2. 权限错误测试

**测试场景**:
- Nginx目录无写入权限
- 无法执行Nginx重启命令

**预期结果**:
- 显示权限错误提示
- 操作被安全阻止

#### 3. 网络异常测试

**测试场景**:
- 数据库连接异常
- 网络请求超时

**预期结果**:
- 显示网络错误提示
- 用户操作能够正常恢复

## 性能测试

### 1. 大文件上传测试
- 测试上传大尺寸证书文件
- 验证上传超时处理

### 2. 并发操作测试
- 多用户同时操作证书
- 验证数据一致性

### 3. 长时间运行测试
- 长时间运行后的内存使用情况
- 定时任务的执行情况

## 安全测试

### 1. 文件上传安全
- 验证文件类型检查
- 测试恶意文件上传防护

### 2. 路径遍历测试
- 测试证书目录配置的安全性
- 验证路径注入防护

### 3. 权限控制测试
- 验证用户权限检查
- 测试越权访问防护

## 故障排除

### 常见问题

#### 1. 证书应用失败
**可能原因**:
- Nginx目录权限不足
- 证书文件格式错误
- 磁盘空间不足

**排查步骤**:
```bash
# 检查目录权限
ls -la /etc/nginx/ssl/
# 检查磁盘空间
df -h
# 检查应用日志
tail -f logs/application.log
```

#### 2. Nginx重启失败
**可能原因**:
- 重启命令权限不足
- Nginx配置错误
- 服务已停止

**排查步骤**:
```bash
# 手动测试重启命令
systemctl restart nginx
# 检查Nginx配置
nginx -t
# 查看系统日志
journalctl -u nginx
```

#### 3. 证书解析失败
**可能原因**:
- 证书文件损坏
- BASE64编码错误
- 证书格式不支持

**排查步骤**:
```bash
# 验证证书文件
openssl x509 -in certificate.pem -text -noout
# 检查文件编码
file certificate.pem
```

## 监控指标

### 关键指标
- 证书上传成功率
- 证书应用成功率
- Nginx重启成功率
- 证书过期预警及时性

### 监控方法
- 应用日志监控
- 数据库监控
- 文件系统监控
- 服务状态监控

## 维护建议

### 定期维护
1. 定期检查证书过期状态
2. 清理无效的证书记录
3. 备份重要证书文件
4. 监控磁盘空间使用

### 升级注意事项
1. 备份现有证书数据
2. 测试新版本兼容性
3. 验证配置参数
4. 逐步部署升级

本指南提供了服务器证书管理功能的完整测试和部署流程，确保功能稳定可靠运行。